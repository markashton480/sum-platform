# Subtask

**Title:** `CLI-004: Database & Auth Modules (database.py, auth.py)`

---

## Parent

**Work Order:** #WO-CLI-V2 — CLI v2 Enhanced Architecture (v2.0.0)

---

## Branch

| Branch | Target |
|--------|--------|
| `feature/cli-v2/004-db-auth` | `feature/cli-v2` |

```bash
git checkout feature/cli-v2
git pull origin feature/cli-v2
git checkout -b feature/cli-v2/004-db-auth
git push -u origin feature/cli-v2/004-db-auth
```

---

## Deliverable

This subtask will deliver:

- `cli/sum/setup/database.py` — DatabaseManager class for migration operations
- `cli/sum/setup/auth.py` — SuperuserManager class for user creation and credential storage
- `cli/tests/test_database.py` — Unit tests for database operations
- `cli/tests/test_auth.py` — Unit tests for auth operations

---

## Boundaries

### Do

- Implement `DatabaseManager` class with:
  - `migrate()` — run `manage.py migrate --noinput`
  - `check_migrations()` — run `manage.py migrate --check` to verify status
  - `get_migration_status()` — run `manage.py showmigrations --plan`
- Implement `SuperuserManager` class with:
  - `create(username, email, password)` — run `manage.py createsuperuser --noinput`
  - `_save_credentials(username, email, password)` — write to `.env.local` with proper escaping
  - `user_exists(username)` — check if specific username already exists (not just "any superuser")
- **Idempotency rule:** Check if username exists BEFORE attempting creation. If user exists, skip BOTH creation AND `.env.local` writing to avoid lying credentials file.
- Use `DjangoCommandExecutor` from #CLI-002
- Use `MigrationError` and `SuperuserError` from #CLI-001
- Generate dated header comment in `.env.local`
- Escape/quote values in `.env.local` to handle special characters

### Do NOT

- ❌ Do not implement VenvManager — owned by #CLI-003
- ❌ Do not implement ContentSeeder — owned by #CLI-006
- ❌ Do not implement SetupOrchestrator — owned by #CLI-006
- ❌ Do not modify command files

---

## Acceptance Criteria

- [ ] `DatabaseManager(executor).migrate()` runs migrations successfully
- [ ] `DatabaseManager(executor).migrate()` raises `MigrationError` on failure
- [ ] `DatabaseManager(executor).check_migrations()` returns `True` if up to date
- [ ] `SuperuserManager.user_exists(username)` correctly detects if specific user exists
- [ ] `SuperuserManager.create()` checks `user_exists()` FIRST before attempting creation
- [ ] If user already exists, `create()` skips creation AND `.env.local` writing (logs info message)
- [ ] If user doesn't exist, `create()` creates user and writes `.env.local`
- [ ] `DJANGO_SUPERUSER_PASSWORD` env var is passed to subprocess
- [ ] `.env.local` values are properly escaped/quoted for special characters
- [ ] `.env.local` format matches spec:
  ```bash
  # .env.local
  # Auto-generated by sum init on 2025-12-18
  # DO NOT COMMIT THIS FILE
  DJANGO_SUPERUSER_USERNAME="admin"
  DJANGO_SUPERUSER_EMAIL="admin@example.com"
  DJANGO_SUPERUSER_PASSWORD="admin"
  ```
- [ ] Unit tests mock DjangoCommandExecutor
- [ ] `make lint && make test` passes

---

## Test Commands

```bash
make lint
make test

# Specific tests
python -m pytest tests/test_database.py -v
python -m pytest tests/test_auth.py -v
```

---

## Files Expected to Change

```
cli/sum/setup/__init__.py          # Modified: add exports
cli/sum/setup/database.py          # New
cli/sum/setup/auth.py              # New
cli/tests/test_database.py         # New
cli/tests/test_auth.py             # New
```

---

## Dependencies

**Depends On:**
- [ ] #CLI-001 must be merged first (provides exceptions)
- [ ] #CLI-002 must be merged first (provides DjangoCommandExecutor)

**Blocks:**
- #CLI-006 Seeding & Orchestrator is waiting for this

---

## Risk

**Level:** Low

**Why:**
- Thin wrapper around Django management commands
- Standard subprocess pattern established in #CLI-002
- Credential storage is simple file write
- No complex logic or state management

---

## Labels

- [ ] `type:task`
- [ ] `agent:*`
- [ ] `component:cli`
- [ ] `risk:low`
- [ ] Milestone: `v2.0.0`

---

## Project Fields

- [ ] Agent: (assigned)
- [ ] Model Planned: (selected)
- [ ] Component: cli
- [ ] Change Type: feat
- [ ] Risk: low
- [ ] Release: `v2.0.0`

---

## Definition of Done

- [ ] Acceptance criteria met
- [ ] `make lint && make test` passes
- [ ] PR merged to feature branch
- [ ] **Model Used** field set
- [ ] `model:*` label applied
- [ ] Parent Work Order updated

---

## Commit Message

```
feat(cli): add database and auth management modules

- Add DatabaseManager for running migrations and checking status
- Add SuperuserManager for creating superuser and storing credentials
- Generate .env.local with dated header and credentials
- Add comprehensive unit tests with mocked Django executor

Closes #CLI-004
```

---

## Implementation Notes

### DatabaseManager

```python
from dataclasses import dataclass

from sum.exceptions import MigrationError
from sum.utils.django import DjangoCommandExecutor

@dataclass
class MigrationResult:
    success: bool
    output: str

class DatabaseManager:
    """Manages database operations."""
    
    def __init__(self, django_executor: DjangoCommandExecutor):
        self.django = django_executor
    
    def migrate(self) -> MigrationResult:
        """Run database migrations."""
        result = self.django.run_command(["migrate", "--noinput"], check=False)
        
        if result.returncode != 0:
            raise MigrationError(f"Migration failed: {result.stderr}")
        
        return MigrationResult(success=True, output=result.stdout)
    
    def check_migrations(self) -> bool:
        """Check if migrations are up to date."""
        result = self.django.run_command(["migrate", "--check"], check=False)
        return result.returncode == 0
    
    def get_migration_status(self) -> str:
        """Get detailed migration status."""
        result = self.django.run_command(["showmigrations", "--plan"], check=False)
        return result.stdout
```

### SuperuserManager

```python
import logging
from dataclasses import dataclass
from datetime import datetime
from pathlib import Path

from sum.exceptions import SuperuserError
from sum.utils.django import DjangoCommandExecutor

logger = logging.getLogger(__name__)


@dataclass
class SuperuserResult:
    success: bool
    username: str
    credentials_path: Path
    created: bool  # True if newly created, False if already existed


def _escape_env_value(value: str) -> str:
    """Escape value for .env file (wrap in quotes if needed)."""
    # Always quote to handle spaces, #, etc.
    escaped = value.replace('\\', '\\\\').replace('"', '\\"')
    return f'"{escaped}"'


class SuperuserManager:
    """Manages Django superuser creation."""
    
    def __init__(self, django_executor: DjangoCommandExecutor, project_path: Path):
        self.django = django_executor
        self.project_path = project_path
    
    def user_exists(self, username: str) -> bool:
        """Check if a specific username already exists."""
        result = self.django.run_command(
            ["shell", "-c", 
             f"from django.contrib.auth import get_user_model; "
             f"print(get_user_model().objects.filter(username='{username}').exists())"],
            check=False
        )
        return result.stdout.strip().lower() == "true"
    
    def create(
        self,
        username: str = "admin",
        email: str = "admin@example.com",
        password: str = "admin"
    ) -> SuperuserResult:
        """Create superuser and store credentials.
        
        Idempotency: If user already exists, skips both creation and .env.local
        writing to avoid creating a credentials file that doesn't match reality.
        """
        # Check FIRST - don't attempt creation if user exists
        if self.user_exists(username):
            logger.info(f"User '{username}' already exists, skipping creation")
            return SuperuserResult(
                success=True,
                username=username,
                credentials_path=self.project_path / ".env.local",
                created=False
            )
        
        # User doesn't exist - create it
        result = self.django.run_command(
            [
                "createsuperuser",
                "--noinput",
                "--username", username,
                "--email", email,
            ],
            env={"DJANGO_SUPERUSER_PASSWORD": password},
            check=False
        )
        
        if result.returncode != 0:
            raise SuperuserError(f"Creation failed: {result.stderr}")
        
        # Only write .env.local if we actually created the user
        self._save_credentials(username, email, password)
        
        return SuperuserResult(
            success=True,
            username=username,
            credentials_path=self.project_path / ".env.local",
            created=True
        )
    
    def _save_credentials(self, username: str, email: str, password: str) -> None:
        """Save credentials to .env.local with proper escaping."""
        env_local = self.project_path / ".env.local"
        date_str = datetime.now().strftime('%Y-%m-%d')
        
        content = f"""# .env.local
# Auto-generated by sum init on {date_str}
# DO NOT COMMIT THIS FILE
DJANGO_SUPERUSER_USERNAME={_escape_env_value(username)}
DJANGO_SUPERUSER_EMAIL={_escape_env_value(email)}
DJANGO_SUPERUSER_PASSWORD={_escape_env_value(password)}
"""
        env_local.write_text(content)
```
