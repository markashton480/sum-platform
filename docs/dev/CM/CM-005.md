# **[CM-005]: Repo Niggles Sweep (DX, Determinism, Noise Reduction)**

## **Objective**

Clean up the small-but-recurring “niggles” accumulated across Milestones 0–4 so the repo is **deterministic, reproducible, and quiet** before final code review + docs freeze.

This CM is explicitly about:

- eliminating drift (deps/tools)
- reducing warnings/noise
- tightening enforcement so humans don’t have to remember rules

Not about adding features.

---

## **Context**

Across M4 and the CORE audits we saw recurring minor issues:

- ad-hoc dependency installs (e.g. `types-requests`)
- occasional format/lint drift requiring manual `isort` runs
- noisy warnings (e.g. duplicate template tag module warning)
- repeated “caplog + propagate” boilerplate in correlation tests
- “works in harness” risk has been addressed, but we now want a tidy baseline before final review

This CM turns those small papercuts into a clean, auditable baseline.

---

## **Work Items**

### A) Dependency drift audit (P0)

1. Search recent commits/transcripts for ad-hoc installs (notably `types-requests`).
2. Confirm all required dev/test deps are declared in the canonical dependency file (pyproject / requirements, whichever this repo uses).
3. Remove any unused deps that were installed “just to make mypy shut up” if they’re no longer needed.

**Acceptance**

- A clean `pip sync`/`uv sync`/`pip install -e .[dev]` setup (whatever your repo uses) results in:

  - `make test`
  - `make lint`
    passing without manual installs.

---

### B) Lint/format enforcement consistency (P0)

1. Ensure `make lint` genuinely enforces:

- ruff (lint)
- ruff-format (or black equivalent)
- isort (or ruff import sorting) in **check mode**

2. Ensure `pre-commit` uses the same tools/modes so commit-time behaviour matches CI-time behaviour.

**Acceptance**

- If an import sort change is needed, `make lint` fails (not passes) until it’s fixed.
- Running `make format` fixes it and `make lint` then passes.

---

### C) Reduce warnings/noise: duplicate template tag module warning (P1)

The CORE report mentioned a “duplicate template tag module” warning.

**Task**

- Identify the module(s) causing the duplicate registration.
- Fix by consolidating / renaming / removing duplicate modules so Wagtail/Django no longer warns at startup.

**Acceptance**

- No duplicate template tag warning on runserver or test startup.

---

### D) Test ergonomics: logging propagation helper (P1)

CM-004 solved correlation tests by toggling `propagate` on the parent and child loggers.

**Task**

- Add a small pytest helper/fixture in `conftest.py` (or a test utility module) to:

  - enable propagation for a named logger + its parents temporarily
  - restore previous state after test

Update the correlation tests to use it.

**Acceptance**

- Correlation tests remain as strict as they are now, but become simpler/cleaner.
- No behaviour change in production logging config.

---

### E) “Hygiene check” script / doc snippet (P2)

Add a tiny `docs/dev/hygiene.md` (or a section in README) that defines the canonical “before PR” commands:

- `make format`
- `make lint`
- `make test`

And notes “no ad-hoc pip installs; update deps instead”.

**Acceptance**

- Single source for “how to verify locally” that matches CI.

---

## **Implementation Guidelines**

- Keep changes small and isolated.
- No behavioural changes unless explicitly required to eliminate warnings.
- If a niggle is “bigger than niggle”, log it as a follow-up for M5+ instead of expanding CM-005.
- When complete, file a full, comprehensive work report in docs/dev/CM/CM-005_followup.md.

---

## **Acceptance Criteria**

- [ ] No ad-hoc dependency installs required to run lint/tests
- [ ] `make lint` enforces import ordering/formatting consistently
- [ ] Duplicate template tag module warning eliminated
- [ ] Correlation test propagation boilerplate replaced by a fixture/helper
- [ ] `make test` passes
- [ ] `make lint` passes

---

## **Testing Requirements**

- Existing suite must remain green.
- Add unit tests only if needed for the propagation helper; otherwise rely on existing correlation tests.

---

## **Estimated Complexity**

- **Time:** S–M
- **Risk:** Low
- **Value:** High (prevents slow DX erosion and “mysterious” CI drift)

---
