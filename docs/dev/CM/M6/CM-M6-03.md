# [CM-M6-03]: Align Theme System Implementation with THEME-ARCHITECTURE-SPECv1

## Objective

Modify the M6-002 theme system implementation so that it **fully conforms to THEME-ARCHITECTURE-SPECv1**, specifically the **copy-into-client (`theme/active/`) theme model** defined in the spec.

This CM corrects implementation drift. It does **not** introduce new features or redesign the theme system.

---

## Context

### Spec Authority

Per **THEME-ARCHITECTURE-SPECv1**:

- Themes are **distributed from `sum_core`**
- At `sum init`, the selected theme is **copied into the client project**
- The client project owns the active theme at:

  ```
  theme/
    active/
      theme.json
      templates/
      static/
      tailwind/
  ```

- Django must resolve templates and static assets from `theme/active/` **before** falling back to `sum_core`

#### Drift Introduced in M6-002

M6-002 implemented a **pointer-based model** (themes loaded directly from `sum_core` via `.sum/theme.json`), which **violates the spec contract**.

This CM exists to correct that mismatch.

---

### **Technical Requirements**

#### Theme Initialisation (`sum init`)

- On `sum init --theme <slug>`:

  - Copy the selected theme directory from `sum_core/themes/<slug>/` into:

    ```
    <client_root>/theme/active/
    ```

  - Preserve full structure:

    - `theme.json`
    - `templates/`
    - `static/`
    - `tailwind/` (if present)

- `.sum/theme.json` must record:

  - original theme slug
  - original theme version
  - init timestamp
    (provenance only — **not used for runtime loading**)

#### Django Template Resolution

Update client project settings so resolution order is:

1. `theme/active/templates/`
2. `templates/overrides/`
3. `sum_core` templates (fallback)

#### Static Assets

- Configure staticfiles to include:

  - `theme/active/static/` ahead of platform defaults

- No static assets should be served directly from `sum_core` for the active theme.

#### Immutability Rules

- Theme selection remains **init-time only**
- No CLI support for switching themes post-init
- Manual migration required for theme changes (unchanged from M6-002 intent)

---

### **Implementation Guidelines**

- **Do not redesign** the theme system
- **Do not change** the theme manifest format
- **Do not touch** Theme A visuals or structure beyond relocation
- Prefer reuse of existing M6-002 logic where possible
- Changes should be limited to:

  - CLI init flow
  - Boilerplate project settings
  - Theme path resolution helpers

---

### **Acceptance Criteria**

- [x] `sum init --theme <slug>` copies theme into `theme/active/`
- [x] Client project runs without referencing theme templates in `sum_core`
- [x] Template resolution prioritises `theme/active/`
- [x] Static assets are served from client-owned theme directory
- [x] `.sum/theme.json` records provenance only
- [x] No regressions to M5 or other M6-002 functionality
- [x] Existing tests pass; new tests added only where required

---

### **Testing Requirements** (from `test-strategy-v1.1.md`)

#### Unit / Integration

- Theme copy logic during init
- Failure on missing/invalid theme slug
- Correct template resolution order

#### Manual Verification

- Init new project
- Inspect `theme/active/` contents
- Run dev server
- Confirm theme templates render correctly
- Confirm deleting `sum_core/themes/theme_a` does **not** break the client site

---

### **Estimated Complexity**

- **Time**: S
- **Risk**: Low
- **Suggested Model**: GPT-5.2 or Claude Sonnet

---

### **Lead Note**

This CM restores **spec authority**.

Once complete:

- Theme ownership is unambiguous
- Upgrade behavior is predictable
- M6-003 (Theme A – Sage & Stone) can proceed without hidden coupling to platform internals

---
