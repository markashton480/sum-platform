# [CM-M6-04]: Remove Harness Hacks and Enforce Theme Override via Real Contract

## Objective

Remove all **illegal harness-level shortcuts** introduced during M6-003 and ensure **Theme A renders exclusively via the real theme override mechanism**, as defined by the SUM theme contract.

After this CM:

- Theme A must render correctly **without modifying `test_project` models or settings**
- All rendering must flow through:

  ```
  sum init --theme theme_a
  → theme/active/
  → Django template override resolution
  ```

---

## **Context**

### What went wrong (known, explicit)

During M6-003, the agent:

- Modified `test_project` settings to inject Theme A template/static paths
- Modified `HomePage.template` in the harness model to force Theme A templates

This violates **three locked rules**:

1. `test_project` is **harness-only**, never a privileged consumer
2. Themes must render via **template override**, not model hacks
3. Validation must exercise the **same path real clients use**

This CM exists to undo those violations and restore trust in the system.

---

## **Authoritative Contract (DO NOT DEVIATE)**

- Theme templates must override core templates by **path shadowing**
- If a model specifies:

  ```python
  template = "sum_core/standard_page.html"
  ```

  then Theme A must provide:

  ```
  theme_a/templates/sum_core/standard_page.html
  ```

No model changes.
No settings hacks.
No special-casing the harness.

---

## **Technical Requirements**

### 1. Remove all harness hacks

Revert and delete:

- Any modifications to:

  - `core/sum_core/test_project/**/settings.py`
  - `core/sum_core/test_project/**/models.py`

- Specifically:

  - No template overrides in model definitions
  - No injected template/static dirs in settings

`test_project` must return to being a **neutral harness**.

---

### 2. Implement proper theme template overrides

Within **Theme A**, add templates at **core override paths**:

```
core/sum_core/themes/theme_a/templates/sum_core/
├── base.html
├── home_page.html
├── standard_page.html
├── service_index_page.html
├── service_page.html
└── includes/
    ├── header.html
    ├── footer.html
    └── sticky_cta.html
```

These files must:

- Match the Sage & Stone compiled HTML structure
- Contain all required DOM hooks (`main-header`, mega menu IDs, etc.)
- Be renderable **without any model or settings changes**

---

### 3. Fix tests to validate the real contract

Tests must:

- Stop relying on harness modifications
- Validate that:

  - Core pages render using Theme A templates via override
  - Required DOM hooks exist in rendered output

Acceptable strategies:

- Direct Django template rendering with `theme/active` as root
- Minimal client-init integration test (`sum init --theme theme_a`)

**Forbidden**:

- Changing model `template = ...`
- Changing harness settings to “help” the theme

---

### 4. Keep scope tight

This CM must **not**:

- Change the theme system
- Change page models
- Introduce new blocks or CMS fields
- Add new theme features

This is **purely corrective**.

---

## **Acceptance Criteria**

- [ ] `test_project` models and settings contain **no theme-specific logic**
- [ ] Theme A overrides core templates via `templates/sum_core/...`
- [ ] HomePage and StandardPage render Theme A correctly without hacks
- [ ] Required DOM hooks for JS behaviour exist in rendered output
- [ ] All tests pass
- [ ] `make lint` passes
- [ ] No regressions to M5 or M6-002 / CM-M6-03 behaviour

---

## **Testing Requirements** (from `test-strategy-v1.1.md`)

### Automated

- Rendering tests asserting:

  - correct template resolution
  - presence of header / mega-menu hooks

- No harness-specific configuration

### Manual (spot-check)

- Init a fresh client with `sum init --theme theme_a`
- Run dev server
- Confirm:

  - Theme A header renders
  - StandardPage uses themed markup, not core markup

---

## **Estimated Complexity**

- **Time**: S–M
- **Risk**: Low
- **Suggested Model**: **Claude Sonnet** or **GPT-5.2**

---
