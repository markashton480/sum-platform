# **[CM-004]: Fix Task Correlation ID Propagation Failures**

## **Objective**

Resolve the **3 failing correlation-id tests** in `tests/leads/test_task_correlation.py` by ensuring request correlation IDs (`request_id`) are correctly **propagated into task execution** and included in task telemetry (logs / headers), without deleting, skipping, or weakening tests.

This removes the last known “pre-existing” red tests before milestone close-out.

---

## **Context**

The full platform CORE audit found that SUM Core is now genuinely consumable, but `make test` still reports **3 failures**:

- `test_send_lead_notification_logs_request_id`
- `test_send_lead_webhook_includes_request_id`
- `test_send_zapier_webhook_includes_request_id`

These failures relate directly to Milestone 4’s observability baseline and are specifically about **request_id continuity** from request → enqueue → task execution.

---

## **Technical Requirements**

### 1) Define the platform rule

When a request triggers async delivery (email/webhook/zapier):

- The originating `request_id` must be passed into the task.
- The task must include that `request_id` in:

  - structured logs, and
  - outbound webhook headers (where applicable), and/or payload metadata (if already established).

### 2) Fix the wiring in one place (preferred)

Pick **one** canonical mechanism for propagation and use it consistently:

**Option A (preferred): Explicit kwargs**

- `task.delay(lead_id=..., request_id=request_id, ...)`
- Task signature includes `request_id: str | None = None`

**Option B: Celery headers**

- Use Celery’s request headers / custom headers
- More complex; only do if you already established this pattern

Don’t implement both unless you have a clear reason.

### 3) Behaviours by task

- **Lead notification email task**

  - logs include `request_id` when provided

- **Lead webhook task**

  - logs include `request_id`
  - outbound request includes `X-Request-ID: <request_id>` header (recommended)

- **Zapier webhook task**

  - logs include `request_id`
  - outbound request includes `X-Request-ID: <request_id>` header (recommended)

### 4) Defaults

- If no `request_id` exists (non-request-triggered task run):

  - tasks still run normally
  - logs omit or set request_id to `null`

- No test should require “real” Celery/broker access.

---

## **Implementation Guidelines**

### Files likely involved

- `tests/leads/test_task_correlation.py` (failing tests)
- `core/sum_core/leads/tasks.py` (email/webhook/zapier tasks)
- Wherever tasks are enqueued from request context (forms submit handler / post-save hook)
- Upon completion please provide a full, comprehensive work report filed under `docs/dev/CM-004_followup.md`

### Guardrails

- ❌ Do not delete, skip, xfail, or “loosen” the failing tests.
- ❌ Do not log PII (no emails/phones/messages).
- ✅ Reuse existing structured logging / Sentry scoping patterns from M4-009.
- ✅ Maintain idempotency locking pattern (select_for_update + atomic) if touched.

---

## **Acceptance Criteria**

- [ ] `tests/leads/test_task_correlation.py` passes fully
- [ ] `make test` passes (no remaining “pre-existing” failures)
- [ ] `make lint` passes
- [ ] request_id is propagated and included as required in:

  - email task logs
  - lead webhook request headers/logs
  - zapier webhook request headers/logs

- [ ] No changes degrade reliability/idempotency behaviour

---

## **Testing Requirements**

- Existing tests in `tests/leads/test_task_correlation.py` are the primary gate.
- Add only minimal additional tests if necessary (e.g. ensure header presence), but prefer to satisfy current suite.

---

## **Estimated Complexity**

- **Time:** S
- **Risk:** Medium (easy to “make green” incorrectly—must be the real fix)
- **Value:** High (unblocks milestone close-out and strengthens observability guarantees)

---

### Quick note

The Wiring Inventory already states correlation middleware and observability are part of “Ops/Observability” consumption. This CM ensures the async side actually honors that promise.
