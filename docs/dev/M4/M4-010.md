## **[M4-010]: Email Delivery Configuration + HTML Email Templates**

**Objective**: Implement reliable email delivery configuration for lead notifications (env-driven SMTP/provider support) and upgrade notifications to send **HTML + plain-text fallback** emails, with robust failure logging.

**Context** (from SSOT - PRD Section)

- Business requirement excerpt: “Email delivery configuration” is a Milestone 4 deliverable.
- Relevant user story: **US-I03: Email Delivery** — reliable notifications with env-based SMTP/provider support + HTML templates with text fallback.
- Reference: PRD **US-I03 (Email Delivery)**; SSOT **Milestone 4 Deliverables / Done When**.

**Technical Requirements** (from SSOT / PRD)

- Configure email backend using **environment variables** (P0).
- Support “SendGrid, Mailgun, or generic SMTP” (P0). (We’ll implement this as generic SMTP env config, plus provider-friendly defaults; no provider SDK required unless already planned.)
- Update lead notification sending to use **HTML email + text fallback** (P0).
- Ensure failures are **logged with error details** and do **not** break the “no lost leads” invariant.

**Design Specifications**

- Not user-facing UI work; email templates should be clean, readable, and consistent with existing notification content.
- If branding is desired in HTML emails, keep it minimal (logo + simple typographic styling) and avoid heavy CSS.

**Implementation Guidelines**

- **Files to create/modify** (expected)

  - `core/sum_core/test_project/test_project/settings.py` (or central settings module): add env-driven email settings.
  - Lead email sending code (where notification emails are sent today) to use `EmailMultiAlternatives` with:

    - subject (existing)
    - text body (existing `.txt`)
    - HTML alternative (`.html`)

  - Add new HTML templates:

    - `.../templates/.../lead_notification_body.html` (and keep `.txt`)

- Required header comments on any new Python modules:

```python
"""
Name: [Module Name]
Path: [File path]
Purpose: [Brief description]
Family: [What depends on this]
Dependencies: [What this depends on]
"""
```

- Python: type hints where feasible; follow existing patterns.

**Acceptance Criteria**

- **AC1**: SMTP configuration is driven via env vars (e.g. host, port, username, password, TLS/SSL, from address).
- **AC2**: Works with “provider SMTP” setups (SendGrid/Mailgun) without code changes (just env).
- **AC3**: Lead notification sends as **multipart**: text + HTML.
- **AC4**: On SMTP failure, the Lead record/state handling remains correct (no lost leads), and error details are logged.
- **AC5**: Tests cover success + failure modes; `make test` and `make lint` pass.

**Dependencies & Prerequisites**

- Assumes lead notification flow already exists from Milestone 3 and status tracking is in place (it is).
- Env loader approach should match current project conventions (don’t introduce a new config library unless already present).

**Testing Requirements** (from test-strategy-v1.1.md)

- Add/extend integration tests to cover failure modes (SMTP down/misconfigured) and verify the system still records leads and logs correctly.
- Ensure coverage ≥ 80% and CI-ready.
- Suggested tests:

  - Unit: build email message includes HTML alternative when template exists.
  - Integration: mock Django email backend to assert `EmailMultiAlternatives` called with both parts.
  - Failure-mode: force backend exception and assert status/logging behaviour remains correct.

**Manual Testing Checklist**

- Set env vars locally (or `.env`) for a test SMTP account.
- Submit a form; confirm:

  - lead created
  - notification email received with HTML rendering
  - plaintext fallback present (view “original” / multipart)

- Break SMTP credentials; submit again; confirm:

  - lead still created
  - email status reflects failure + logs show error details

**Estimated Complexity**

- Time: **M**
- Risk: **Medium** (email config drift + template correctness)
