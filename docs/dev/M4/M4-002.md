## **[M4-002]: Event tracking JavaScript (dataLayer events)**

**Objective**: Add a shared JavaScript module that pushes key conversion events into `window.dataLayer` so GA4/GTM can record conversions (form submits, CTA clicks, phone/email clicks).

### Tracking selector strategy (paste into M4-002)

**Goal**: Track the _right_ interactions (user-intent conversion actions) without polluting analytics with UI chrome, admin elements, or random buttons.

**Principles**

- Prefer **explicit opt-in** via `data-track="cta"` over class-based detection.
- Use **event delegation** from `document` so dynamic content and future blocks “just work”.
- Never track in Wagtail admin (belt + braces): ignore events when `document.body.classList.contains("wagtail")` or URL path starts with `/admin/`.

**Selector tiers (highest priority first)**

1. **Explicit CTA** (recommended default)

   - Track clicks on:

     - `[data-track="cta"]`

   - Read payload from attributes (best accuracy):

     - `data-cta-text` (fallback: element text)
     - `data-destination` (fallback: `href`)
     - `data-cta-kind` (optional: “primary”, “secondary”, “nav”, “footer”, etc.)

2. **Safe implicit CTA fallback** (only when explicit not present)

   - Track clicks on:

     - `a.btn`, `button.btn`

   - But **exclude** anything within:

     - `[data-track-scope="ignore"]` containers (cookie banners, modal chrome, header utilities, etc.)
     - `header` and `footer` _unless_ explicitly opted-in (these areas create a lot of noise)

3. **Never track list** (hard exclusions)

   - Ignore click if the target is:

     - inside `nav`, `.cookie-banner`, `[aria-label*="cookie" i]`, `.modal`, `[role="dialog"]`
     - or matches: `a[href^="#"]`, `button[type="button"][aria-expanded]` (accordion toggles), `button[disabled]`

**Form tracking strategy**

- Only track forms with:

  - `[data-form-type]` (explicit opt-in)

- Do **not** track every form submit globally, otherwise you’ll catch newsletter embeds, search boxes, and admin forms.
- `form_type` values should be a controlled set:

  - `contact`, `quote_request`, `newsletter`, etc. (keep them stable for reporting)

**Phone/Email tracking**

- Track:

  - `a[href^="tel:"]` and `a[href^="mailto:"]`

- Exclude if inside ignored scopes (`[data-track-scope="ignore"]`) to avoid tracking utility links in headers/footers unless you actually want them.

**Implementation detail**

- Add a tiny helper:

  - `isTrackableTarget(el)` that:

    - climbs up the DOM (`closest`) checking ignore scopes first
    - then checks for explicit tracking attributes

- This keeps the event handler readable and prevents “if soup”.

**Recommended markup conventions**

- In templates, add:

  - `data-track="cta"` on genuine conversion CTAs (hero button, “Get a quote”, “Book a call”)
  - wrap UI-only areas with `data-track-scope="ignore"` (cookie banner, modal close controls, nav dropdown toggles)

---

### Context (from SSOT - PRD Section)

- Business requirement excerpt: “Events fire on form submit, CTA click, phone/email click”
- Events to push to dataLayer:

  - `form_submission` (form_type, page_url)
  - `phone_click` (phone number)
  - `email_click` (email address)
  - `cta_click` (button text, destination)

- Reference: **SSOT §10.2 Event Tracking**

Relevant user story + ACs:

- **US-A02: Event Tracking** (AC1–AC5)

---

### Technical Requirements (from SSOT - Tech Spec Section)

**Core behaviour**

- Implement `window.dataLayer = window.dataLayer || []` and push structured objects like:

  - `{ event: "form_submission", form_type, page_url }`
  - `{ event: "phone_click", phone_number }`
  - `{ event: "email_click", email_address }`
  - `{ event: "cta_click", button_text, destination }`

- Must work whether GTM or GA4 is configured (dataLayer can exist regardless; pushes should be safe even if no analytics scripts are injected).
- Must not throw if elements are missing or attributes are unexpected.

**Target elements (pragmatic + robust)**

- **Forms**: attach listener to `submit` events for forms that represent your StreamField forms.

  - Determine `form_type` via a `data-form-type` attribute (preferred) or fallback heuristics (form id/name).

- **Phone / Email**: listen for clicks on `a[href^="tel:"]` and `a[href^="mailto:"]`
- **CTA clicks**: track clicks for:

  - links/buttons with `.btn` class OR
  - elements with `data-track="cta"` (preferred for precision)
  - destination from `href` (if present) or `data-destination`

**Loading**

- Load the JS globally via base template (defer), so it’s present on all pages. (This aligns with “shared JavaScript module” AC5.)

---

### Design Specifications (from SSOT - Design Section)

- No styling changes.
- No inline JS in templates beyond a single `<script src="...">` include.

---

### Implementation Guidelines

**Files to create/modify (expected)**

- Create:

  - `core/sum_core/static/sum_core/js/event_tracking.js`

- Modify:

  - `core/sum_core/templates/sum_core/base.html` to include the script (likely near the end of `<body>` with `defer`)
  - (Optional but recommended) Form block templates to add `data-form-type="contact"` / `data-form-type="quote_request"` on the `<form>` element for clean, stable tracking.

**Required header comments**
Add to the new JS file (top comment) describing purpose and dependencies.

**JS guidelines**

- Vanilla JS only (no dependency).
- Use event delegation on `document` for click tracking (reduces listeners, survives partial renders).
- Ensure pushing to dataLayer never breaks the page:

  - wrap `dataLayer.push(...)` in a small helper that catches errors.

---

### Acceptance Criteria

1. Submitting **contact form** pushes `form_submission` with `form_type="contact"` and current `page_url`.
2. Submitting **quote request form** pushes `form_submission` with `form_type="quote_request"` and current `page_url`.
3. Clicking a `tel:` link pushes `phone_click` with the phone number extracted from the link.
4. Clicking a `mailto:` link pushes `email_click` with the email extracted from the link.
5. Clicking a CTA pushes `cta_click` with `button_text` and `destination`.
6. If `window.dataLayer` doesn’t exist, it is created; if analytics scripts aren’t configured, events still push without errors.

---

### Dependencies & Prerequisites

- M4-001 completed (analytics injection exists, but not strictly required for safe dataLayer pushes).

---

### Testing Requirements (from test-strategy-v1.1.md)

Because this is frontend JS in a Django repo (and we’re not standing up Playwright yet), keep it practical:

**Integration tests (server-rendered HTML assertions)**

- Verify the script tag is present in rendered pages (base template includes it).
- Verify form HTML includes the `data-form-type` attributes (if you add them).

**Lightweight JS unit tests (optional, only if you already have a JS test runner)**

- If no JS runner exists, don’t add toolchain complexity in this milestone—lean on manual verification + HTML assertions, and we’ll add Playwright in Milestone 5 or later.

**Manual verification checklist (required for this ticket)**

- In browser devtools console:

  - `window.dataLayer` exists
  - clicking tel/mailto/cta causes `dataLayer` length to increment and includes the expected object
  - submitting each form pushes the correct event payload

(These align with the test strategy’s emphasis on integration checks for analytics/SEO plus pragmatic test levels.)

---

### Estimated Complexity

- **Time:** S
- **Risk:** Low/Medium (mostly about correctly identifying CTAs/forms without false positives)

---
