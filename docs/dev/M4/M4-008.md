# **[M4-008]: Health Endpoint for Monitoring and Ops**

**Objective**: Implement a `/health/` endpoint that returns **machine-readable JSON** including service/version metadata and a small set of runtime checks, and add tests verifying the endpoint is stable and informative for uptime monitoring. This is a Milestone 4 ops/reliability requirement per the testing strategy.

---

## **Context** (from SSOT / Test Strategy / PRD intent)

- The test strategy explicitly requires a **health endpoint** that returns JSON including **version** and **check statuses** for ops/monitoring.
- We’ve now got async tasks + integrations (email/webhook/Zapier). A lightweight health check makes “is the platform alive?” observable without logging into admin.

---

## **Technical Requirements**

### 1) Endpoint

- Add a GET endpoint at: **`/health/`**
- Response:

  - **HTTP 200** when all required checks are healthy
  - **HTTP 503** if any required check fails

- Content-Type: `application/json`

### 2) Response schema (minimum)

Return JSON in this shape:

```json
{
  "status": "ok|degraded",
  "version": {
    "git_sha": "…",
    "build": "…"
  },
  "checks": {
    "db": { "status": "ok|fail", "latency_ms": 3 },
    "cache": { "status": "ok|fail" },
    "celery": { "status": "ok|fail" }
  },
  "timestamp": "2025-12-15T09:30:00Z"
}
```

**Rules**

- `status="ok"` iff all required checks are ok.
- `status="degraded"` if any required check fails.
- Include a human-friendly `detail` string on failures (short; safe for logs).

### 3) Checks (what to implement)

**Required**

- **DB check**: run a trivial query (e.g., `SELECT 1`) and capture latency.
- **Cache check**: set/get/delete a test key against the configured cache backend.

**Celery check (choose one approach)**

- If you have a broker/backend configured, do a lightweight check that the app can connect (or that the broker URL is present + a ping-style call if available).
- If celery is optional in local dev, treat it as:

  - required in production-like settings, optional in dev/test (via a settings flag), **or**
  - always included but can be `fail` without failing the overall endpoint if explicitly configured as non-required.

(Keep this deterministic and testable; no “random” broker calls that flake.)

### 4) Security

- This endpoint must not leak secrets.
- It can be public (typical for uptime monitoring), but keep output minimal.
- No stack traces in JSON.

---

## **Design Specifications**

- None (JSON only).

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Create:

  - `core/sum_core/ops/health.py` (health check logic)
  - `core/sum_core/ops/views.py` (Django view returning JSON)
  - `core/sum_core/ops/urls.py` (route for `/health/`)

- Modify:

  - project/root urls to include ops urls.

### Required header comment

```python
"""
Name: health
Path: core/sum_core/ops/health.py
Purpose: Runtime health checks for monitoring (/health/).
Family: Ops/Monitoring (Milestone 4)
Dependencies: Django DB connection, cache backend, optional Celery app config
"""
```

### Patterns

- Keep check functions pure and small:

  - `check_db() -> CheckResult`
  - `check_cache() -> CheckResult`
  - `check_celery() -> CheckResult`

- Single orchestrator builds response dict and decides HTTP status.

---

## **Acceptance Criteria**

- [ ] GET `/health/` returns JSON with `status`, `version`, `checks`, `timestamp`.
- [ ] When DB/cache are healthy, endpoint returns HTTP 200 and `checks.db.status="ok"`, `checks.cache.status="ok"`.
- [ ] When a required check fails, endpoint returns HTTP 503 and `status="degraded"`.
- [ ] No secrets or stack traces are returned.
- [ ] Output format is stable (monitoring tooling won’t break).

---

## **Dependencies & Prerequisites**

- None beyond current Django project wiring.
- If you want version info:

  - Prefer env vars like `GIT_SHA` / `BUILD_ID` (CI can inject).

---

## **Testing Requirements** (from test-strategy-v1.1.md)

Health endpoint is explicitly called out as part of reliability/ops verification.

### Unit tests

- `check_db` returns ok in normal test DB.
- `check_cache` returns ok with configured cache.
- Orchestrator returns 503 if a required check is forced to fail (monkeypatch).

### Integration tests

- GET `/health/` returns 200 and expected JSON keys.

(Keep it robust—avoid tests that depend on external services unless explicitly mocked.)

---

## **Estimated Complexity**

- **Time:** S–M
- **Risk:** Low–Medium (only tricky part is celery “ping” without flakes)
