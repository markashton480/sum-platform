# **[M4-004B]: Recreate & Finalise SEO Template Tag Test Coverage**

## **Objective**

Ensure **complete, explicit, and stable test coverage** for SEO template tag behaviour (`render_meta`, `render_og`) by **reviewing, correcting, and extending** the existing `test_seo_tags.py` to fully satisfy SSOT and PRD requirements.

This task exists because earlier SEO import tests were created and deleted between commits and cannot be restored via git history. The responsibility here is to **recreate the missing coverage deliberately**, not to recover deleted files.

---

## **Context (Implementation Reality)**

* The active SEO test file is now:

  * `tests/seo/test_seo_tags.py` 
* This file:

  * Already tests meta defaults, overrides, OG defaults, OG image fallback, and canonical URLs.
  * Contains **inline commentary identifying a potential semantic mismatch** between:

    * Wagtail’s native `seo_title`
    * The platform’s `meta_title` / `get_meta_title()` logic.
* SSOT + PRD **do not explicitly mandate** use of Wagtail’s `seo_title`, but:

  * Wagtail pages *do* expose it by default.
  * Ignoring it is a **potential regression / DX footgun**, especially for editors.

The task is **not** to blindly satisfy the test as written —
the task is to make sure **tests reflect agreed platform behaviour**, and platform code reflects that behaviour consistently.

---

## **What You Must Do**

### 1. **SEO testing requirements**

You’re right — this is **not** something to delegate back to an agent.
This is **platform truth**, and you already gave me the SSOT + PRD.
So here it is, **explicitly**, with **decisions made**.

Below is the **authoritative SEO contract for the SUM Platform**, derived from **SSOT §10, §7, §9 and PRD US-A04**, not from Wagtail defaults.

You can treat this as **ground truth** for both implementation *and* tests.

---

# ✅ **SUM Platform SEO Behaviour Contract (Authoritative)**

This defines **what the platform guarantees**, regardless of Wagtail internals.

---

## 1. **Meta Title Precedence**

### **Guaranteed behaviour**

**Order of precedence (highest → lowest):**

1. `page.meta_title`
   (from `SeoFieldsMixin`, platform-owned)
2. `page.seo_title`
   (Wagtail Promote tab, editor-facing)
3. Fallback default:

   ```
   {page.title} | {SiteSettings.company_name}
   ```

### **Rationale**

* SSOT guarantees *platform-level SEO fields*.
* PRD allows editor control.
* Ignoring `seo_title` would be a DX regression.
* The fallback rule explicitly exists in PRD AC2.

### **Test must assert**

* If `meta_title` exists → it wins
* If empty but `seo_title` exists → use `seo_title`
* If neither exists → default fallback

✅ **Decision: `seo_title` MUST be respected as a fallback.**

---

## 2. **Meta Description Source**

### **Guaranteed behaviour**

**Order of precedence:**

1. `page.meta_description`
   (platform SEO field)
2. `page.search_description`
   (Wagtail Promote tab)
3. Omitted entirely if neither exists

### **Rationale**

* PRD requires meta description support.
* SSOT does **not** require auto-generation.
* Empty meta description is preferable to misleading content.

### **Test must assert**

* Correct source selection
* No empty `<meta name="description">` tags

---

## 3. **Robots Meta Behaviour**

### **Guaranteed behaviour**

Robots meta is derived **only** from platform flags:

* `seo_noindex`
* `seo_nofollow`

| Flags               | Output              |
| ------------------- | ------------------- |
| neither set         | `index, follow`     |
| `seo_noindex=True`  | `noindex, follow`   |
| `seo_nofollow=True` | `index, nofollow`   |
| both True           | `noindex, nofollow` |

### **Rationale**

* SSOT explicitly lists `seo_noindex` / `seo_nofollow`
* Wagtail defaults are irrelevant here

### **Test must assert**

* Exact string match for all combinations

---

## 4. **Canonical URL Generation**

### **Guaranteed behaviour**

* Canonical **always rendered**
* Canonical URL is:

  ```
  request.build_absolute_uri(page.url)
  ```
* Never hardcoded
* Never relative

### **Rationale**

* PRD AC7 mandates canonical URLs
* Absolute URLs are required for SEO correctness
* Multi-site support requires request context

### **Test must assert**

* Canonical exists
* Uses request host (`testserver`)
* Matches page path exactly

---

## 5. **Open Graph (OG) Behaviour**

### **OG Title**

**Order of precedence:**

1. `page.og_title` (if defined)
2. Meta title (resolved via rules above)

---

### **OG Description**

**Order of precedence:**

1. `page.og_description`
2. Meta description (resolved via rules above)
3. Omitted if neither exists

---

### **OG Image Fallback Chain**

**Order of precedence (strict):**

1. `page.og_image`
2. `page.featured_image`
3. `SiteSettings.og_default_image`
4. Omitted entirely

### **Rules**

* URLs must be **absolute**
* If no image exists → **do not render** `og:image`

### **Rationale**

* Explicitly defined in SSOT §10.3
* Prevents broken or empty OG previews

### **Test must assert**

* Correct fallback selection
* Absolute URL correctness
* Absence when no image exists

---

## 6. **OG URL + Site Name**

### **Guaranteed behaviour**

* `og:url` = canonical URL
* `og:site_name` = `SiteSettings.site_name`

---

# ✅ Summary: What Tests MUST Encode

Your tests must now **explicitly encode**:

* Meta title precedence including `seo_title`
* Meta description fallback to `search_description`
* Robots meta truth table
* Canonical URL absoluting
* OG fallback chains and omission rules

Any implementation or test that violates this is **wrong**, not “an alternative interpretation”.
---

### 2. **Reconcile `seo_title` vs `meta_title` behaviour**

You must make and enforce **one clear decision**:

Either:

* A) `seo_title` (Wagtail Promote tab) is respected as a fallback
  or
* B) `meta_title` is the *only* supported mechanism and `seo_title` is intentionally ignored

Once decided:

* Update **implementation** (mixin or template tag) accordingly
* Update **tests** to assert that behaviour explicitly

❗ It is not acceptable for tests to “hint” at desired behaviour via comments while code does something else.

---

### 3. **Complete missing test coverage**

Using `test_seo_tags.py` as the canonical test file, ensure coverage exists for:

#### Meta

* Default title fallback
* Explicit override
* Robots combinations:

  * index/follow
  * noindex
  * nofollow
  * noindex,nofollow

#### Open Graph

* Default OG tags
* OG image fallback order:

  1. page image
  2. site default image
  3. omitted if neither exists
* Absolute URL correctness

#### Canonical

* Always present
* Uses request host (`testserver`) + page path

#### Negative / edge cases

* No OG image anywhere → no `og:image` output
* Empty description → meta description omitted (if applicable)

---

### 4. **Stabilise test setup (no hacks)**

The current test file manually:

* Recreates root pages
* Deletes existing home pages
* Mutates the default Site

This is acceptable **only if**:

* Tests pass consistently
* Setup is deterministic
* No hidden ordering dependency exists

If instability is detected:

* Fix the fixture setup
* Do **not** add sleeps, retries, skips, or xfails

---

## **Hard Constraints**

* ❌ Do NOT delete or bypass failing tests
* ❌ Do NOT weaken assertions
* ❌ Do NOT introduce “magic” behaviour not justified by SSOT/PRD
* ❌ Do NOT add new SEO features

This task is about **correctness, alignment, and test truthfulness**.

---

## **Acceptance Criteria**

* [ ] `tests/seo/test_seo_tags.py` fully covers SEO template tag behaviour
* [ ] Tests clearly encode platform decisions (no TODO-style ambiguity)
* [ ] Implementation and tests agree on `seo_title` vs `meta_title`
* [ ] `make test` passes consistently
* [ ] No SEO-related test coverage regression remains

---

## **Testing Requirements**

This task *is* the test strategy fulfilment for SEO tags.

No additional test files required beyond:

* `test_seo_tags.py`

---

## **Estimated Complexity**

* **Time:** S–M
* **Risk:** Medium (SEO semantics + editor expectations)
* **Suggested Model:** GPT-5.2 / Claude Opus (reasoning + reconciliation)

