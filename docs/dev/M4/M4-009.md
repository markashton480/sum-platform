## **[M4-009]: Observability Baseline (Error Tracking + Structured Logs + Correlation IDs)**

**Objective**: Add a minimal, production-safe observability baseline: **Sentry error tracking**, **structured JSON logging**, and **request correlation IDs** propagated through logs and async tasks—without introducing noisy PII or breaking local dev.

---

## **Context** (from SSOT / Test Strategy)

- With forms → leads → email/webhook/Zapier + health endpoint now in place, we need _operational visibility_ when things fail in production (and proof we can detect failures without manually digging in DB).
- Test strategy emphasizes reliability and failure-mode observability (async workflows and “no lost leads”). Health endpoints are in; next is “when something breaks, can we see it and trace it?”.

---

## **Technical Requirements**

### 1) Sentry integration (error tracking)

- Add Sentry SDK to the project (if not already present).
- Enable Sentry only when environment variable exists:

  - `SENTRY_DSN`

- Configure:

  - environment name: `SENTRY_ENVIRONMENT` (default “development”)
  - release/version: use `GIT_SHA` or `RELEASE` env var if available

- Capture:

  - unhandled exceptions in Django
  - Celery task exceptions (integrate with Celery)

- Do **not** capture sensitive form fields (PII) in breadcrumbs/context.

### 2) Structured logging (JSON)

- Configure Django logging to output JSON logs to stdout in production.
- In dev, allow readable console logs (optional), but keep schema consistent if possible.
- Log fields to include at minimum:

  - `level`, `timestamp`, `logger`, `message`
  - `request_id` (see below)
  - `path`, `method`, `status_code` for request logs where applicable
  - `lead_id` and `site_id` in lead tasks (email/webhook/zapier)

### 3) Correlation IDs (request_id)

- Add middleware that:

  - reads incoming `X-Request-ID` header if present, else generates a UUID
  - stores on request (e.g., `request.request_id`)
  - sets response header `X-Request-ID`

- Ensure logs include request_id:

  - for Django requests
  - and for Celery tasks triggered from those requests where possible

### 4) Task correlation propagation

- When enqueuing Celery tasks from a request:

  - pass `request_id` as an argument (or include in task headers if you have that pattern)

- In tasks:

  - include request_id in logs
  - include request_id as Sentry scope/tag

### 5) Safety (PII and noise control)

- Do not log:

  - full form message bodies
  - raw email addresses
  - phone numbers

- If needed, log only:

  - whether email/phone were present
  - or a hashed/truncated identifier

---

## **Design Specifications**

- None (backend-only).

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Create:

  - `core/sum_core/ops/middleware.py` (CorrelationIdMiddleware)
  - `core/sum_core/ops/logging.py` (log config helpers, optional)
  - `core/sum_core/ops/sentry.py` (Sentry init)

- Modify:

  - settings module(s) to:

    - include middleware
    - configure logging
    - call sentry init conditionally

  - Celery tasks:

    - `core/sum_core/leads/tasks.py` (add request_id propagation + structured logs)
    - any integration modules that send webhooks

### Required header comments

Use your standard header block on all new Python modules.

### Guardrails

- Do not add heavy dependencies unless needed (prefer stdlib + Sentry SDK).
- Keep config toggled by env vars so local dev remains smooth.
- Avoid test flakiness: do not require network access.

---

## **Acceptance Criteria**

- [ ] If `SENTRY_DSN` is set, exceptions in Django and Celery tasks are captured by Sentry.
- [ ] If `SENTRY_DSN` is not set, app runs normally with no errors.
- [ ] Every HTTP response includes `X-Request-ID`.
- [ ] Logs emitted during a request include the same `request_id`.
- [ ] Celery tasks triggered by a request include the `request_id` in logs.
- [ ] Logs are structured JSON in production configuration.
- [ ] No PII (email/phone/message content) appears in logs by default.

---

## **Dependencies & Prerequisites**

- M4-007 tasks exist and are functioning (we’ll add correlation tags there).
- M4-008 health endpoint exists (can optionally include request_id in logs).

---

## **Testing Requirements**

- Unit tests:

  - middleware generates request_id when absent
  - middleware preserves inbound request_id when present
  - response header set

- Integration tests:

  - GET `/health/` returns response with `X-Request-ID` header

- Task tests:

  - enqueue a lead task with request_id and assert logger called with request_id (mock logger)

(Do not test Sentry network calls; just test init wiring and scoping.)

---

## **Estimated Complexity**

- **Time:** M
- **Risk:** Medium (settings/logging can be finicky, but contained)
- **Payoff:** Very high (debuggability + reliability)
