Agreed ü§ù ‚Äî no battle needed. We‚Äôre aligned.
Here is **M4-003 rewritten end-to-end in pure agent language**.
This is **execution-grade**: an agent can pick this up and implement without interpretation, product context, or guesswork.

---

# **[M4-003]: Wagtail Admin Lead Analytics Panel**

## **Agent Objective**

Add a **read-only analytics panel** to the **Wagtail admin home dashboard** that aggregates Lead data for the **current Site** over the **last 30 days**, using **existing database models only**.

---

## **What Already Exists (Do Not Recreate)**

- Lead model:

  - `core/sum_core/leads/models.py`

- Relevant Lead fields:

  - `submitted_at`
  - `status`
  - `lead_source`
  - `source_page` ‚Üí `.get_site()`

- Wagtail admin is already configured and working.
- No analytics dashboards exist yet.

---

## **What You Must Build**

### 1. **A Wagtail dashboard panel**

- Appears on **Wagtail admin home**
- Uses Wagtail‚Äôs **official dashboard panel / hook system**
- Is **read-only**
- Scoped to the **current Wagtail Site**

### 2. **Lead aggregation logic**

Using Django ORM only:

- Filter Leads:

  - `submitted_at >= now() - 30 days`
  - Belonging to the current Site
    (`lead.source_page.get_site() == request.site`)

- Aggregate:

  - Total lead count
  - Lead counts grouped by:

    - `status`
    - `lead_source`

---

## **Hard Constraints (Do Not Violate)**

- ‚ùå Do NOT add or modify models
- ‚ùå Do NOT store analytics snapshots
- ‚ùå Do NOT call Google Analytics, GTM, or external APIs
- ‚ùå Do NOT add JS charting libraries
- ‚ùå Do NOT hardcode site IDs
- ‚ùå Do NOT slow down admin noticeably

---

## **Expected UI Output**

Minimal, static admin panel content:

- Title:
  **‚ÄúLead Summary (Last 30 Days)‚Äù**
- Content:

  - Total leads: **N**
  - Leads by status:

    - New: N
    - Contacted: N
    - Quoted: N
    - Won: N
    - Lost: N

  - Leads by source:

    - Google Ads: N
    - SEO: N
    - Direct: N
    - Referral: N
    - Unknown: N

- Static helper text at bottom:

  > ‚ÄúFor detailed analytics, visit Google Analytics.‚Äù

No charts required. Plain lists are acceptable.

---

## **Implementation Expectations**

### Likely files (you may adjust paths if cleaner):

- `core/sum_core/analytics/dashboard.py`

  - Contains aggregation helper functions

- `core/sum_core/analytics/wagtail_hooks.py`

  - Registers dashboard panel

- Optional template:

  - `core/sum_core/templates/sum_core/admin/lead_analytics_panel.html`

### Guidelines

- Keep aggregation logic **separate from rendering**
- Use `annotate()`, `values()`, `Count()`
- Handle empty datasets cleanly (show zeroes or ‚ÄúNo leads yet‚Äù)
- Panel must fail gracefully if no Site or no Leads

---

## **Acceptance Criteria**

- [ ] Panel appears on Wagtail admin home
- [ ] Correctly scoped per Site
- [ ] Shows totals + breakdowns
- [ ] Uses last 30 days only
- [ ] No errors with zero leads
- [ ] No model changes
- [ ] No external dependencies

---

## **Testing Requirements**

- **Unit tests**

  - Aggregation helpers return correct counts for seeded Leads

- **Integration test**

  - Panel renders for a Site with Leads
  - Panel renders empty state for Site with none

No JS tests. No snapshot tests.

---

## **Complexity**

- **Time:** Medium
- **Risk:** Low
- **Implementation-friendly**

---
