## **[M4-006]: Technical SEO — Sitemap + robots.txt**

**Objective**: Implement **/sitemap.xml** and **/robots.txt** to satisfy PRD US-A06 and SSOT §10.6: generate an XML sitemap including all published pages (with exclusions and metadata), and serve a configurable robots.txt that references the sitemap.

---

## **Context** (from SSOT - PRD Section)

**SSOT Milestone 4 deliverables include:**

- “Sitemap and robots.txt” and “Sitemap includes all published pages.”

**PRD US-A06 Technical SEO acceptance criteria require:**

- Sitemap at `/sitemap.xml` (P0)
- Exclude LandingPages, unpublished pages, and **noindex** pages (P0)
- Include `lastmod`, `changefreq`, `priority` (P0)
- Robots.txt configurable and default allows all + references sitemap (P0)
- 301 redirects handled via Wagtail redirects (already a Wagtail feature; just ensure not blocked).

---

## **Technical Requirements** (from SSOT - Tech Spec Section)

### 1) `/sitemap.xml` endpoint

Implement an auto-generated XML sitemap:

**Include**

- All **published** pages for the current `Site`
- Must include per-URL:

  - `<loc>`
  - `<lastmod>`
  - `<changefreq>`
  - `<priority>`

**Exclude**

- Unpublished pages (draft/private)
- Pages with `seo_noindex=True` (platform flag)
- LandingPages (page type exclusion required by PRD)

**Multi-site rules**

- Sitemap must be scoped per Site root (do not leak pages from other sites).

### 2) `/robots.txt` endpoint

Provide a robots.txt at `/robots.txt`:

**Default behaviour (no config set)**

- Allow all
- Must include a `Sitemap:` line pointing to the absolute sitemap URL.

**Configurable behaviour**

- Must be configurable “via admin or file” (PRD AC4).
  Implementation options (choose one; prefer simplest):
- Option A (recommended): Store robots text in `SiteSettings` field (per-site), with default fallback.
- Option B: Use a template file override + settings toggle (less flexible per-site).

### 3) Performance constraints

- Sitemap generation must not be N+1 query heavy.
- Prefer Wagtail’s `PageQuerySet` patterns and/or a cached sitemap render for short TTL if needed (but don’t over-engineer).

---

## **Design Specifications** (from SSOT - Design Section)

- No frontend styling.
- Output must be valid XML for sitemap and plain text for robots.

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Add sitemap view + URL route:

  - `core/sum_core/seo/sitemap.py` (or `core/sum_core/seo/views.py`)
  - `core/sum_core/seo/urls.py` (or hook into existing project urls)

- Add robots view + URL route:

  - `core/sum_core/seo/robots.py`

- Add template(s) if needed:

  - `core/sum_core/templates/sum_core/seo/sitemap.xml`
  - `core/sum_core/templates/sum_core/seo/robots.txt`

### Required header comments

```python
"""
Name: sitemap
Path: core/sum_core/seo/sitemap.py
Purpose: Generate per-site sitemap.xml per platform Technical SEO requirements.
Family: Technical SEO (M4-006)
Dependencies: Wagtail Site/Page models, SeoFieldsMixin (seo_noindex), optional SiteSettings
"""
```

### Notes for agent

- Use `request.site` (or equivalent Wagtail site resolution) to scope output.
- For `<lastmod>`, prefer the most reliable timestamp available (often `last_published_at` or similar); if absent, omit or derive consistently.
- Keep exclusions explicit and tested.

---

## **Acceptance Criteria**

**Sitemap**

- [ ] GET `/sitemap.xml` returns 200 with correct `Content-Type` (`application/xml` or `text/xml`)
- [ ] Includes only published pages under the current Site root
- [ ] Excludes:

  - LandingPages
  - Unpublished pages
  - Pages with `seo_noindex=True`

- [ ] Each URL entry includes `loc`, `lastmod`, `changefreq`, `priority`

**Robots**

- [ ] GET `/robots.txt` returns 200 with `text/plain`
- [ ] Default allows all + references sitemap absolute URL
- [ ] Configurable per-site (SiteSettings or equivalent)

---

## **Dependencies & Prerequisites**

- M4-004B and M4-005 complete (noindex flags exist; schema already in head)

---

## **Testing Requirements** (from test-strategy-v1.1.md)

Test strategy explicitly includes SEO technical checks: “robots, sitemap.”

### Unit tests

- Sitemap builder excludes:

  - noindex pages
  - unpublished pages
  - LandingPage type

- Robots builder:

  - default output includes Sitemap line

### Integration tests

- GET `/sitemap.xml`:

  - contains published HomePage URL
  - does not contain a noindex page URL

- GET `/robots.txt`:

  - contains `Sitemap: http://testserver/sitemap.xml` (or equivalent absolute)

---

## **Estimated Complexity**

- **Time:** M
- **Risk:** Medium (page filtering correctness + multi-site scoping)
