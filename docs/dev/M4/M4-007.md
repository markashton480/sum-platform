## **[M4-007]: Zapier Webhook Integration for Leads (Delivery, Retries, Status Tracking)**

**Objective**: Implement outbound Zapier webhook delivery for Lead events, including per-site configuration, reliable asynchronous sending, retry/backoff on failures, status persistence on the Lead record, and test coverage proving “no lost leads” even when the webhook fails.

---

## **Context** (from SSOT - PRD Section)

- Platform must support sending new Lead data to external automation tools (Zapier) via webhook, without losing the Lead if delivery fails.
- This is part of Milestone 4 “Integrations / Reliability” and ties directly to the “no lost leads” guarantee.
- The codebase already has async task patterns for notifications/webhooks and recently hardened concurrency/idempotency (CM-001), so this task should follow that established approach.

---

## **Technical Requirements** (from SSOT - Tech Spec Section)

### 1) Configuration (per-site)

Add to `SiteSettings` (or existing integration settings model if already present):

- `zapier_webhook_url` (URLField/TextField)
- `zapier_enabled` (Boolean) OR treat presence of URL as enabled
- Optional: `zapier_secret` (for signing) **only if SSOT/PRD requires**; otherwise don’t invent.

**Admin UI**

- Add these fields to a clearly labelled panel (e.g. “Integrations → Zapier”).

### 2) Delivery rules

When a Lead is created:

- If Zapier is configured for the site:

  - enqueue async delivery task

- If not configured:

  - do nothing (but lead still exists)

Payload must include at minimum:

- lead id
- submitted_at
- site identifier (hostname or site_name)
- page url (source page)
- lead_source
- contact fields (name/email/phone/message + form_type)
- any extra stored fields that are part of your Lead model

### 3) Reliability + status tracking

Persist delivery state on the Lead record (or existing integration status model if present):

- `zapier_status`: PENDING / SENT / FAILED
- `zapier_last_attempt_at`
- `zapier_attempt_count`
- `zapier_last_error` (truncated string)

**Idempotency**

- Must be concurrency-safe:

  - Use `transaction.atomic()` + `select_for_update()` when checking/updating status (same pattern as CM-001).

- If already `SENT`, task must no-op.

### 4) Retries / backoff

- On HTTP failures (>=400), timeouts, connection errors:

  - mark failed attempt
  - retry with exponential backoff up to N attempts (choose N=5 unless SSOT says otherwise)

- On success (2xx):

  - mark SENT and stop retrying

- If the endpoint returns 410/404 etc, still treat as failure (don’t disable automatically).

### 5) Observability

- Log failures with sufficient context (lead id, site, status code).
- If Sentry is configured in the project, capture exception; otherwise standard logging is fine.

---

## **Design Specifications** (from SSOT - Design Section)

- No frontend changes.
- Wagtail admin settings only (fields + help text).
- Error strings should be human-readable for internal troubleshooting.

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Modify:

  - `core/sum_core/branding/models.py` (SiteSettings: Zapier fields + panels)
  - `core/sum_core/leads/models.py` (status fields) **only if these don’t already exist**
  - `core/sum_core/leads/tasks.py` (Zapier delivery task, reuse hardened pattern)
  - Lead creation flow / signal / post-save hook that enqueues task

- Create:

  - `core/sum_core/integrations/zapier.py` (pure helper to build payload + perform request)

### Required header comments

Add standard header blocks to any new Python modules.

### Guardrails

- Do not block the form submission request on webhook delivery.
- Do not lose the Lead if webhook fails.
- Do not add a complex plugin system here; keep it simple and deterministic.

---

## **Acceptance Criteria**

- [ ] When a Lead is created and Zapier URL is configured for the site, an async task is enqueued.
- [ ] Successful webhook delivery sets `zapier_status=SENT`.
- [ ] Failures set `zapier_status=FAILED` (or remain PENDING while retries continue), record attempt count and last error.
- [ ] Retries occur up to the configured max with backoff.
- [ ] Duplicate task execution does not send multiple webhooks (idempotent + DB lock).
- [ ] If Zapier is not configured, no task runs and Lead creation still works.
- [ ] Unit and integration tests cover success + failure + retry + idempotency.

---

## **Dependencies & Prerequisites**

- CM-001 patterns must be followed (atomic lock + select_for_update) for idempotency.
- M4-006 completed (SiteSettings already evolving; migration patterns in `sum_core/migrations/` are established).

---

## **Testing Requirements** (from test-strategy-v1.1.md)

- Unit tests:

  - payload builder produces expected dict
  - idempotency gating logic

- Integration tests:

  - simulate webhook success (mock HTTP)
  - simulate webhook failure (mock exception/500) and assert retry state changes
  - simulate double-run (two calls) and assert only one request is made

- Ensure tests confirm “Lead exists regardless of webhook outcome”.

---

## **Estimated Complexity**

- **Time:** M–L
- **Risk:** High (integration + reliability + retries)
- **Payoff:** Very high (this is core platform value)
