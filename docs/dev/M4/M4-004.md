## **[M4-004]: SEO template tags + page-level SEO/OG field integration**

**Objective**: Implement the `seo_tags` template tag library and wire it into the base template so every page renders correct **meta title/description/robots**, **canonical URL**, and **Open Graph** tags with the required fallback chain and defaults—plus tests that verify real HTML output.

---

## **Context** (from SSOT - PRD Section)

- **SSOT deliverable**: “SEO template tags” and “Meta tags, OG tags render correctly” as part of Milestone 4 definition of done.

- **SSOT contract** (template tag API):

  ```django
  {% load seo_tags %}
  {% render_meta page %}    {# meta title, description, robots #}
  {% render_og page %}      {# Open Graph tags #}
  {% render_schema page %}  {# JSON-LD structured data #}
  ```

  (This ticket implements `render_meta` + `render_og`; schema is handled in M4-005.)

- **PRD US-A04: SEO Foundation** acceptance criteria include:

  - AC1: meta title + meta description fields on all pages
  - AC2: default meta title = page title + site name
  - AC4–AC5: OG tags + OG image fallback chain
  - AC7: canonical URL on all pages

---

## **Technical Requirements** (from SSOT - Tech Spec Section)

### 1) Implement `seo_tags` template tag library

- Create `{% load seo_tags %}` module exposing:

  - `render_meta(page)` → outputs:

    - `<title>…</title>`
    - `<meta name="description" …>`
    - `<meta name="robots" …>` derived from page flags
    - `<link rel="canonical" …>`

  - `render_og(page)` → outputs:

    - `og:title`, `og:description`, `og:image`, `og:url`, `og:type`

- Output should be safe HTML and must render cleanly for any Wagtail `Page` object.

### 2) Defaults + fallbacks (must match PRD/SSOT)

- **Meta title default**: `page.title + " | " + site_name` (or equivalent) when page meta title is blank.
- **OG image fallback chain**:

  1. `page.og_image` (if present)
  2. `page.featured_image` (if present)
  3. `SiteSettings.default_og_image` (or equivalent site-level default)
     _If the site default field does not exist yet, add it to `SiteSettings` and migrate (don’t invent a new settings model)._

- **Canonical URL**: always present, derived from the resolved full URL.
- **Robots meta**:

  - Use `seo_noindex` / `seo_nofollow` flags to build `content="noindex,nofollow"` variants as needed.

### 3) Wire into base template

- In `core/sum_core/templates/sum_core/base.html`:

  - load `seo_tags`
  - call `{% render_meta page %}` and `{% render_og page %}` inside `<head>` before analytics tags (order doesn’t matter much but keep it deterministic).

- Must not break existing analytics injection (`analytics_tags`) or event tracking JS already implemented in M4-001/M4-002.

### 4) Make “page SEO fields exist” real

SSOT says “All pages include SEO fields” and PRD US-A04 AC1 requires them.
If these fields are already present via `SeoFieldsMixin` / `OpenGraphMixin` (README implies they exist), confirm usage and don’t duplicate.
If any required field is missing, add it to the correct mixin/model and migrate.

---

## **Design Specifications** (from SSOT - Design Section)

- No layout/styling changes.
- No inline CSS or JS added for SEO tags.
- The only output is valid `<head>` markup: title/meta/link/meta property tags.

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Create:

  - `core/sum_core/seo/templatetags/seo_tags.py`
  - `core/sum_core/seo/templatetags/__init__.py`
  - `core/sum_core/templates/sum_core/includes/seo/meta.html`
  - `core/sum_core/templates/sum_core/includes/seo/og.html`

- Modify:

  - `core/sum_core/templates/sum_core/base.html`

- Potentially modify (only if missing fields):

  - `core/sum_core/pages/mixins.py` (or wherever `SeoFieldsMixin` / `OpenGraphMixin` live)
  - `core/sum_core/branding/models.py` (`SiteSettings` for site-level OG defaults)

### Required header comments

For any new Python module, include:

```python
"""
Name: seo_tags
Path: core/sum_core/seo/templatetags/seo_tags.py
Purpose: Render SEO meta + Open Graph tags with platform-standard defaults/fallbacks.
Family: base template head rendering; SEO verification tests
Dependencies: Wagtail Page, SiteSettings, SeoFieldsMixin/OpenGraphMixin
"""
```

### Guardrails (agent-executable)

- Do **not** hardcode domains. Always use Wagtail’s page URL resolution.
- Do **not** assume `request` exists in template context unless you explicitly use `takes_context=True`. Prefer `page.get_site()`/`Site.find_for_request(request)` pattern only if needed.
- Keep fallbacks pure and deterministic (no DB queries in templates beyond what is necessary to fetch SiteSettings once).
- Ensure tag output is stable across pages (no random ordering).

---

## **Acceptance Criteria**

**Meta**

- [ ] `<title>` is present on every rendered page.
- [ ] If page `seo_title`/`meta_title` is blank → title becomes `page.title + site_name` default.
- [ ] `<meta name="description">` renders from page field when set.
- [ ] `<meta name="robots">` reflects `seo_noindex` / `seo_nofollow` flags correctly.
- [ ] `<link rel="canonical">` is always present and equals the page’s canonical URL.

**Open Graph**

- [ ] `og:title`, `og:description`, `og:image`, `og:url`, `og:type` are present.
- [ ] OG image fallback works: page → featured → site default.
- [ ] If no image exists anywhere, `og:image` is omitted (don’t output broken URLs).

**Non-regression**

- [ ] Existing GA/GTM injection remains functional.
- [ ] Existing event tracking JS remains included.

---

## **Dependencies & Prerequisites**

- M4-001 / M4-002 completed (base template already modified; ensure no merge conflict).
- `SiteSettings` exists and is used by other runtime tags.

---

## **Testing Requirements** (from test-strategy-v1.1.md)

SEO regressions are explicitly called out as a core risk theme; we should test at both unit + integration levels.

### Unit tests

- Test the template tag helper logic:

  - meta title defaulting
  - robots meta composition
  - OG image fallback chain selection

### Integration tests

- Render real pages in the test project and assert the HTML contains:

  - `<title>` and description meta
  - canonical link
  - OG tags + correct `og:url`

- Add at least one negative case:

  - when `seo_noindex=True`, `robots` contains `noindex`

### Coverage expectations

- New/changed modules must keep milestone standards (≥80% for core paths).

---

## **Estimated Complexity**

- **Time:** M
- **Risk:** Medium (fallback correctness + “fields already exist” ambiguity)
- Reference: Milestone 4 scope and risk emphasis on SEO regressions.

---
