# Daily Code Review Report - December 12, 2025

**Reviewer:** Automated Code Review Agent  
**Scope:** Milestone 3 (M3-001 to M3-005) and Navigation System (NAV-001 to NAV-007)  
**Test Status:** ✅ 367 passed (87% coverage)  
**Lint Status:** ⚠️ 24 errors (mostly mypy type issues)

---

## 1. High-Level Summary

- **Overall Health: GOOD** – A solid implementation of the navigation system with well-structured models, services, template tags, and comprehensive test coverage. The architecture follows Wagtail best practices and the implementation matches the specification closely.

- **Key Accomplishments:**

  - ✅ `UniversalLinkBlock` with 5 link types implemented with proper validation and computed properties
  - ✅ `HeaderNavigation` and `FooterNavigation` site settings models with StreamField constraints
  - ✅ Effective settings resolver with clear precedence (Navigation → Branding fallback)
  - ✅ Cache invalidation layer with signal handlers for settings saves and page lifecycle
  - ✅ Template tags with active page detection and read-through caching

- **Blocking Issues:** None – all tests pass and the core functionality is complete

- **Should Fix Soon:** 5 mypy "Returning Any" errors in `navigation_tags.py` need explicit casts

---

## 2. Critical / Blocking Issues

**No blocking issues identified.** All 367 tests pass and core functionality is complete.

---

## 3. Important Issues (should be scheduled soon)

### [SEVERITY: HIGH] Mypy Type Errors in Navigation Template Tags

**Files:** `core/sum_core/navigation/templatetags/navigation_tags.py` (lines 64, 78, 275, 289, 305)

**What's wrong:**  
There are 5 `no-any-return` mypy errors where functions declare a return type but return `Any` due to dynamic attribute access or calls to external functions without proper type narrowing.

**Why it matters:**  
These warnings reduce type safety confidence and could hide bugs when methods' signatures change. The navigation tags are used on every page render, so correctness here is important.

**Concrete fix:**

```python
# Line 64: _make_cache_key
def _make_cache_key(tag_name: str, site_id: int) -> str:
    return str(get_nav_cache_key(site_id, tag_name))  # Explicit str()

# Lines 275, 289, 305: Active detection helpers
# Add explicit bool() casts or use TypeGuard patterns
def _is_current_page(linked_page: Page | None, current_page: Page | None) -> bool:
    if linked_page is None or current_page is None:
        return False
    return bool(linked_page.pk == current_page.pk)  # Explicit bool()
```

---

### [SEVERITY: HIGH] `header_nav` Tag Does Not Use Caching

**File:** `core/sum_core/navigation/templatetags/navigation_tags.py` (lines 417-475)

**What's wrong:**  
The `header_nav` template tag does not cache its results, unlike `footer_nav` and `sticky_cta`. The code comments explain this is intentional because "active detection must happen per-request, not cached", but the spec (NAV-006) requires caching for all nav tags.

**Why it matters:**  
The navigation spec (section 3.3) states: "Cache key format: `nav:{type}:{site_id}`" for header/footer/sticky. Not caching `header_nav` means each page view triggers a database query to fetch `HeaderNavigation` and `SiteSettings`, which could impact performance at scale. The comment about active detection is correct – active states must be computed per-request – but the **base menu data** (items, labels, links) should be cached.

**Concrete fix:**  
Split the implementation:

1. Cache the **base menu data** (labels, hrefs, link types)
2. Compute **active states** per-request from cached data
3. Use a similar pattern to `sticky_cta` for the base data

```python
@register.simple_tag(takes_context=True)
def header_nav(context: dict[str, Any]) -> dict[str, Any]:
    # ...existing setup...
    cache_key = _make_cache_key("header", site.id)

    # Cache base data only
    cached_base = cache.get(cache_key)
    if cached_base is None:
        cached_base = _build_header_base_data(site)
        cache.set(cache_key, cached_base, timeout=_get_cache_ttl())

    # Apply active states per-request (not cached)
    return _apply_active_states(cached_base, current_page, request)
```

---

### [SEVERITY: HIGH] Unused Type Ignore Comments in Tests

**Files:** Multiple test files in `tests/branding/`

**What's wrong:**  
There are 8 "unused type: ignore" comments in test files:

- `tests/branding/test_theme_presets.py` (lines 13, 15, 17)
- `tests/branding/test_site_settings_model.py` (line 12)
- `tests/branding/test_branding_tags.py` (lines 16, 17)
- `tests/branding/test_branding_fonts.py` (line 14)
- `tests/branding/test_branding_css.py` (line 14)

**Why it matters:**  
These indicate either:

1. Stale `# type: ignore` comments left after the underlying issue was fixed
2. Misplaced ignores that are now masking nothing

This is minor but contributes to lint noise and suggests cleanup was incomplete after a previous refactor.

**Concrete fix:**  
Remove the unused `# type: ignore` comments from each file.

---

## 4. Minor Issues / Polish

### Missing `social_tiktok` Field in FooterNavigation

**File:** `core/sum_core/navigation/models.py`

The `FooterNavigation` model has fields for Facebook, Instagram, LinkedIn, YouTube, and X (Twitter), but no `social_tiktok` field. The `services.py` resolver correctly falls back to `SiteSettings.tiktok_url`, but there's no override capability in FooterNavigation itself. This is **by design** according to the service docstring ("TikTok: Always from Branding"), but creates an inconsistent editor experience.

**Recommendation:** If this is intentional, add a comment to the model explaining the design decision. Otherwise, add `social_tiktok` for consistency.

---

### Duplicate Phone Cleaning Logic

**Files:**

- `core/sum_core/blocks/links.py` (lines 35-36, `PHONE_CLEAN_PATTERN`)
- `core/sum_core/navigation/templatetags/navigation_tags.py` (line 45, `PHONE_CLEAN_PATTERN`)

**Issue:** Two nearly identical regex patterns for phone number cleaning exist. The one in `links.py` is `r"[^\d+]"` while the one in `navigation_tags.py` is `r"[^\d+]"` — actually identical.

**Recommendation:** Extract to a shared utility module (`sum_core/utils/phone.py` or similar) to follow DRY.

---

### Missing Aria Labels on Mobile Menu Toggle

**File:** `docs/dev/NAV/nav-popup-design.html` (line 694)

The mobile menu button has `aria-label="Toggle Menu"` which is good. However, the `aria-expanded` attribute is missing and should be toggled via JavaScript to indicate menu state for assistive technologies.

**Recommendation:** In the eventual production templates, ensure:

```html
<button
  class="menu-btn"
  aria-label="Toggle Menu"
  aria-expanded="false"
  aria-controls="mobileDrawer"
></button>
```

And toggle `aria-expanded` in the JS handler.

---

## 5. Test Suite Review

### Strengths

- **Comprehensive coverage** for all new navigation components:

  - `test_link_blocks.py` (23KB) – thorough validation of `UniversalLinkBlock`
  - `test_menu_blocks.py` (10KB) – constraint tests for max items
  - `test_models.py` (13KB) – model field and constraint tests
  - `test_services.py` (19KB) – effective settings resolver tests
  - `test_cache.py` (25KB) – cache key format, signal handlers, site isolation
  - `test_templatetags.py` (25KB) – tag output structure and active detection

- **Good patterns observed:**

  - `autouse` fixtures for cache clearing prevent test pollution
  - UUID-based slugs for test pages ensure isolation
  - Explicit cleanup of test pages after active detection tests
  - Tests for graceful fallback when cache operations fail

- **Edge cases covered:**
  - Empty/missing request context returns `{}`
  - Cache hit returns cached data without DB query
  - Phone number normalization handles various formats
  - Anchor validation rejects invalid HTML IDs

### Weaknesses / Missing Tests

1. **No integration test for actual template rendering** – Tests verify return values of template tags, but no test renders `base.html` or header/footer templates with these tags to verify HTML output.

2. **Missing negative test: malformed StreamField data** – What happens if `menu_items` contains corrupted JSON or references a deleted page? The `_extract_link_data` helper tries to handle this, but there's no test.

3. **No test for copyright year placeholder edge case** – What if copyright_text contains `{year}` but current year calculation fails? (Unlikely but possible during timezone edge cases.)

**Suggested additional tests (prioritized):**

1. **P0:** Template rendering integration test that loads a full page with navigation tags
2. **P1:** Test `_extract_link_data` with a mock UniversalLinkValue that has a deleted/unpublished page
3. **P1:** Test multi-level dropdown menu item extraction (when children have children – currently not supported but should fail gracefully)

---

## 6. Design System & CSS Compliance

### Assessment: ✅ COMPLIANT (for prototype)

The `nav-popup-design.html` prototype demonstrates proper token usage:

- All colors use HSL with CSS custom properties (`hsla(var(--primary), 1)`)
- Spacing uses documented tokens (`--container-padding`, `--section-gap`)
- Typography uses font tokens (`--font-display`, `--font-body`)
- Border radii use tokens (`--radius-sm`, `--radius-md`, `--radius-lg`)

**However**, this is a design prototype, not production CSS. The actual CSS for production navigation components has not been created yet – the spec mentions:

- `components.header.css`
- `components.mobile-menu.css`
- `components.footer.css`
- `components.sticky-cta.css`

**Recommendation:** When implementing NAV-007's templates in production, ensure:

1. All CSS goes into the appropriate component files
2. No inline styles (the prototype has some, e.g., lines 803, 810, 817)
3. Use existing section header patterns from `layout.css`

---

## 7. Suggested Refactors / Tech Debt Notes

### 7.1 [FUTURE] Extract Phone/Email Normalization to Shared Utils

**Current:** Phone number cleaning logic is duplicated between `links.py` and `navigation_tags.py`.

**Proposed:** Create `core/sum_core/utils/contact.py`:

```python
def normalize_phone_href(phone: str) -> str:
    """Return tel: href from phone number, stripping formatting."""
    ...

def normalize_email_href(email: str) -> str:
    """Return mailto: href from email address."""
    ...
```

This centralizes contact normalization and makes it reusable for CTAs, contact blocks, etc.

---

### 7.2 [FUTURE] Consider Dataclass-Based Menu Items

**Current:** `_build_menu_item` returns `dict[str, Any]`, which loses type safety and requires careful key checking in templates.

**Proposed:** Define dataclasses for menu item structure:

```python
@dataclass
class MenuItemContext:
    label: str
    href: str
    is_external: bool
    is_current: bool
    is_active: bool
    has_children: bool
    children: list["MenuItemContext"]
```

This provides better autocomplete in templates (with IDE plugins) and clearer contracts.

---

### 7.3 [FUTURE] Implement Nested Menu Support (2-Level Dropdowns)

**Current:** The data model supports single-level dropdowns (`MenuItemBlock.children`), but the spec now mentions potential 2-level deep menus.

**Proposed for future NAV task:**

1. Create `SubmenuItemBlock` that can also have `children` (currently it cannot)
2. Update `_build_menu_item` to recursively build child items
3. Add CSS/JS from `nav-popup-design.html` for flyout menus
4. Ensure ARIA attributes are correct for nested accordions on mobile

The `nav-popup-design.html` prototype already demonstrates the HTML structure and CSS needed (lines 346-393 for desktop flyout, lines 714-726 for mobile nested accordion).

---

## 8. Questions / Clarifications

1. **Is the missing cache for `header_nav` intentional?**  
   The code comment suggests yes (active detection), but the spec requires it. Should we implement the split approach (cache base data, compute active per-request)?

2. **Should TikTok field be added to FooterNavigation?**  
   Currently it always falls back to Branding. Is this intentional to avoid complex override logic for a less-common platform?

3. **When is 2-level nested menu support needed?**  
   The `nav-popup-design.html` demonstrates the pattern. Should this be added to the current implementation or tracked as a separate task (NAV-008)?

4. **What's the timeline for production CSS files?**  
   The spec lists `components.header.css` etc. but these don't exist yet. Are they blocked on template completion or should scaffolding start now?

---

## Summary of Action Items

| Priority | Item                                            | Owner | Estimate |
| -------- | ----------------------------------------------- | ----- | -------- |
| HIGH     | Fix 5 mypy errors in `navigation_tags.py`       | Dev   | 30 min   |
| HIGH     | Remove 8 unused `# type: ignore` comments       | Dev   | 15 min   |
| HIGH     | Implement caching for `header_nav` base data    | Dev   | 1-2 hrs  |
| MEDIUM   | Extract phone normalization to shared utils     | Dev   | 30 min   |
| LOW      | Add integration test for template rendering     | Dev   | 1 hr     |
| LOW      | Document TikTok field design decision           | Dev   | 10 min   |
| FUTURE   | Implement 2-level nested menu support (NAV-008) | TBD   | 1-2 days |

---

**End of Review**
