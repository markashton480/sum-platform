# SUM Platform Daily Code Review Report

**Date:** 2025-12-11  
**Scope:** Full codebase review of `sum_core` (first comprehensive review)  
**Reviewer:** AI Code Review Agent  

---

## 1) High-Level Summary

- **Overall Health:** The `sum_core` codebase is **well-structured** and follows consistent patterns. The architecture is clean, with proper separation between blocks, pages, branding, and templates.
- **Test Coverage:** 91% coverage with 111 tests—a strong foundation. 109 tests pass, 2 fail (test database state issues, not code bugs).
- **Design System Compliance:** Generally excellent token usage. A few minor inline styles and hardcoded values exist but are isolated.
- **Key Strengths:** Excellent documentation headers, consistent module patterns, proper Wagtail conventions, and comprehensive branding system.

**Blocking Issues:** None  
**Important Issues:** 3 (should schedule soon)  
**Minor Issues:** 5 (polish items)

---

## 2) Critical / Blocking Issues (must fix before merge or very soon)

**None identified.** The codebase is in a healthy, deployable state.

---

## 3) Important Issues (should be scheduled soon)

### [SEVERITY: HIGH] Issue 3.1 – Inconsistent `has_hero_block` implementations

**Files:** 
- `core/sum_core/pages/standard.py` (lines 51-62)
- `core/sum_core/test_project/home/models.py` (lines 43-55)

**What's wrong:**  
Two implementations of `has_hero_block` exist with different `hero_block_types` lists:

```python
# StandardPage (standard.py:57)
hero_block_types = ["hero_image", "hero_gradient", "hero"]

# HomePage (test_project/home/models.py:49)
hero_block_types = ["hero_image", "hero_gradient"]  # Missing "hero"
```

**Why it matters:**  
This inconsistency means the same hero block ("hero" from content.py) will be detected on StandardPage but not on HomePage, causing unpredictable fallback header rendering.

**Concrete fix:**  
Extract `has_hero_block` to a shared mixin or utility function in `sum_core` that both page types inherit. Ensure the list is canonical and matches all hero block types in `PageStreamBlock`.

```python
# sum_core/pages/mixins.py (new file)
HERO_BLOCK_TYPES = frozenset(["hero_image", "hero_gradient", "hero"])

class HeroDetectionMixin:
    @property
    def has_hero_block(self) -> bool:
        if not self.body:
            return False
        return any(block.block_type in HERO_BLOCK_TYPES for block in self.body)
```

---

### [SEVERITY: HIGH] Issue 3.2 – Two failing tests in `test_homepage_rendering.py`

**Files:** `tests/templates/test_homepage_rendering.py` (lines 8-63, 65-145)

**What's wrong:**  
Tests `test_homepage_renders_testimonials_block` and `test_homepage_renders_gallery_block` are failing with 404 errors:

```
FAILED tests/templates/test_homepage_rendering.py::test_homepage_renders_testimonials_block - assert 404 == 200
FAILED tests/templates/test_homepage_rendering.py::test_homepage_renders_gallery_block - assert 404 == 200
```

**Why it matters:**  
Failing tests reduce confidence in the test suite and may mask real regressions. The test strategy mandates a passing test suite.

**Concrete fix:**  
The tests create pages as children of `root_page` but don't publish them. Add `home.save_revision().publish()` after creating the page, similar to `test_content_blocks_rendering.py` (line 53). Also verify the site routing is correctly configured for the test pages.

```python
home = HomePage(title="Home Test", slug="home-test-testimonials")
root.add_child(instance=home)
home.body = [...]
home.save_revision().publish()  # Add this line
```

---

### [SEVERITY: HIGH] Issue 3.3 – Hardcoded colors in `components.comparison.css`

**File:** `core/sum_core/static/sum_core/css/components.comparison.css` (lines 46, 70, 75, 78)

**What's wrong:**  
Several hardcoded color values bypass the design token system:

```css
/* Line 46 */
border-right: 2px solid white;

/* Lines 70, 75 */
background: white;
color: black;

/* Line 78 */
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
```

**Why it matters:**  
The design system requires all colors to use tokens (`var(--*)`). Hardcoded values prevent branding customization and break the single-source-of-truth principle (per PRD 6.6 and `css-architecture-and-tokens.md`).

**Concrete fix:**  
Replace with token-based values:

```css
/* Line 46 */
border-right: 2px solid hsla(var(--surface-pure), 1);

/* Lines 70, 75 */
background: hsla(var(--surface-pure), 1);
color: hsla(var(--text-main), 1);

/* Line 78 - use existing shadow token */
box-shadow: var(--shadow-lg);
```

---

## 4) Minor Issues / Polish

### Issue 4.1 – Inline styles in templates

**Files:**
- `core/sum_core/templates/sum_core/blocks/contact_form.html` (line 7)
- `core/sum_core/templates/sum_core/includes/header.html` (lines 11, 30)

**What's wrong:**  
Inline `style=""` attributes are used:
- `style="text-align: left; max-width: none;"` (contact form header override)
- `style="max-height: 40px;"` (header logo)
- `style="width: 18px; align-self: flex-end;"` (menu button line)

**Recommendation:**  
Create utility classes or component variants for these cases. The honeypot `style="display: none;"` is acceptable for accessibility/anti-spam purposes.

---

### Issue 4.2 – `pass` statements in test assertions

**File:** `tests/blocks/test_hero_blocks.py` (lines 21, 43)

**What's wrong:**  
Test functions end with `pass` after incomplete validation:

```python
def test_hero_cta_block_validation():
    # ... setup ...
    pass  # No actual assertion

def test_hero_cta_defaults():
    # ... setup ...
    pass  # No actual assertion
```

**Recommendation:**  
Either complete the assertions or remove/skip these placeholder tests. They currently provide no coverage value.

---

### Issue 4.3 – Duplicate `TrustStripBlock` alias in `__init__.py`

**File:** `core/sum_core/blocks/__init__.py` (lines 29-31)

**What's wrong:**  
Both `TrustStripBlock` (from content.py) and `TrustStripLogosBlock` (alias for trust.py's `TrustStripBlock`) are exported:

```python
from .trust import (
    TrustStripItemBlock,
    TrustStripBlock as TrustStripLogosBlock,  # Aliased to avoid collision
    ...
)
```

This is intentional but may cause confusion. Consider renaming the content.py version to `TrustTextStripBlock` or similar for clarity.

---

### Issue 4.4 – Missing `debug` statement in test

**File:** `tests/blocks/test_form_blocks.py` (line 33)

**What's wrong:**  
Debug print statement left in test code:
```python
print(f"DEBUG: child_blocks keys: {stream_block.child_blocks.keys()}")
```

**Recommendation:**  
Remove debug prints from tests. Use pytest's `-v` flag or logging if debug output is needed.

---

### Issue 4.5 – TODO comments indicate incomplete work

**File:** `core/sum_core/static/sum_core/css/components.comparison.css` (lines 45, 69)

**What's wrong:**  
TODO comments indicate known technical debt:
```css
/* TODO: Consider tokenizing this border color for theming */
/* TODO: Consider tokenizing slider handle colors */
```

**Recommendation:**  
Address these during the token compliance fix (Issue 3.3). The TODOs can then be removed.

---

## 5) Test Suite Review

### Strengths

- **Coverage:** 91% overall coverage is excellent for early development.
- **Structure:** Tests are well-organized by domain (blocks/, branding/, pages/, templates/).
- **Key areas covered:**
  - Block structure validation ✓
  - SiteSettings persistence and cache invalidation ✓
  - Theme preset application ✓
  - Template rendering with branding hooks ✓
  - Page creation and StreamField integration ✓
  - FAQ schema generation ✓

### Weaknesses / Missing Tests

1. **Form submission flows:** `ContactFormBlock` and `QuoteRequestFormBlock` have structure tests but no actual submission tests. This is a P0 area (lead capture) per the Test Strategy.

2. **No negative/edge-case tests for blocks:**
   - What happens with empty `ctas` list in HeroImageBlock?
   - What happens with rating=0 or rating=6 in TestimonialBlock?
   - Malformed hex colors in SiteSettings?

3. **No migration tests:** No tests verify that migrations are safe or reversible.

### Proposed Additional Tests (Priority Order)

1. **Form submission integration test** – Verify contact form POST creates lead (when leads module is implemented).
2. **Invalid SiteSettings input test** – Verify malformed hex colors (#GGG) are handled gracefully.
3. **Block rendering with missing optional fields** – Verify templates don't error with `None` values.

---

## 6) Design System & CSS Compliance

### Token Compliance Status

| Component | Status | Notes |
|-----------|--------|-------|
| `tokens.css` | ✅ Clean | Single source of truth |
| `layout.css` | ✅ Clean | All tokens used correctly |
| `typography.css` | ✅ Clean | Proper type scale |
| `components.hero.css` | ✅ Clean | |
| `components.services.css` | ✅ Clean | Good token usage |
| `components.testimonials.css` | ✅ Clean | |
| `components.gallery.css` | ✅ Clean | |
| `components.comparison.css` | ⚠️ Issues | Hardcoded colors (see Issue 3.3) |
| `components.forms.css` | ✅ Clean | |

### Template Token Compliance

| Template | Status | Notes |
|----------|--------|-------|
| `base.html` | ✅ Clean | Proper asset loading order |
| `standard_page.html` | ✅ Clean | Uses typography classes |
| `home_page.html` | ✅ Clean | Uses typography classes |
| `contact_form.html` | ⚠️ Minor | Inline style override |
| `header.html` | ⚠️ Minor | Inline styles on logo/menu |

### Branding System Health

The branding system is **well-implemented**:
- HSL-based color injection works correctly
- Font preconnect and Google Fonts loading is optimized
- Cache invalidation on SiteSettings save is implemented
- Theme presets align with PRD Table C.5

---

## 7) Suggested Refactors / Tech Debt Notes

### 7.1 [FUTURE] Extract `has_hero_block` to shared mixin
**Impact:** Medium | **Effort:** Low  
Prevents inconsistency as more page types are added. Create `sum_core/pages/mixins.py`.

### 7.2 [FUTURE] Create utility classes for common inline style patterns
**Impact:** Low | **Effort:** Low  
Add `.text-left`, `.max-width-none` utilities to avoid template inline styles.

### 7.3 [FUTURE] Consider consolidating HeroBlock types
**Impact:** Medium | **Effort:** Medium  
Currently three hero block types exist (`HeroImageBlock`, `HeroGradientBlock`, `HeroBlock`). The `HeroBlock` in content.py appears to be a legacy pattern. Consider deprecating in favor of the newer hero.py implementations.

---

## 8) Questions / Clarifications

1. **Leads module status:** `sum_core/leads/__init__.py` is empty. Is lead capture planned for M2 or later? The form blocks reference a `form_type` meta attribute but there's no backend to receive submissions.

2. **SEO module status:** `sum_core/seo/__init__.py` is empty. Are SEO mixins planned? The PRD mentions SEO fields on pages.

3. **Analytics module status:** `sum_core/analytics/__init__.py` is empty. Is this placeholder for GA4/tracking integration?

4. **Test database isolation:** The two failing tests suggest possible database state pollution between tests. Should we add `@pytest.fixture` for test page cleanup?

5. **HeroBlock deprecation:** Should `HeroBlock` (content.py) be removed in favor of `HeroImageBlock`/`HeroGradientBlock`? It's marked as "Legacy Sections" in PageStreamBlock.

---

*Report generated by AI Code Review Agent following the SUM Platform review template.*

