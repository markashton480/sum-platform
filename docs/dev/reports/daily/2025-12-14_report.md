# Daily Code Review Report: 2025-12-14

**Reviewed by:** Claude (Daily Code Reviewer)
**Review Date:** 2025-12-14
**Scope:** Tasks M3-006 ‚Üí M3-012 and M4-001 ‚Üí M4-004
**Code Quality:** Strong overall, some critical issues identified

---

## 1. High-Level Summary

Today's session covered **significant ground**, completing Milestone 3 (Lead Management) and making good progress into Milestone 4 (Analytics & SEO). The work represents **8+ major tasks** with substantial complexity.

**Overall Health:**

- ‚úÖ **Strong architectural foundation**: "No lost leads" invariant properly implemented with status tracking
- ‚úÖ **Good separation of concerns**: Attribution logic, form handling, and async tasks are cleanly separated
- ‚úÖ **Solid test coverage**: Comprehensive test suite including failure modes and edge cases
- ‚ö†Ô∏è **Some technical debt introduced**: Inline JS in templates, potential security gaps, missing error handling in places

**Blocking vs Nice-to-Fix:**

- **1 Blocker**: CSRF vulnerability in form templates
- **3 High-priority issues**: Missing security validations, hardcoded values, potential race conditions
- **Several polish items**: Code duplication, inconsistent patterns, missing type safety

**Technical Issues Noted:**

- Tests were removed by agents during development but were reinstated (good recovery)
- Issues with Leads not showing in Wagtail Admin (resolved via M3-012)
- Forms not submitting initially (resolved)

---

## 2. Critical / Blocking Issues (must fix before merge or very soon)

### [SEVERITY: BLOCKER] CSRF Token Exposure in Template Comments

**Files:**
- `core/sum_core/templates/sum_core/blocks/contact_form.html:136`
- `core/sum_core/templates/sum_core/blocks/quote_request_form.html` (likely similar)

**What's wrong:**

The inline JavaScript in form templates includes a template variable inside a string literal:
```javascript
messagesDiv.innerHTML = '<p class="form-success-msg">{{ self.success_message|default:"Thanks, we\'ll be in touch shortly." }}</p>';
```

This creates a **Django template rendering inside JavaScript string**, which:
1. Breaks if success_message contains quotes/special chars (XSS vector)
2. Makes the template harder to maintain
3. Violates CSP if you add one later

**Why it matters:**

- **Security risk**: If `self.success_message` contains user-controlled content (unlikely but possible via admin), this is an XSS vulnerability
- **Deployment risk**: Breaks production if strict Content Security Policy is enabled
- **Test Strategy violation**: Inline HTML/JS in form flows is called out as a risk area

**Concrete fix:**

Option 1 (Recommended): Move success/error messages into data attributes:
```html
<form ... data-success-msg="{{ self.success_message|default:'Thanks...' }}" data-error-msg="Something went wrong">
```
```javascript
var successMsg = form.dataset.successMsg;
messagesDiv.innerHTML = '<p class="form-success-msg">' + successMsg + '</p>';
```

Option 2: Use a hidden div with the message and clone it:
```html
<div class="form-success-template" style="display:none;">
  <p class="form-success-msg">{{ self.success_message|default:"Thanks..." }}</p>
</div>
```

---

### [SEVERITY: BLOCKER] Missing Email Validation in Form Submission Handler

**File:** `core/sum_core/forms/views.py:154-183`

**What's wrong:**

The `_validate_submission` method checks if email is **present** but doesn't validate if it's a **valid email**:

```python
for field, error_msg in required_fields.items():
    value = data.get(field, "").strip()
    if not value:
        errors[field] = [error_msg]
```

This allows `email="asdf"` to pass validation and create a Lead with invalid email, which will:
- Cause email notification to fail silently or bounce
- Pollute the Lead database with bad data
- Break integrations that expect valid emails

**Why it matters:**

- **Data integrity**: PRD requires valid contact information for lead qualification
- **Integration risk**: Zapier webhooks and email notifications assume valid emails
- **Test Strategy**: Form validation is explicitly called out as P0 testing area

**Concrete fix:**

Add email format validation:
```python
from django.core.validators import validate_email
from django.core.exceptions import ValidationError

def _validate_submission(self, data: dict, config: FormConfiguration) -> dict:
    errors: dict[str, list[str]] = {}

    # ... existing required field checks ...

    # Email format validation
    email = data.get('email', '').strip()
    if email:  # Only validate if present (presence already checked above)
        try:
            validate_email(email)
        except ValidationError:
            errors['email'] = ['Please enter a valid email address']

    return errors
```

---

## 3. Important Issues (should be scheduled soon)

### [SEVERITY: HIGH] Potential Race Condition in Lead Status Updates

**File:** `core/sum_core/leads/tasks.py:115-190` (email task) and `213-335` (webhook task)

**What's wrong:**

The Celery tasks update Lead status fields without database-level locking:
```python
lead = Lead.objects.get(id=lead_id)
if lead.email_status == EmailStatus.SENT:
    return
# ... later ...
lead.email_status = EmailStatus.SENT
lead.save(update_fields=[...])
```

If two task instances run concurrently (due to retry + new trigger), you could have:
1. Task A reads status=PENDING
2. Task B reads status=PENDING
3. Both send email
4. Both mark as SENT

This violates idempotency claims and could cause duplicate emails.

**Why it matters:**

- **Operational risk**: Users receive duplicate lead notifications
- **Test Strategy**: Async + retries + failure semantics are "where platforms get real" (M3-010 task notes)
- **No lost leads invariant**: While this doesn't lose leads, it undermines trust in the system

**Concrete fix:**

Use `select_for_update()` for status transitions:
```python
lead = Lead.objects.select_for_update().get(id=lead_id)
if lead.email_status == EmailStatus.SENT:
    logger.info(f"Lead {lead_id} email already sent (locked check), skipping")
    return
```

**Trade-off warning**: This adds DB lock contention, but email/webhook tasks are low-volume, so acceptable.

---

### [SEVERITY: HIGH] Hardcoded Cache TTL in Navigation System

**File:** `core/sum_core/navigation/templatetags/navigation_tags.py:42`

**What's wrong:**

```python
CACHE_TTL_DEFAULT = 3600  # 1 hour in seconds
```

Navigation caching uses a 1-hour TTL, but:
- No documentation on why 1 hour was chosen
- No ability to bust cache on-demand from admin (other than waiting for signals)
- `get_cache_ttl()` reads from settings but has no corresponding setting in docs

If a client updates their header navigation and it doesn't appear for an hour, they'll file a bug.

**Why it matters:**

- **User experience**: Editors expect immediate visibility of navigation changes
- **Design drift**: SSOT doesn't specify cache duration; this was an implementation decision
- **Ops burden**: Support calls when "changes don't appear"

**Concrete fix:**

1. **Short-term**: Reduce TTL to 5 minutes (300s) for M4:
   ```python
   CACHE_TTL_DEFAULT = 300  # 5 minutes - balance between freshness and performance
   ```

2. **Medium-term**: Add cache-bust button in Wagtail admin for HeaderNavigation/FooterNavigation using `wagtail_hooks` and a custom view

3. **Long-term**: Consider cache versioning (bump version on save) instead of TTL-based invalidation

---

### [SEVERITY: HIGH] Missing Phone Number Validation

**File:** `core/sum_core/forms/views.py:154-183`

**What's wrong:**

Phone field is optional and unvalidated. While optional is correct per SSOT, **no format validation** means:
- `phone="abc123"` is accepted
- `phone="' OR 1=1--"` is accepted (SQL injection not a risk due to ORM, but still bad data)
- Zapier webhook consumers may fail parsing

**Why it matters:**

- **Data quality**: Phone numbers are used for callbacks and SMS integrations
- **Integration risk**: Downstream systems expect E.164 or national formats
- **Future feature blocker**: Can't add click-to-call or SMS features without data cleanup

**Concrete fix:**

Add optional phone validation using `phonenumbers` library (already in many Django projects):
```python
import phonenumbers

def _validate_submission(self, data: dict, config: FormConfiguration) -> dict:
    # ... existing validation ...

    phone = data.get('phone', '').strip()
    if phone:  # Only validate if provided
        try:
            parsed = phonenumbers.parse(phone, 'GB')  # Default to GB, or make configurable
            if not phonenumbers.is_valid_number(parsed):
                errors['phone'] = ['Please enter a valid phone number']
        except phonenumbers.NumberParseException:
            errors['phone'] = ['Please enter a valid phone number']
```

**Alternative if you want to avoid dependency**: Use simple regex for UK numbers:
```python
import re
UK_PHONE_REGEX = re.compile(r'^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$')
if phone and not UK_PHONE_REGEX.match(phone):
    errors['phone'] = ['Please enter a valid UK mobile number']
```

---

## 4. Minor Issues / Polish

### [MINOR] Code Duplication in Attribution Detail Building

**Files:**
- `core/sum_core/leads/attribution.py:54-58` (rule-based detail)
- `core/sum_core/leads/attribution.py:123-124` (default detail)

**Issue:**

Campaign detail formatting is duplicated:
```python
# In _match_lead_source_rules:
if campaign:
    detail_parts.append(f"campaign={campaign}")

# In _apply_ssot_defaults:
detail = f"campaign={utm_campaign}" if utm_campaign else ""
```

**Fix:**

Extract to helper:
```python
def _format_campaign_detail(campaign: str) -> str:
    return f"campaign={campaign}" if campaign else ""
```

---

### [MINOR] Inconsistent String Building Patterns

**File:** `core/sum_core/leads/attribution.py:155-162`

**Issue:**

Some detail strings use list joining, others use ternary:
```python
# Pattern 1: list joining
detail_parts = []
if utm_source:
    detail_parts.append(f"utm_source={utm_source}")
return "unknown", "; ".join(detail_parts)

# Pattern 2: ternary (elsewhere)
detail = f"campaign={campaign}" if campaign else ""
```

Pick one pattern and use consistently.

---

### [MINOR] Missing Docstring for `LeadSourceRule.matches()`

**File:** `core/sum_core/leads/models.py:271-287`

**Issue:**

Public method lacks docstring explaining matching semantics:
```python
def matches(self, *, utm_source: str, utm_medium: str, referrer_url: str) -> bool:
    """Check if this rule matches the given attribution values."""
```

Should document:
- All rule fields must match (AND logic)
- Empty rule fields are wildcards
- Matching is case-insensitive
- Returns False if rule is inactive

---

### [MINOR] Magic Number in Task Retry Configuration

**File:** `core/sum_core/leads/tasks.py:27-29`

**Issue:**

```python
MAX_RETRIES = 3
RETRY_BACKOFF = 60  # Base backoff in seconds (60, 120, 240)
WEBHOOK_TIMEOUT = 10  # seconds
```

While documented via comments, these should be settings-driven for ops flexibility:
```python
MAX_RETRIES = getattr(settings, 'LEAD_NOTIFICATION_MAX_RETRIES', 3)
RETRY_BACKOFF = getattr(settings, 'LEAD_NOTIFICATION_RETRY_BACKOFF', 60)
```

---

### [MINOR] Unused Import in Event Tracking JS

**File:** `core/sum_core/static/sum_core/js/event_tracking.js:79`

**Issue:**

Variable `kind` is commented out but the comment is kept:
```javascript
// Optional: kind
// const kind = explicitCta.getAttribute('data-cta-kind');
```

Either implement `kind` in dataLayer push or remove the comment.

---

## 5. Test Suite Review

### Strengths

‚úÖ **Comprehensive coverage**: Attribution tests cover SSOT defaults + custom rules
‚úÖ **Failure mode testing**: M3-010 explicitly tests email/webhook/Celery failures
‚úÖ **Isolation**: `clear_lead_source_rules` fixture ensures test independence
‚úÖ **Integration tests**: Form submission ‚Üí Lead creation ‚Üí async tasks flow is tested

### Concerns

‚ö†Ô∏è **Form template JS not tested**: Inline submission handling has no automated tests
‚ö†Ô∏è **Navigation cache invalidation**: No tests for signal-based cache busting
‚ö†Ô∏è **CSV export**: No mention of tests for quote escaping, unicode, or large datasets

### Missing Tests (prioritize for next session)

1. **CRITICAL**: Email/phone validation in form submission
   - Test: `test_invalid_email_rejected`
   - Test: `test_malformed_phone_rejected`

2. **HIGH**: Concurrent task execution (race condition scenario)
   - Test: `test_duplicate_email_tasks_only_send_once`
   - Mock: Use `@patch('celery.app.task.Task.apply_async')` to simulate concurrent starts

3. **MEDIUM**: Event tracking selector logic
   - Since no JS test runner exists, document manual test scenarios or add Playwright suite in M5

### Test Posture: **Strengthened**

Today's changes **improved** test posture:
- Lead submission handler has edge case coverage
- Attribution derivation is thoroughly tested
- Failure modes are explicitly validated

However, frontend validation and concurrent execution remain **underested**.

---

## 6. Design System & CSS Compliance

### ‚úÖ Good Practices Observed

- **Header CSS** (`components.header.css`): Excellent use of design tokens
  - `var(--space-6)`, `var(--ease-smooth)`, `hsla(var(--primary), 1)` throughout
  - No magic hex values or hardcoded pixel spacing
  - Proper semantic class naming (`.nav-item`, `.header.scrolled`)

- **Button styles**: Reuse existing `.btn`, `.btn-primary` tokens

### ‚ùå Token Violations Found

None identified! CSS changes consistently use the token system.

### ‚ö†Ô∏è Potential Future Drift

**Inline styles in templates**:
- `contact_form.html:7` - `style="text-align: left; max-width: none;"`

**Why this matters:**
- Bypasses design token system
- Creates one-off overrides that compound over time

**Recommendation:**

Replace inline styles with utility classes or component modifiers:
```html
<!-- Instead of: -->
<header class="section__header" style="text-align: left; max-width: none;">

<!-- Use: -->
<header class="section__header section__header--left section__header--full-width">
```

Add to `components.forms.css`:
```css
.section__header--left {
  text-align: left;
}
.section__header--full-width {
  max-width: none;
}
```

---

## 7. Suggested Refactors / Tech Debt Notes

### 1. Extract Form Submission JS to Shared Module

**Current state:**
`contact_form.html` and `quote_request_form.html` have **~60 lines of duplicated inline JavaScript** for AJAX submission.

**Future improvement:**
Create `core/sum_core/static/sum_core/js/form_submission.js` with:
```javascript
function initFormSubmission(formId, options) {
  // Shared AJAX submit handler
}
```

Then in templates:
```html
<script src="{% static 'sum_core/js/form_submission.js' %}" defer></script>
<script>
  initFormSubmission('contact-form', {
    successMsg: "{{ self.success_message|default:'Thanks...' }}"
  });
</script>
```

**Benefit:**
- Reduces template size
- Enables proper JS testing
- Fixes CSP violations from inline scripts

---

### 2. Consider Adding `Lead.full_clean()` Validation

**Current state:**
Lead model has field validations (max_length, EmailField) but they're only enforced at **form level**, not model level.

**Gap:**
If a Lead is created programmatically (tests, management commands, shell), validations are bypassed:
```python
Lead.objects.create(email="not-an-email")  # Succeeds!
```

**Future improvement:**
Override `Lead.save()` to call `full_clean()`:
```python
def save(self, *args, **kwargs):
    if not kwargs.pop('skip_validation', False):
        self.full_clean()
    super().save(*args, **kwargs)
```

**Trade-off:**
Adds validation overhead but prevents bad data from backdoor entry points.

---

### 3. Unify Phone Number Formatting

**Current state:**
`core/sum_core/utils/contact.py` has `normalize_phone_href()` for `tel:` links, but:
- Not used for phone validation
- Not used for display formatting
- Not used in Lead model cleaning

**Future improvement:**
Create `PhoneNumberField` custom field or add model method:
```python
@property
def phone_formatted(self) -> str:
    """Return phone in display format: +44 7XXX XXX XXX"""
    return format_phone_number(self.phone)

@property
def phone_href(self) -> str:
    """Return phone as tel: link"""
    return normalize_phone_href(self.phone)
```

**Benefit:**
Centralizes phone handling, makes templates cleaner.

---

## 8. Questions / Clarifications

### Q1: Lead Notification Email - HTML vs Plain Text?

**Context:**
M3-010 delivered plain text email templates:
- `lead_notification_subject.txt`
- `lead_notification_body.txt`

Task notes mention "Optional HTML variant (only if you want): `lead_notification_body.html`"

**Question:**
Do clients expect **HTML emails** with branding, or is plain text intentional for operational notifications?

**Impact:**
- If HTML is expected, need to add template + update `send_mail()` to `EmailMultiAlternatives`
- If plain text is correct, document this decision in task notes/SSOT

---

### Q2: Webhook Authentication/Signing?

**Context:**
`send_lead_webhook` task posts JSON to `ZAPIER_WEBHOOK_URL` with no authentication:
```python
response = requests.post(webhook_url, json=payload, timeout=10, headers={'Content-Type': 'application/json'})
```

**Question:**
Should webhook payloads be:
1. **Signed** (HMAC signature in header for verification)?
2. **Include API key** in header or payload?
3. **Use Zapier's built-in webhook secret** verification?

**Impact:**
- Without signing, anyone who discovers the webhook URL can send fake leads
- Zapier supports webhook signature verification (optional but recommended)

**Recommendation:**
Add webhook signing in next task:
```python
import hmac, hashlib

secret = settings.WEBHOOK_SECRET
signature = hmac.new(secret.encode(), json.dumps(payload).encode(), hashlib.sha256).hexdigest()
headers = {
    'Content-Type': 'application/json',
    'X-Webhook-Signature': signature
}
```

---

### Q3: Navigation Cache - When Does It Invalidate for Multi-Site?

**Context:**
`navigation/cache.py` has signal handlers for page publish/unpublish that call:
```python
sites = _get_sites_for_page(instance)
for site in sites:
    invalidate_nav_cache(site.id)
```

**Question:**
If a page is published that's linked in **multiple site** navigations (e.g., shared "About Us" page), does the current implementation correctly invalidate **all affected sites** or just the page's primary site?

**Gap I see:**
`_get_sites_for_page()` finds sites by walking up to root page and matching `Site.root_page`. This only returns the site(s) that **own** this page tree, not sites that **link to** this page in their navigation.

**Scenario:**
- Site A has root page "Site A Home"
- Site B has root page "Site B Home"
- Site A's header links to a page under Site B
- That page is edited
- Signal fires ‚Üí only Site B cache is invalidated
- Site A still shows stale nav for up to 1 hour

**Question:**
Is cross-site navigation linking supported? If yes, cache invalidation needs to be expanded.

---

### Q4: CSV Export - Special Character Handling?

**Context:**
M3-009 implemented CSV export for Leads, but I don't see the implementation code in the review scope.

**Question:**
Does the CSV export properly handle:
- Commas in name/message fields (quoted)?
- Newlines in message field (escaped or quoted)?
- Unicode characters (UTF-8 BOM for Excel compatibility)?

**Recommendation:**
Verify CSV generation uses `csv.writer` with proper quoting:
```python
import csv
from io import StringIO

output = StringIO()
writer = csv.writer(output, quoting=csv.QUOTE_MINIMAL)
writer.writerow(['Name', 'Email', 'Message'])
for lead in leads:
    writer.writerow([lead.name, lead.email, lead.message])
```

---

### Q5: M4-004 SEO Tags - Where's the Implementation?

**Context:**
Task M4-004 is listed as completed, but I don't see:
- `core/sum_core/seo/templatetags/seo_tags.py`
- Changes to base template for `{% render_meta %}`

**Question:**
Was M4-004 **fully implemented** or just **designed/documented**?

If not implemented, it should be moved to "in progress" for tomorrow.

---

## Summary & Recommendations

### Today's Achievements ‚úÖ

- Completed full Lead Management stack (M3-007 ‚Üí M3-012)
- Implemented Analytics foundation (M4-001 ‚Üí M4-003)
- Strong test coverage for core flows
- Maintained design token compliance
- Successfully recovered from test removal incident

### Must Fix Before Production üö®

1. **CSRF/XSS in form templates** - Move messages to data attributes
2. **Email validation** - Add Django validator
3. **Lead task race conditions** - Add `select_for_update()`

### Recommended Next Steps üìã

1. **Tomorrow AM**: Fix blocker issues (2-3 hours)
2. **Tomorrow PM**: Add missing validation tests
3. **Next session**: Extract inline JS to shared modules
4. **Before M4 complete**: Reduce nav cache TTL, add webhook signing

### Code Quality Grade: **B+**

Strong architectural decisions and test coverage, but production-readiness requires addressing the identified blockers and high-priority issues. The "no lost leads" invariant is correctly implemented, which is the critical success criterion for this milestone.

---

**End of Report**
