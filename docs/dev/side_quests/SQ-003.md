# **[SQ-003]: Showroom “canonical theme source” settings override (dev hot-reload)**

## **Objective**

Enable the **showroom** client project to render templates + static assets from the **canonical theme source directory** (e.g. repo-level `themes/<theme_slug>/…`) instead of the **copied** `clients/<client>/theme/active/…`, so theme development is fast + stable (edit canonical theme files → refresh browser → see changes).

This directly addresses the “old face, new skin” problem by letting you iterate on the *real* theme templates/partials that should ultimately ship.

Target Django installation: `clients/showroom/`

---

## **Context**

Right now, the platform’s resolved approach is that themes are copied into each client project at init time, and the client runs from `theme/active`. 

Theme architecture explicitly acknowledges an “optional source” (canonical theme repository) separate from `clients/<client>/theme/active`, and also describes a dev override mechanism (`SUM_THEME_PATH`) for resolving themes outside the standard location. 

Current wiring in client settings is oriented around:

* `BASE_DIR / "theme" / "active" / "templates"`
* `BASE_DIR / "theme" / "active" / "static"`

…being wired into `TEMPLATES` + `STATICFILES_DIRS`. 

We now have a permanent showroom project (seeded via `seed_showroom`) and need a *settings-level* switch so it can “point back” at canonical themes for development without changing the production model. 

---

## **Technical Requirements**

### 1) Add a dev-only “canonical theme root” override (settings)

Implement an opt-in settings override that:

* Defaults to current behaviour (run from `BASE_DIR/theme/active`)
* When enabled, **prefers** canonical theme dirs for:

  * **Templates** (e.g. canonical `templates/`)
  * **Static files** (e.g. canonical `static/`)
* Is **safe-by-default** (only enabled in dev / explicitly opted in)

**Recommended env var interface (proposed):**

* `SUM_CANONICAL_THEME_ROOT` = absolute path to the canonical theme directory (the folder that contains `templates/` + `static/`).

  * Example: `/home/mark/workspaces/sum-platform/themes/theme_a`
* Optional: `SUM_CANONICAL_THEME_ENABLED=1` (if you want belt + braces), but not required if presence of `SUM_CANONICAL_THEME_ROOT` is sufficient.

**Behaviour rules:**

* If `SUM_CANONICAL_THEME_ROOT` is set:

  * Validate it exists and contains at least `templates/` (static optional but recommended).
  * Prepend its `templates/` to `TEMPLATES[0]["DIRS"]` **ahead of** the copied `theme/active/templates`.
  * Prepend its `static/` to `STATICFILES_DIRS` **ahead of** copied `theme/active/static`.
* If invalid/missing dirs:

  * Raise `django.core.exceptions.ImproperlyConfigured` with a clear message:

    * what was provided
    * what layout is expected (`<root>/templates`, `<root>/static`)
    * how to disable (unset env var)

This keeps the existing theme distribution method intact (copy into client on init) while giving the showroom a dev “escape hatch.”

### 2) Apply it to all relevant boilerplate copies

This setting must be updated in **all copies that matter**, so generated projects don’t drift:

* `boilerplate/project_name/.../settings*.py` (canonical boilerplate)
* `cli/sum_cli/boilerplate/project_name/.../settings*.py` (CLI copy)
* `clients/showroom/.../settings*.py` (the committed showroom project, if it exists in repo)

(Exact paths may differ; agent must locate the file that currently wires `theme/active` into templates/static based on `BASE_DIR` per the wiring inventory. )

### 3) Developer UX: document how to enable it for showroom

Update the showroom dev docs to include:

* The env var name(s)
* A concrete example for Mark’s workstation
* A quick verification snippet (see Acceptance Criteria)

This likely belongs alongside existing showroom docs (the SQ-002 follow-up referenced `docs/dev/SHOWROOM.md`). 

---

## **Design Specifications**

N/A (settings + developer workflow change only).

---

## **Implementation Guidelines**

Follow the repo’s module header comment requirement for any modified Python settings module (even if it’s a “settings file”). 

**Implementation notes (strong recommendations):**

* Use `pathlib.Path` for path operations.
* Keep the override logic in a small helper function inside the settings module (or a tiny `settings_utils.py` if you’re already using one).
* Avoid silently ignoring bad paths. Fail fast; devs *want* misconfig to be loud.

---

## **Acceptance Criteria**

### **Functional**

* [ ] With no env var set, showroom behaves exactly as today (runs from copied `theme/active`).
* [ ] With `SUM_CANONICAL_THEME_ROOT` set to a valid canonical theme directory:

  * [ ] `theme/base.html` resolves from the canonical theme directory (not `clients/showroom/theme/active`).
  * [ ] Static assets (at least the theme CSS bundle) resolve from canonical theme static dir.
  * [ ] Editing a canonical theme template file reflects on browser refresh without recopy/re-init.

**Verification commands (must work):**

1. Print resolved template origin:

```bash
python manage.py shell -c "from django.template.loader import get_template; t=get_template('theme/base.html'); print(t.origin.name)"
```

2. (Optional) confirm a block template is resolving from canonical as well:

```bash
python manage.py shell -c "from django.template.loader import get_template; t=get_template('sum_core/blocks/faq.html'); print(t.origin.name)"
```

### **Code Quality**

* [ ] No unrelated refactors.
* [ ] Clear error messages for invalid canonical theme roots.
* [ ] Boilerplate + CLI boilerplate remain in sync.

### **Testing**

Per test strategy, changed behaviour must be covered, and CI quality gates must be respected (pytest, coverage thresholds, etc.).

Minimum required tests:

* [ ] Update `cli/tests/test_theme_init.py` to assert the generated settings include the new canonical override block (similar to how SQ-002 added assertions for the generated management command).
* [ ] If there’s an existing test harness for boilerplate content, update that too (or add a focused test to prevent drift).

Tests should explicitly check for:

* presence of `SUM_CANONICAL_THEME_ROOT`
* insertion order (canonical before `theme/active`)
* `ImproperlyConfigured` behaviour if path invalid (unit test if feasible; otherwise at least documented + asserted in code)

---

## **Work Report Evidence**

Agent must file work report in `SQ-003_followup.md`:

* What files were changed (all boilerplate copies + showroom)
* Commands run locally:

  * `pytest ...`
  * (if appropriate) `sum init ...` smoke check or a minimal Django startup check
* A screenshot or pasted output of the `get_template(...).origin.name` command showing canonical resolution

---

## **Notes / Guardrails**

* This is a *dev workflow* capability, not a new production distribution method. The default “copy theme into client project” model remains the standard. 
* Don’t introduce new CLI flags in SQ-003. Keep it settings/env driven to avoid scope creep.
* Prefer *one* env var that is easy to reason about and doesn’t conflict with the CLI’s `SUM_THEME_PATH` semantics (which are about theme resolution during init). 
