**[M3-012] Fix Wagtail “Leads” admin registration + resolve frontend form submit failure (manual flow parity)**

**Context** (from current manual testing results)

- Manual testing shows:

  - `/forms/submit/` returns **HTTP 405** on GET, indicating the URL exists but is POST-only (expected).
  - Frontend form submission fails (error shown to user).
  - In Wagtail admin, **“Lead Source Rules” is visible** but **“Leads” is missing**.

- This indicates the Lead persistence stack is likely present, but:

  1. the **Leads admin UI (ModelViewSet)** is not being registered/discovered at runtime, and/or
  2. the form submit POST is failing due to **CSRF / validation / server error**, preventing Lead creation.

**Goal**
Restore **manual flow parity** with the automated test expectations:

- Frontend form successfully POSTs
- Lead is created
- “Leads” appears in Wagtail admin
- Lead can be inspected in admin

---

## Technical Requirements

### A) Ensure “Leads” is registered in Wagtail admin

Implement Wagtail hook-based registration so the “Leads” section appears reliably.

**Required outcome**

- Wagtail admin menu contains “Leads”
- Leads list + detail pages load without errors

**Implementation approach (preferred)**

- Add a `wagtail_hooks.py` module under the leads app and register the Lead ModelViewSet via the appropriate hook.

**Files**

- Create: `core/sum_core/leads/wagtail_hooks.py`
- Confirm/adjust: `core/sum_core/leads/wagtail_admin.py` (Lead ModelViewSet exists and is importable)

**Hook to implement**

- Use `@hooks.register("register_admin_viewset")` and return an instance of the Lead viewset.

> Note: Don’t rely on “import side effects” from arbitrary modules; use Wagtail’s hook system so registration works consistently in all environments.

---

### B) Diagnose and fix frontend form submission POST failure

Identify the actual failure mode by inspecting the POST response.

**Required outcome**

- Submitting a valid Contact/Quote form succeeds from the browser.
- A `Lead` record is created for each valid submission.
- Submission failure responses are user-friendly and consistent.

**Likely failure causes to handle**

- **CSRF failure (403)**: ensure `{% csrf_token %}` is present and AJAX requests send `X-CSRFToken`.
- **Validation failure (400)**: ensure required fields (`form_type`, `name`, `email`, `message`, etc.) are actually included in the template POST payload.
- **Server error (500)**: fix exception root cause; ensure missing optional settings don’t hard-fail lead persistence.

**Files (expected touchpoints)**

- `core/sum_core/forms/views.py` (submission endpoint)
- `core/sum_core/templates/...` (form block templates)
- Any frontend JS used for AJAX submission (if present)

---

### C) Confirm leads are created even if admin UI is missing

Add a quick verification step in dev docs / tests (whichever fits your process):

- Confirm Lead creation by checking the database (Django shell) after a manual form submit.

This is not “new functionality”; it’s to ensure the issue isn’t being misdiagnosed as purely admin-related.

---

## Implementation Guidelines

**Required header comment (new Python modules)**

```python
"""
Name: Leads Wagtail hooks
Path: core/sum_core/leads/wagtail_hooks.py
Purpose: Register Leads admin viewsets in Wagtail so “Leads” appears in the admin UI.
Family: Lead management, admin UX.
Dependencies: Wagtail hooks, leads admin viewsets.
"""
```

**Operational notes**

- Keep the Wagtail hooks import lightweight (avoid importing heavy modules at import time unless needed).
- Prefer pure hook registration that returns viewset instances.

---

## Acceptance Criteria

1. **Wagtail admin shows “Leads”**

   - “Leads” appears in Wagtail sidebar.
   - Leads list loads.
   - Lead detail loads.

2. **Frontend form submission succeeds**

   - Submitting a valid form returns success (200 or the expected UX response).
   - A Lead record is created.

3. **Failure mode is understood and prevented**

   - If CSRF was the cause, it’s fixed and validated by re-test.
   - If validation was the cause, templates include required fields and errors are sane.
   - If 500 was the cause, exception is fixed and covered by a regression test.

4. **Regression coverage**

   - Add/update at least one test to prevent recurrence of the root cause found:

     - If admin registration: a test that asserts the Lead viewset is registered/URL resolves.
     - If CSRF/validation: integration test that posts realistic payload and asserts Lead creation.

5. **Quality gates**

   - `make test` passes
   - `make lint` passes
   - No unexpected migrations unless truly required

---

## Dependencies & Prerequisites

- Lead model + attribution + rules + admin scaffolding already exist from M3-006 → M3-010.
- Forms submission endpoint exists from M3-008 and is reachable (`/forms/submit/` responds 405 on GET, implying URL wiring exists).

---

## Testing Requirements

- Add/adjust tests aligned to the existing strategy:

  - Prefer integration-style tests for form submission (POST → Lead created).
  - If relevant, include negative cases (missing required fields → 400; CSRF missing → 403).
  - Keep tests isolated (MEDIA_ROOT temp dir if images are involved).

---

## Estimated Complexity

- **Time:** S–M
- **Risk:** Medium (admin registration and CSRF/AJAX issues are easy to fix but easy to regress)
