**[M3-011] Milestone 3 checkpoint: full code review + regression sweep + green test suite**

**Context** (from SSOT - Milestone 3 Done When)

- Milestone 3 “Done When” includes: form submissions create Leads with attribution, spam protection works, Lead admin list/detail with status workflow, CSV export works, email notifications send, Celery tasks exist, and **≥80% test coverage**.
- M3-009 and M3-010 transcripts show:

  - Lead admin is implemented via Wagtail ModelViewSet + permissions + CSV export, but admin UI tests have been fixture-brittle / not fully green.
  - M3-010 introduced Celery + notification tasks and adjusted tests around Celery retry behaviour in eager mode (a known sharp edge).

- Test Strategy explicitly requires “no lost leads” failure-mode coverage (SMTP/webhook/broker failures) and admin/permissions validation, with CI gates for lint/test/coverage.

**Goal of M3-011**
Create a **merge-ready, confidence checkpoint** for everything shipped in Milestone 3 + NAV so far, with a special focus on the high-risk Lead flow and admin UX, ensuring the suite is green and the invariants are intact.

---

## Technical Requirements (from SSOT + Test Strategy)

### A) Run and document the quality gates

Required commands (run locally in the standard dev environment):

- `make lint` (must pass)
- `make test` (must pass)
- `python manage.py makemigrations --check --dry-run` (must show no pending changes in the test project)
- Coverage: confirm project’s ≥80% bar remains satisfied (CI threshold).

**Deliverable:** short “checkpoint report” in Markdown (see Deliverables section below).

---

### B) Regression-sweep the P0 “No Lost Leads” flow

Verify and (if needed) correct the end-to-end behavioural chain:

**Happy path**

- GET a page with a form → POST valid submission → spam checks → Lead persisted → tasks queued → user receives success.

**Failure modes** (must be testable + green)

- Email sending exception (SMTP/backend failure)
- Webhook timeout / 5xx
- Celery broker unavailable / queueing failure
- Task raises during execution
  In all cases:
- Lead is still created
- Integration status/error fields are updated and visible in admin
- Errors are logged (Sentry later).

**Important note for reviewers**
Celery retries in eager mode are tricky; ensure tests validate “status updated on final failure” without relying on Celery’s internal retry loop semantics. (Your M3-010 transcript already flagged this as a gotcha.)

---

### C) Stabilise the Wagtail Lead admin tests (finish what M3-009 started)

The Wagtail Lead admin is core ops UX; tests must be reliable.

Ensure these are **green and not brittle**:

- Admin list loads for editor/admin users
- Permission policy behaves correctly:

  - Editors: view list/detail only
  - Admins: can update status + export CSV

- CSV export endpoint:

  - respects filter queryset
  - returns correctly escaped CSV

- No unexpected 302s due to URL mounting or permission codename mismatches

---

### D) Minimal manual smoke test (fast, high confidence)

In the test project:

1. Create a page with a Contact/Quote form.
2. Submit a Lead.
3. Confirm it appears in Wagtail Leads admin with correct fields + attribution.
4. Confirm integration statuses render without UI errors.
5. Confirm CSV export works for an admin user.

Keep this to a strict 10–15 minute run; record results in the checkpoint report.

---

## Implementation Guidelines

**Files to create/modify**

- `docs/dev/reports/M3/M3-011-checkpoint.md` (new): checkpoint report + outcomes + any follow-up actions
- Fixes may touch:

  - `tests/leads/test_lead_admin_wagtail.py` (fixture/URL/permission stability)
  - `core/sum_core/leads/services.py` / `wagtail_admin.py` (only if tests reveal real bugs)
  - `tests/leads/test_notification_tasks.py` (retry semantics stability)
  - `core/sum_core/forms/views.py` (queueing failure handling, if uncovered)

**Required header comment (if new Python modules are created)**
Use the project-standard header comment block (name/path/purpose/family/dependencies).

**Rules of engagement**

- Prefer fixing root causes (permissions codenames, URL mounting assumptions, fixture isolation) rather than loosening assertions.
- Do not remove tests unless they are provably dead/incorrect; if removing, document why in the checkpoint report.

---

## Acceptance Criteria

1. **All quality gates pass**

   - `make lint` ✅
   - `make test` ✅
   - `makemigrations --check --dry-run` ✅
   - Coverage threshold remains ≥80% ✅

2. **Lead P0 flow is verified**

   - Happy path passes in tests
   - Failure modes are covered and green, matching “no lost leads” requirements

3. **Wagtail Lead admin tests are stable**

   - No flaky permission/redirect behaviour
   - Editor/admin capabilities match SSOT requirements (view vs edit/export)

4. **Checkpoint report exists**

   - Includes command outputs summary (pass/fail)
   - Lists any residual known issues and clearly labels whether they block Milestone completion
   - Includes manual smoke test notes

---

## Dependencies & Prerequisites

- M3-006 → M3-010 implemented lead persistence, attribution, forms handler/spam protection, Wagtail admin, CSV, and notifications/Celery tasks.
- This task is explicitly motivated by remaining test gaps noted in M3-009 and lingering admin permission/URL test issues seen during M3-010 runs.

---

## Testing Requirements (from test-strategy-v1.1.md)

- Must align with “AI-assisted development rule”: a human-reviewed checkpoint on non-trivial behavioural changes, plus tests validated by a human.
- Integration tests must cover failure modes: SMTP, webhook, Celery/broker/task failure, while maintaining “Lead persists and statuses update” invariant.
- Admin & permissions tests must validate editor/admin split and CSV export.

---

## Estimated Complexity

- **Time:** M
- **Risk:** Medium (the code may be fine; the risk is hidden regressions + brittle tests around admin + Celery semantics)

---
