**[M3-009] Wagtail Lead Admin Interface + status workflow + CSV export (permissions-ready)**

**Context** (from SSOT - Milestone 3 + Lead Admin)

- Milestone 3 “Done When” explicitly includes: **Lead admin shows list/detail with status workflow** and **CSV export works**.
- SSOT defines the expected **Lead Admin Interface (Wagtail ModelAdmin)**: list columns, search, filters, inline status update, CSV export, and permissions split.
- Test Strategy calls out **Admin & permissions** as a critical integration area: Wagtail admin menus, filters/search, CSV export, and editor/admin permission differences.
- Current state: Leads exist with attribution + source derivation, and form submissions create Leads with spam protection working end-to-end.
- Note: M3-006 delivered a **Django admin** view for minimum viability, with an explicit follow-up suggested to migrate to a Wagtail-native admin.

---

## Technical Requirements (from SSOT + Test Strategy)

### A) Implement a Wagtail-native admin UI for `Lead`

Create a Wagtail admin surface for the `Lead` model that meets SSOT 8.5.

Minimum required features:

- **Menu item** in Wagtail admin (“Leads”)
- **List view columns** (at least): name, email, phone, `lead_source`, status, submitted date
- **Search**: name, email, phone, message
- **Filters**: status, `lead_source`, date range, `form_type`
- **Detail view**: readable lead content + attribution fields + raw JSON (`form_data`) in a pretty/structured display
- **Inline status update** from list or detail (whatever is simplest in your chosen Wagtail admin mechanism)

> Implementation approach: prefer Wagtail’s modern admin patterns (ViewSets / ModelViewSet / Snippets depending on your Wagtail version) rather than Django admin, to align with SSOT intent.

### B) CSV export

Implement “CSV export works” for Leads.

Minimum export requirements:

- Export respects the **current filtered queryset** (status/source/date/form_type)
- Includes sensible columns:

  - submitted_at, name, email, phone, message
  - form_type, status
  - lead_source, lead_source_detail
  - utm fields + landing/page/referrer URLs

- Handles commas/newlines safely (proper CSV quoting)

### C) Permissions split (Editors view, Admins edit/export)

Implement permission boundaries per SSOT: **Editors = view**, **Admins = view+edit+export**.

Minimum viable:

- Editors can access list + detail
- Only admins (or a specific permission group) can:

  - change status
  - export CSV

(How you implement this depends on whether you use Wagtail permissions, Django model permissions, or a combination—just ensure it’s testable.)

---

## Design Specifications

- No frontend website UI changes; this is Wagtail admin UX.
- Keep detail pages readable (group sections: Core details / Attribution / Raw payload).

---

## Implementation Guidelines

**Files to create/modify (expected)**

- `core/sum_core/leads/wagtail_admin.py` (or `admin.py` if you already centralize Wagtail admin registration there)
- `core/sum_core/leads/views.py` (if you implement custom export view or custom admin views)
- `core/sum_core/leads/urls.py` (if needed for export endpoints)
- `core/sum_core/leads/services.py`

  - optional helper for generating CSV rows from a queryset (keeps logic testable)

- Potentially adjust/remove Django admin registration if it becomes redundant (or keep it but treat Wagtail as primary)

**Required header comment (new modules)**

```python
"""
Name: Leads admin (Wagtail)
Path: core/sum_core/leads/wagtail_admin.py
Purpose: Provide Wagtail admin UI for Lead list/detail, status updates, and CSV export.
Family: Lead management, operations workflows.
Dependencies: Wagtail admin APIs, Lead model, attribution fields.
"""
```

**Implementation notes**

- Prefer **testable service functions**:

  - `build_lead_csv(queryset) -> str | bytes`
  - `can_user_export_leads(user) -> bool`

- Keep CSV export behind explicit permission checks (don’t rely on “security by menu hiding”).

---

## Acceptance Criteria

1. **Wagtail admin “Leads” section exists**

   - Appears in Wagtail menu.
   - Loads list view and detail view successfully.

2. **List view includes required UX**

   - Columns, search, filters (status/source/date/form_type) function as expected.

3. **Status workflow is operable**

   - Admin users can update status.
   - Editor users cannot update status.

4. **CSV export works**

   - Admins can export filtered leads.
   - Editors cannot export.
   - CSV includes all required fields and is correctly escaped/quoted.

5. **Quality gates**

   - `make test` passes (your suite is currently large and healthy; keep it green).
   - `make lint` passes.
   - Any migrations (if required by permission changes) are clean with `makemigrations --check --dry-run`.

---

## Dependencies & Prerequisites

- Lead model + attribution fields exist (M3-006/M3-007).
- Form submissions create Leads with spam protection (M3-008).
- If you keep the existing Django admin Lead view, it must not conflict with Wagtail permissions expectations (Wagtail is “source of truth” for operational workflow).

---

## Testing Requirements (from test-strategy-v1.1.md)

- **Integration tests**:

  - Admin user can view lead list + detail; can update status; can export CSV
  - Editor user can view lead list + detail; cannot update status; cannot export CSV

- **Unit tests**:

  - CSV generation (quoting, ordering, expected columns)
  - Permission helper functions (if used)

- Keep tests isolated (avoid state leakage; you already hit this once in M3-008 and fixed it properly).

---

## Estimated Complexity

- **Time:** M–L
- **Risk:** Medium (Wagtail admin APIs + permissions + export are easy to “mostly work” but need hard, testable guarantees)
