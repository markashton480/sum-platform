## **[M6-A-002]: Wire `sum init` Theme Copy + Add Theme-Aware `sum check` Validation**

### **Objective**

Update the **SUM CLI scaffolding flow** so that when a user runs:

- `sum init --theme theme_a <client_name>`

…the resulting client project contains a **fully runnable theme** under `clients/<client>/theme/active/` including **compiled Tailwind CSS** (no runtime Node requirement), and `sum check` validates the theme contract structurally (so missing/partial theme installs fail loudly).

This is the “platform factory” half of Theme Toolchain v1: **Theme A is now real; init/check must make it repeatable.**

---

### **Context**

**Business requirement excerpt**

- Milestone 6 requires “Theme system v1 (Tailwind-first, init-time selection)” and “prove the platform can deliver real sites safely with new presentation layer.”
- Themes are **fixed per site**, selected at `sum init` time (no admin switching).

**Relevant user story**

- As a platform maintainer, I want `sum init` to scaffold a client site that immediately renders correctly with the chosen theme, so I can deliver sites reliably without manual patching.

**Reference**

- `THEME-ARCHITECTURE-SPECv1.md` — client layout after init (`clients/<client>/theme/active/...`) and theme contract expectations.
- M6-A-001 established that Theme A now includes compiled Tailwind output and toolchain files.

---

## **Technical Requirements**

### 1) `sum init` must copy a complete, runnable theme

Implement/verify that `sum init --theme <slug>` copies the **theme root** into:

```
clients/<client>/
  theme/
    active/
      theme.json
      templates/...
      static/...
```

This layout is explicitly defined in the theme spec.

**Copy rules**

- Include **compiled CSS**: `static/theme_a/css/main.css` must be present in the client theme copy (Theme A’s compiled output).
- Include Tailwind source + config as maintainer tooling (ok to ship, but not required for runtime):

  - `static/theme_a/css/input.css`
  - `tailwind.config.js`, `postcss.config.js`
  - `package.json`, `npm-shrinkwrap.json`

- Exclude `node_modules/` (already globally ignored) and ensure the init copy doesn’t accidentally drag it in.

**Failure mode requirements**

- If the requested theme slug does not exist, `sum init` must error with a clear message and exit non-zero.
- If the theme exists but is missing critical files (e.g., no `theme.json`, no compiled CSS), `sum init` must fail fast (don’t scaffold a half-broken client).

### 2) `sum check` must validate the theme install (structural contract checks)

Extend `sum check` to validate (at minimum):

- `clients/<client>/theme/active/theme.json` exists and slug matches expected
- Theme base template exists: `templates/theme/base.html`
- Compiled CSS exists: `static/<theme_slug>/css/main.css` (Theme A path pattern)
- **Optional but strongly recommended:** validate that compiled CSS is “non-trivial” (size > 5KB) and does **not** reference `/static/sum_core/css/main.css` to prevent legacy bleed from reappearing. (M6-A-001 already enforces this in core tests; this is the “client install check”.)

`sum check` should return:

- ✅ pass with a concise summary, or
- ❌ fail with a short list of missing/invalid items and suggested fixes.

### 3) Theme selection must be recorded in the client project

Ensure the selected theme slug is recorded in the client’s config in whatever canonical place SUM uses (e.g., settings/env/template context). (If already present, verify it’s correct and used consistently.)

This supports the “themes are fixed per site” principle.

---

## **Design Specifications**

- No UI redesign; this is plumbing.
- Error messages must be “operator friendly”: tell the user exactly what is missing and what command/path to check.
- `sum check` output should stay succinct (no walls of text).

---

## **Implementation Guidelines**

### Files to create/modify (indicative)

You’ll likely touch:

- `sum` CLI init command implementation (copy logic)
- theme discovery/resolution logic (where themes are enumerated)
- `sum check` implementation and checks registry
- tests under `tests/` for init/check behaviour

### Required header comments

All new Python modules must include:

```python
"""
Name: <Module Name>
Path: <File path>
Purpose: <Brief description>
Family: SUM CLI / Platform Factory
Dependencies: sum_core themes, filesystem
"""
```

### Engineering notes

- Treat file operations as **transactional-ish**:

  - copy theme → validate → only then finalise scaffold
  - if failure, clean up partial directories where safe

- Avoid hardcoding theme_a paths beyond the slug-based pattern.

---

## **Acceptance Criteria**

1. `sum init --theme theme_a foo` creates `clients/foo/theme/active/` with:

   - `theme.json`
   - templates
   - `static/theme_a/css/main.css` (compiled CSS)

2. A fresh scaffolded site renders Theme A without running Node commands (runtime is static assets).
3. `sum check` fails if:

   - theme folder missing
   - `theme.json` missing
   - base template missing
   - compiled CSS missing or trivial

4. `sum check` passes on a correctly scaffolded site with Theme A.
5. Init fails cleanly (non-zero) on unknown theme slugs.

---

## **Dependencies & Prerequisites**

- **M6-A-001 complete** (Theme A ships compiled CSS + toolchain).
- Existing `sum init` and `sum check` from the Platform Factory milestone (M5) are already working baseline capabilities.

---

## **Testing Requirements** (from `test-strategy-v1.1.md`)

Follow requirements-based + risk-based coverage: each AC maps to tests; include positive + negative paths. Keep affected-module coverage ≥80%.

### Unit tests

- Theme resolver returns correct theme path by slug.
- Init copy function copies expected file sets, excludes `node_modules/`.
- `sum check` validators detect missing critical files.

### Integration tests

- Create a temp project dir, run init (invoke command entrypoint), assert filesystem layout.
- Run `sum check` against:

  - valid scaffold → passes
  - broken scaffold → fails with expected messages

### Manual checklist

- `sum init --theme theme_a foo`
- runserver
- confirm header styles apply (Tailwind utilities working)
- run `sum check` and confirm it reports healthy state

---

## **Estimated Complexity**

- **Time:** M
- **Risk:** Medium (factory wiring impacts every consumer)
- **Suggested Model:** GPT-5.2 (High complexity system wiring) / Claude Sonnet (if codebase is already very clean)

---
