# **[M6-A-003]: Theme Guardrails v1 — Prevent Compiled CSS Drift**

## **Objective**

Implement repo-level guardrails that prevent Theme A’s compiled Tailwind CSS from drifting or regressing **and** formally generate, store, and version the AI execution prompt used to implement those guardrails.

This task completes **Theme Toolchain v1** and its **PromptOps audit trail**.

---

## **Context**

- **M6-A-001**: Tailwind toolchain + compiled CSS shipped.
- **M6-A-002**: `sum init` / `sum check` validate client-installed theme.
- SUM requires **prompt artefacts to be first-class system assets**, with the same auditability as code and tests.

---

## **Scope (Explicit)**

This task delivers **three artefact classes**:

1. **Code** — guardrails + tests
2. **Prompt** — a generated AI execution prompt (stored, versioned)
3. **Evidence** — follow-up report referencing both

Failure to deliver **any one** of these means the task is **incomplete**.

---

## **Technical Requirements**

### 1) Build Fingerprint (MANDATORY)

Create a deterministic fingerprint representing all inputs that affect Tailwind output.

**Fingerprint inputs (exact):**

- `core/sum_core/themes/theme_a/tailwind.config.js`
- `core/sum_core/themes/theme_a/postcss.config.js` (handle absence)
- `core/sum_core/themes/theme_a/static/theme_a/css/input.css`
- `core/sum_core/themes/theme_a/templates/theme/**/*.html`

**Fingerprint output (committed):**

```
core/sum_core/themes/theme_a/static/theme_a/css/.build_fingerprint
```

**Rule**

- If inputs change and `.build_fingerprint` does not → tests fail.
- `main.css` must be rebuilt when inputs change.

---

### 2) Compiled CSS Validity Checks (MANDATORY)

Validate:

```
core/sum_core/themes/theme_a/static/theme_a/css/main.css
```

Checks:

- exists
- size > **5KB**
- contains Tailwind signatures:

  - `.flex{display:flex}`
  - `.hidden{display:none}`

- contains **no** legacy references:

  - `@import url("/static/sum_core/css/main.css")`
  - `/static/sum_core/css/main.css`

---

### 3) Test Integration

- Guardrails run via **`make test`**
- Failures must halt the suite
- Error output must specify:

  - rebuild CSS
  - regenerate fingerprint
  - commit both

---

### 4) Fingerprint Regeneration Command

Provide:

```bash
python -m sum_core.themes.theme_a.build_fingerprint
```

Must:

- recompute fingerprint
- overwrite `.build_fingerprint`
- exit non-zero on missing inputs

---

## **PromptOps Requirement (NON-OPTIONAL)**

### 5) AI Execution Prompt Generation (MANDATORY ARTEFACT)

This task **must generate and commit** the AI execution prompt used to implement the guardrails.

#### Prompt file

Create and commit:

```
docs/prompts/themes/M6-A-003-theme-guardrails.prompt.md
```

#### Prompt requirements

The prompt **must**:

- define agent role
- restate task objective
- list hard constraints
- list exact files to create/modify
- define acceptance criteria
- define definition of done
- forbid scope expansion

This is **not documentation** — it is an **execution contract**.

#### Audit requirements

- Prompt filename must reference **task ID**
- Prompt content must reference **task ID**
- Follow-up report must reference:

  - prompt path
  - commit hash containing the prompt

---

## **Implementation Guidelines**

### Files to Create / Modify

**Code**

- `core/sum_core/themes/theme_a/build_fingerprint.py`
- `tests/themes/test_theme_a_guardrails.py`
- `core/sum_core/themes/theme_a/static/theme_a/css/.build_fingerprint`

**Prompt**

- `docs/prompts/themes/M6-A-003-theme-guardrails.prompt.md`

---

### Required Header (new Python files)

```python
"""
Name: Theme A Guardrails
Path: <file path>
Purpose: Prevent compiled Tailwind CSS drift and regressions
Family: Themes / Toolchain
Dependencies: filesystem, hashlib, pytest
"""
```

---

## **Acceptance Criteria**

1. Guardrails fail when fingerprint inputs change without regeneration.
2. Guardrails fail for missing, trivial, or legacy-contaminated CSS.
3. Guardrails pass after rebuild + fingerprint regeneration.
4. Prompt file exists at the specified path and is committed.
5. Follow-up report references:

   - prompt file path
   - prompt commit hash

6. All checks run via `make test`.

---

## **Deliverables**

- Guardrail code + tests
- `.build_fingerprint`
- **AI execution prompt file**
- Follow-up report:

  ```
  docs/dev/M6/M6-A-003_followup.md
  ```

---

## **Dependencies**

- M6-A-001 complete
- M6-A-002 complete

---

## **Estimated Complexity**

- Time: **S–M**
- Risk: **Low**

---
