## **[M1-002] SiteSettings Model & `get_site_settings` Template Tag**

### Context (from PRD)

**Epic 2.6: Branding & Customisation**

#### US-BR01: Site Settings Model

> As an admin, I want to configure site branding so that each client site has unique styling.

Acceptance criteria:

* **AC1** – `SiteSettings` model using Wagtail Site Settings (P0)
* **AC2** – Colour fields: primary, secondary, accent, background, text colours (P0)
* **AC3** – Logo uploads: header logo, footer logo, favicon (P0)
* **AC4** – Typography: heading font, body font (Google Fonts dropdown) (P0)
* **AC5** – Business info: company name, tagline, phone, email, address, business hours (P0)
* **AC6** – Social links: Facebook, Instagram, LinkedIn, Twitter/X, YouTube, TikTok (P0)
* **AC7** – Settings accessible in all templates via `{% get_site_settings %}` tag (P0)
* **AC8** – Settings cached appropriately for performance (P0)

#### US-BR02: Dynamic CSS Generation (partial scope here)

> As a developer, I want CSS variables generated from branding settings so that styles update automatically.

For this ticket we **only** care about:

* AC1/AC2/AC5 of BR01 (data model)
* AC7 of BR01 (template access)
* Laying foundations for BR02 (we won’t implement `{% branding_css %}` yet, just the data and basic tag).

**Implementation Plan – Milestone 1:**
Milestone 1 core deliverables include:

* `SiteSettings` model with branding fields
* Template tags: `{% branding_css %}`, `{% branding_fonts %}`, `{% get_site_settings %}`

This task is about **BR01 AC1–AC7** and **the basic `{% get_site_settings %}` tag**. The CSS-generating tags will be a follow-up ticket.

---

### Technical Requirements

**Overall goal:**

Create a reusable `SiteSettings` model in `sum_core` and a template tag that exposes it cleanly to templates, ready for later use by `branding_css`, base templates, and components.

**1. App & module structure**

Under `core/sum_core/branding/`:

* `core/sum_core/branding/__init__.py` (already exists as a package)
* **Create** `core/sum_core/branding/models.py`
* **Create** `core/sum_core/branding/templatetags/branding_tags.py`

Ensure `sum_core` is already in `INSTALLED_APPS` in `test_project.settings` (it is from M0-002).

**2. SiteSettings model**

Implement a Wagtail Site Settings model using `wagtail.contrib.settings`:

* In `models.py`:

  ```python
  from wagtail.contrib.settings.models import BaseSiteSetting, register_setting
  from wagtail.models import Site
  from wagtail.images.models import Image
  from django.db import models
  ```

* Define `class SiteSettings(BaseSiteSetting):` with fields matching BR01 AC2–AC6:

  **Colour fields** (probably `CharField` with hex):

  * `primary_color`
  * `secondary_color`
  * `accent_color`
  * `background_color`
  * `text_color`
  * Optionally `surface_color`, `surface_elevated_color`, `text_light_color`, etc. for future mapping to tokens.

  **Logos & favicon**:

  * `header_logo = models.ForeignKey("wagtailimages.Image", null=True, blank=True, on_delete=models.SET_NULL, related_name="+")`
  * `footer_logo = models.ForeignKey("wagtailimages.Image", null=True, blank=True, on_delete=models.SET_NULL, related_name="+")`
  * `favicon = models.ForeignKey("wagtailimages.Image", null=True, blank=True, on_delete=models.SET_NULL, related_name="+")`

  **Typography:**

  * `heading_font = models.CharField(max_length=100, blank=True, help_text="Google Fonts family name for headings")`
  * `body_font = models.CharField(max_length=100, blank=True, help_text="Google Fonts family name for body text")`

  (Google Fonts dropdown UX will be largely about validation/help text for now; the actual `<link>` generation will come with `{% branding_fonts %}`.)

  **Business info:**

  * `company_name`, `tagline` – `CharField`
  * `phone_number`, `email` – `CharField` / `EmailField`
  * `address` – `TextField` or `CharField` with sensible length
  * `business_hours` – `TextField` for free-form entry

  **Social links:**

  * `facebook_url`, `instagram_url`, `linkedin_url`, `twitter_url`, `youtube_url`, `tiktok_url` – `URLField(blank=True)`

* Add standard meta / admin grouping:

  * Use Wagtail’s `panels` (or `field_panels` on older APIs) to group fields into logical sections: “Brand Colours”, “Logos & Favicon”, “Typography”, “Business Info”, “Social Links”.

* Decorate with `@register_setting` so it appears under **Settings → Site settings** in Wagtail admin for each Site.

**3. Header comments & type hints**

Every new Python file must include the header comment block, for example in `models.py`:

```python
"""
Name: Branding Site Settings
Path: core/sum_core/branding/models.py
Purpose: Provides Wagtail SiteSettings for branding and business configuration shared across client sites.
Family: Used by template tags and frontend templates (branding_css, branding_fonts, base layouts).
Dependencies: Django models, Wagtail settings framework, wagtailimages.
"""
```

Use type hints on all methods; model fields are fine as standard Django fields.

**4. `get_site_settings` template tag**

Create `branding_tags.py`:

* Inside `core/sum_core/branding/templatetags/branding_tags.py`:

  * Standard header comment.

  * Register a template library: `register = template.Library()`.

  * Implement a `@register.simple_tag(takes_context=True)`:

    ```python
    @register.simple_tag(takes_context=True)
    def get_site_settings(context: dict[str, Any]) -> SiteSettings:
        """
        Return the SiteSettings for the current request/site.

        Caches per-request to avoid repeated DB hits.
        """
    ```

  * Logic:

    * Extract `request` from context.
    * Use `Site.find_for_request(request)` to get the current Site.
    * Use `SiteSettings.for_site(site)` to retrieve settings.
    * Cache on `request` (e.g. `request._site_settings_cache`) to avoid multiple queries per render.

* Usage (to be used in future templates):

  ```django
  {% load branding_tags %}
  {% get_site_settings as site_settings %}
  {{ site_settings.company_name }}
  ```

> This satisfies **US-BR01 AC7** (“Settings accessible in all templates via `{% get_site_settings %}` tag”) for our codebase.

**5. Caching (performance)**

* **Per-request caching** in the template tag, as above, is required (meets BR01 AC8 in a basic form).
* We will later add more sophisticated caching at the level of `branding_css` / `branding_fonts` for production; for now, ensure:

  * Only one DB query for `SiteSettings` per request.
  * No global cache that would mix sites.

---

### Design Specifications

This ticket is **back-end focused**, but must respect what the base templates and CSS need later:

* Branding fields must cover:

  * Colours needed to drive tokens such as `--color-primary`, `--color-secondary`, `--color-accent`, `--color-background`, `--color-text`, etc.
  * Fonts to drive `--font-heading` and `--font-body`.
  * Logos and favicon used in header, footer, and `<head>` of base template.
  * Business info for footer/contact areas.
  * Social links for header/footer icons.

We’re not building any templates in this ticket, but we’re deciding what data will be available to them.

---

### Implementation Guidelines

**Files to create/modify**

* `core/sum_core/branding/models.py` – new
* `core/sum_core/branding/templatetags/branding_tags.py` – new
* `core/sum_core/branding/__init__.py` – may remain minimal but ensure package import works.
* `core/sum_core/test_project/test_project/settings.py` – ensure `wagtail.contrib.settings` is in `INSTALLED_APPS` (if not already).

**Patterns to follow**

* Use Wagtail’s current `BaseSiteSetting` / `register_setting` patterns.
* Keep public API stable and generic:

  * `SiteSettings` is the canonical object for branding.
  * `get_site_settings` is the single point of access in templates.

No changes to `main.css` or other static files in this ticket.

---

### Acceptance Criteria

* [ ] `SiteSettings` model exists in `core/sum_core/branding/models.py`, decorated with `@register_setting` and subclassing `BaseSiteSetting`.
* [ ] Model includes fields for:

  * Primary, secondary, accent, background, text colours.
  * Header logo, footer logo, favicon (image fields).
  * Heading and body font names.
  * Company name, tagline, phone, email, address, business hours.
  * Social URLs for Facebook, Instagram, LinkedIn, Twitter/X, YouTube, TikTok.
* [ ] Wagtail admin shows a **Site settings → Site settings** screen with these fields for each Site.
* [ ] Template tag `{% get_site_settings %}` is available via `{% load branding_tags %}` and returns the correct `SiteSettings` instance for the current Site.
* [ ] Template tag caches settings on the `request` object to avoid repeated DB hits per request.
* [ ] Existing `make lint` and `make test` still pass, and new tests for this feature are included (see below).

---

### Dependencies & Prerequisites

* Milestone 0 complete (repo, tooling, test project, sum_core package).
* **M1-001** (CSS token system) complete (which it is).
* `sum_core` already in `INSTALLED_APPS` of `test_project.settings`.

---

### Testing Requirements

**Unit tests**

Create tests in `core/sum_core/branding/tests/` (or `tests/branding/` under the root if you prefer, but keep them discoverable by pytest):

1. **Model test** – e.g. `test_site_settings_model.py`:

   * Create a `Site` (or use the default one).
   * Use `SiteSettings.for_site(site)` to create/populate an instance with sample data.
   * Assert fields are stored and retrieved correctly (e.g. `company_name`, colours, fonts).

2. **Template tag test** – e.g. `test_branding_tags.py`:

   * Use Django’s `RequestFactory` to create a request bound to a `Site`.

   * Render a simple template that does:

     ```django
     {% load branding_tags %}
     {% get_site_settings as ss %}
     {{ ss.company_name }}
     ```

   * Assert rendered output contains the expected `company_name`.

   * Assert that calling the tag twice in a single render doesn’t hit the DB twice (you can patch the manager or inspect query count).


