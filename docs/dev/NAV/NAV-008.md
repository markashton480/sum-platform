## NAV-008 — Navigation Documentation (Developer + Editor)

**Type:** Documentation
**Priority:** P1
**Status:** Ready
**Depends on:** NAV-003 → NAV-007 (settings, resolver, tags, caching/invalidation, template wiring, JS)

### Problem

Navigation is now functional end-to-end, but key knowledge is distributed across tickets and implementation history. Without a single canonical doc, future changes risk:

- breaking override/fallback behaviour (FooterNavigation vs SiteSettings)
- breaking caching/invalidation expectations
- reintroducing template logic drift
- repeating known pitfalls in tests and StreamField/ListBlock data setup

### Goal

Create a “Navigation Documentation” page that becomes part of the site’s overall documentation and serves as the **single source of truth** for:

- Editors: where/how to manage navigation in Wagtail
- Developers: architecture, template tags, caching/invalidation, template wiring, JS behaviour, testing patterns & pitfalls

---

## Scope

### In scope

1. Add a new doc markdown file in the repo.
2. Link to the existing `docs/dev/navigation-tags-reference.md` (don’t duplicate it; treat as an appendix/reference).
3. Document real implementation details:

   - Effective settings (override → fallback)
   - Tag caching keys + TTL + invalidation triggers
   - Where templates are wired (`base.html`, `includes/header.html`, `includes/footer.html`, `includes/sticky_cta.html`)
   - JS location/behaviour (`navigation.js`)
   - Testing notes, including the ListBlock data-shape pitfall and cache-related flakiness fix

### Out of scope

- Redesigning docs site / doc generator configuration
- Refactoring code (doc-only ticket)

---

## Implementation Tasks

### A) Create documentation file

**Create:** `docs/dev/NAV/navigation.md` (or `docs/dev/navigation.md` if that’s your canonical top-level pattern)

Include sections:

1. Overview (what this system does, what it doesn’t)
2. Editor guide (Wagtail Settings → Header Navigation / Footer Navigation, how to add menu items, link validation expectations)
3. Architecture (models → resolver → template tags → templates → JS)
4. Template tags overview (link to `docs/dev/navigation-tags-reference.md`)
5. Caching + invalidation (keys + TTL, what invalidates)
6. Template wiring (exact file paths)
7. JavaScript behaviour (what’s handled and what’s intentionally minimal)
8. Testing & pitfalls (ListBlock vs StreamBlock value shape; cache clearing/isolation in tests)
9. Extending safely (new social platform, new link_type, adding fields)

### B) Add doc entry to your docs index

Update whatever “docs table of contents” you use (README/index page in docs) to link to this new doc.

---

## Acceptance Criteria

- A single navigation documentation file exists and is discoverable from the docs index.
- It explicitly documents override/fallback, caching keys, invalidation triggers, and wiring locations.
- It links to (not duplicates) `docs/dev/navigation-tags-reference.md`.
- It includes a “Testing & gotchas” section that mentions:

  - ListBlock link item shape (no `{type, value}` wrapper)
  - cache-related test flakiness and how tests should clear cache/reset nav state

---

## Manual QA

1. Open the doc in GitHub and confirm headings render correctly and internal links work.
2. Confirm the doc matches actual file paths in the codebase as implemented in NAV-007 (header/footer/base/js).

---

# Draft: `docs/dev/NAV/navigation.md` (ready to paste)

````markdown
# Navigation System

This document explains how navigation works in SUM Core (header, footer, sticky CTA), including:

- Where editors manage navigation in Wagtail
- How developer wiring, caching, and invalidation work
- Common pitfalls (especially tests + nested block data)

For a detailed template tag API reference, see:

- docs/dev/navigation-tags-reference.md

---

## Editor guide (Wagtail)

Navigation is managed per-site under Wagtail **Settings**:

- **Header Navigation**
  - Controls primary menu structure, dropdowns, header CTA, and “show phone” toggle.
- **Footer Navigation**
  - Controls footer link sections and optional footer overrides (tagline/social).

### Adding a menu item (Header)

1. Wagtail Admin → Settings → Header Navigation
2. Add / edit “Menu Items”
3. For each item choose a link type and fill the required field (page/url/email/phone/anchor).
4. For dropdowns, add child items (submenu).

### Adding footer sections

1. Wagtail Admin → Settings → Footer Navigation
2. Add a “Link Section”
3. Add “links” within that section.

### Override behaviour (important)

Some fields exist both in Branding Site Settings and Footer Navigation.
Rule: Footer Navigation values **override** Branding **only if non-empty**.
If empty, the system falls back to Branding.

---

## Developer architecture (overview)

Flow of data:

1. Wagtail Settings Models

   - HeaderNavigation / FooterNavigation
   - Branding SiteSettings (company info, default tagline, default socials, phone)

2. Resolver layer (effective settings)

   - Merges Navigation + Branding using override → fallback precedence

3. Template tags

   - `header_nav`, `footer_nav`, `sticky_cta`
   - Produce stable context dicts for templates
   - Use caching (read-through)

4. Templates

   - Existing templates are wired to tags:
     - `core/sum_core/templates/sum_core/includes/header.html`
     - `core/sum_core/templates/sum_core/includes/footer.html`
     - `core/sum_core/templates/sum_core/includes/sticky_cta.html`
     - `core/sum_core/templates/sum_core/base.html`

5. JavaScript
   - `core/sum_core/static/sum_core/js/navigation.js`
   - Minimal behaviour for mobile menu and dropdown toggles (ARIA + Escape)

---

## Template tags

See full reference:

- docs/dev/navigation-tags-reference.md

In general:

- Templates should NOT read settings models directly.
- Templates should use the tag context to avoid duplication and preserve caching behaviour.

---

## Caching

The navigation tags use read-through caching, keyed by site:

- `nav:header:{site_id}`
- `nav:footer:{site_id}`
- `nav:sticky:{site_id}`

Default TTL: 1 hour (unless configured otherwise).

### Invalidation (when cache is cleared)

Navigation cache is invalidated on:

- Saving HeaderNavigation (header + sticky)
- Saving FooterNavigation (footer)
- Saving Branding SiteSettings (all nav keys)
- Publishing / unpublishing / deleting pages (site-scoped invalidation)

---

## Template wiring

These templates should use tag context:

### Header

File: `core/sum_core/templates/sum_core/includes/header.html`

- `{% header_nav as nav %}`
- Render `nav.menu_items`, dropdown children, CTA, phone (if enabled)
- Use `aria-current="page"` when `is_current` is true

### Footer

File: `core/sum_core/templates/sum_core/includes/footer.html`

- `{% footer_nav as footer %}`
- Render `footer.link_sections`, `footer.social`, `footer.business`, `footer.tagline`

### Sticky CTA

File: `core/sum_core/templates/sum_core/includes/sticky_cta.html`

- `{% sticky_cta as cta %}`
- If enabled, show phone and/or button CTAs

### Base

File: `core/sum_core/templates/sum_core/base.html`

- Includes header/footer and sticky CTA
- Loads `navigation.js`

---

## JavaScript behaviour

File: `core/sum_core/static/sum_core/js/navigation.js`

Intentionally minimal:

- Toggle mobile menu open/close
- Toggle dropdown submenu open/close
- Maintain basic ARIA state (`aria-expanded`, `aria-hidden`)
- Escape closes open states

This JS is written to be resilient:

- If expected elements aren’t present, it should fail gracefully.

---

## Testing & gotchas

### 1) ListBlock data shape (important)

Footer link sections contain a ListBlock of UniversalLinkBlock items.
When setting up test data (or assigning StreamField values directly),
**ListBlock items must be raw value dicts**, not `{type: ..., value: ...}` wrappers.

Correct (inside `links: [...]`):

```python
{
  "link_type": "url",
  "url": "https://example.com/about/",
  "link_text": "About Us",
}
```
````

Incorrect:

```python
{
  "type": "link",
  "value": {...}
}
```

### 2) Cache-related test flakiness

Navigation tags cache results; tests that depend on settings changes must isolate cache.
Approaches:

- Use an autouse fixture that calls `cache.clear()` before/after each test in relevant modules
- Explicitly reset navigation override state (e.g. ensure FooterNavigation.tagline is blank when testing branding fallback)

---

## Extending safely

### Adding a new social platform

1. Decide canonical key name (e.g. `threads`)
2. Add to Branding (default) and/or FooterNavigation (override)
3. Update effective footer settings resolver to include it (override → fallback)
4. Update footer tag output and template rendering logic

### Adding a new link type

1. Update UniversalLinkBlock/value logic
2. Update validation rules
3. Update `_extract_link_data` fallback for dict values
4. Add tests covering the new type

---

## Quick troubleshooting

- “Nav didn’t update after saving settings”

  - Check invalidation signal wiring and cache backend

- “Footer links show as `#`”

  - Check link value extraction and test data shape

- “Fallback tagline not showing”

  - Ensure footer override field is blank (override wins when non-empty)
  - Check cached footer tag output

```

```
