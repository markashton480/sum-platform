## NAV-007 — Wire navigation settings into existing header/footer templates (and add minimal nav JS)

### Summary

Replace any hard-coded / legacy header+footer navigation rendering in the existing templates with the new navigation context provided by `{% header_nav as nav %}`, `{% footer_nav as footer %}`, and `{% sticky_cta as cta %}`.

This keeps your current front-end structure and CSS intact, while making the header/footer fully driven by the Wagtail settings models implemented in NAV-003/4 and exposed via template tags in NAV-005/6.

### Why this is needed

- Header/footer templates exist today, but aren’t wired to the new navigation system.
- We need a single source of truth: **navigation settings → template tags → templates**.
- This also reduces the “duplication” risk you flagged: templates should prefer the **effective** nav context (already merges overrides/fallbacks) instead of reaching directly into overlapping site settings fields.

### Type

Feature

### Priority

High

### Status

Completed

### Dependencies

- NAV-003 / NAV-004 (settings models + effective settings logic)
- NAV-005 (template tags return context dicts)
- NAV-006 (cache key helpers + invalidation wiring)
- Existing templates at:

  - `core/sum_core/templates/sum_core/includes/header.html`
  - `core/sum_core/templates/sum_core/includes/footer.html`
  - `core/sum_core/templates/sum_core/base.html`

---

## References

- `navigation-tags-reference.md` - usage guide for template tags. If in doubt, check here.

## Scope

### In scope

1. **Header template wiring**

   - Use `{% header_nav as nav %}` to render:

     - Main menu items + dropdown children
     - “active/current” state (including `aria-current="page"` where appropriate)
     - Optional phone display (if header supports it)
     - Optional header CTA button (if header supports it)

   - Keep existing markup/CSS hooks wherever possible (don’t redesign header).

2. **Footer template wiring**

   - Use `{% footer_nav as footer %}` to render:

     - Tagline
     - Link sections (2–4 sections)
     - Social links (only render those populated)
     - Business info (if your footer currently shows it)
     - Copyright

   - Keep existing layout/CSS hooks wherever possible.

3. **Sticky CTA**

   - Use `{% sticky_cta as cta %}` and render a sticky mobile CTA (if enabled).
   - Add it to `base.html` so it appears site-wide.

4. **Minimal JavaScript**

   - Add minimal JS to support mobile menu toggle + dropdown toggle behaviour, using existing markup if present.

### Out of scope (explicitly)

- Visual redesign of header/footer
- Perfect focus-trap implementation / animations (nice-to-have later)
- Removing legacy site settings fields (that’s a separate cleanup/migration decision)

---

## Implementation Requirements

### A) Update `core/sum_core/templates/sum_core/includes/header.html`

1. **Load template tags**

   ```django
   {% load navigation_tags %}
   ```

2. **Fetch nav context**

   ```django
   {% header_nav as nav %}
   ```

3. **Render menu items**

   - Loop `nav.menu_items`
   - For each item:

     - Use `item.href` and `item.label`
     - Apply active state:

       - If `item.is_current` (preferred) then `aria-current="page"`
       - Else if `item.is_active` apply your existing “active” class/state

     - If `item.has_children`, render children list using `item.children`

4. **Render link attributes safely**

   - Items include an `attrs` dict (e.g. `target`, `rel`). Render like:

     ```django
     {% for k,v in item.attrs.items %} {{ k }}="{{ v|escape }}"{% endfor %}
     ```

   - Do the same for child items and header CTA.

5. **Phone + header CTA**

   - If your header has slots for these:

     - Phone: `nav.show_phone`, `nav.phone_number`, `nav.phone_href`
     - CTA: `nav.header_cta.enabled`, `nav.header_cta.text`, `nav.header_cta.href`, `nav.header_cta.attrs`

6. **Do not remove existing logo/branding rendering**

   - Leave your current logo/business-name logic alone unless it’s clearly intended to be replaced.

> Important: header.html already appears to contain accessible menu state attributes (e.g. `aria-expanded`). Keep that structure and just drive its _links/content_ from `nav`.

---

### B) Update `core/sum_core/templates/sum_core/includes/footer.html`

1. **Load template tags**

   ```django
   {% load navigation_tags %}
   ```

2. **Fetch footer context**

   ```django
   {% footer_nav as footer %}
   ```

3. **Render tagline**

   - `footer.tagline` (only if present)

4. **Render link sections**

   - Loop `footer.link_sections` (each section should have `title` and `links`)
   - For each link use `link.href`, `link.text` and `link.attrs`

5. **Render social links**

   - `footer.social` is a dict with canonical keys (facebook/instagram/linkedin/youtube/x/tiktok)
   - Only render icons/anchors for populated URLs

6. **Render business info**

   - Prefer using `footer.business` (if provided by the tag context) rather than pulling directly from overlapping site settings in-template.

7. **Render copyright**

   - Use `footer.copyright.rendered` (supports placeholders like `{year}`, `{company_name}`)

---

### C) Update `core/sum_core/templates/sum_core/base.html`

1. Ensure it includes existing header/footer includes (don’t rename paths).
2. Add sticky CTA include (site-wide), e.g. near the end of `<body>`:

   ```django
   {% load navigation_tags %}
   {% sticky_cta as cta %}
   {% if cta.enabled %}
     {# render sticky CTA markup here or include a small include file #}
   {% endif %}
   ```

If you prefer cleaner structure, create:

- `core/sum_core/templates/sum_core/includes/sticky_cta.html`
  and include it from base.

---

### D) Add minimal JS (new file)

Create:

- `core/sum_core/static/sum_core/js/navigation.js`

Behaviour:

- Mobile menu toggle:

  - Toggle `aria-expanded` on the trigger button
  - Toggle `aria-hidden` (or a CSS class) on the mobile menu container

- Dropdown toggle (for items with children):

  - Toggle `aria-expanded` on the dropdown button
  - Show/hide submenu container

- Escape key closes any open menu/dropdown

Then ensure `base.html` loads it (where other scripts are loaded today).

> Keep JS minimal and resilient: if elements aren’t present, exit gracefully.

---

## Automated Tests

### Required

- Update/add a lightweight template render test so we know wiring doesn’t crash when settings are empty.

  - Render a page using `sum_core/base.html` with a request context and confirm status ok / template renders.

### Optional (nice)

- If you already have tests around base template inclusion, update assertions to account for sticky CTA being present (when enabled).

---

## Acceptance Criteria

- Header renders menu items from **HeaderNavigation** via `{% header_nav as nav %}`.
- Footer renders link sections/social/tagline/copyright from **FooterNavigation** via `{% footer_nav as footer %}`.
- Active page state is reflected (CSS class and/or `aria-current="page"`).
- External/new-tab attributes are correctly applied to rendered anchors.
- Sticky CTA renders on mobile when enabled via `{% sticky_cta as cta %}`.
- No duplication introduced: templates should _prefer_ the nav tag context over directly reading overlapping legacy site settings.
- No visual redesign: existing CSS hooks continue to work.

---

## Manual QA Steps

### 1) Validate editor UX for link types (the “where exactly?” bit)

In Wagtail Admin:

1. Go to **Settings → Header Navigation** (for the current Site).
2. In **Menu Items**, click **Add menu item**.
3. Inside the menu item, find the **Link** (UniversalLinkBlock) and change **link_type**:

   - `page`, `url`, `email`, `phone`, `anchor`

4. For each `link_type`, **leave the required field blank**, click **Save**.
5. Confirm the correct validation error appears **on the missing required field** (e.g. missing URL, missing page, etc.).
6. Repeat the same process under **Settings → Footer Navigation** for links inside **Link Sections**.

### 2) Frontend verification (happy paths)

1. Configure:

   - Header menu with 1 item + 1 dropdown with children
   - Footer with 2 link sections + at least 1 social link
   - Enable sticky CTA with button + phone (if available in settings)

2. Load the frontend:

   - Header links match configured destinations
   - Dropdown opens/closes and is keyboard accessible (basic tab/enter)
   - Active page highlights correctly
   - Footer sections/social render correctly
   - Sticky CTA appears only when enabled

3. Toggle mobile menu and dropdowns; confirm `aria-expanded` changes and Escape closes open menus.
