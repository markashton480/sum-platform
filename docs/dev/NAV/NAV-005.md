## NAV-005 — Implement Navigation Template Tags (header_nav, footer_nav, sticky_cta) + Read-through Caching

**Type:** Feature
**Priority:** P0
**Status:** Ready
**Depends on:**

- NAV-001 (`UniversalLinkBlock`)
- NAV-003 (HeaderNavigation/FooterNavigation models)
- NAV-004 (effective settings resolver services)

### Problem

We need a consistent rendering pipeline where templates receive a clean, site-scoped context for header, footer, and sticky CTA. Logic must not leak into templates, and repeated requests must be fast via caching.

### Goal

Create template tags:

- `{% header_nav %}`
- `{% footer_nav %}`
- `{% sticky_cta %}`

They must:

1. Return predictable context dictionaries (built from navigation models + NAV-004 resolver).
2. Include active-page detection metadata.
3. Use read-through caching with site-specific keys and configurable TTL.

---

## Scope

### In scope

- Implement tags module and register tags.
- Build context dicts matching the spec’s expected shape.
- Read-through cache in the tags (get→build→set).
- Unit tests for context shape, active detection, and cache usage.

### Out of scope (next tickets)

- Cache invalidation signals (NAV-006)
- Base templates/HTML structure/ARIA (NAV-007)
- JS behaviour (mobile menu toggle, focus trap, Escape key) (later)

---

## Implementation Tasks

### A) Create template tags module

**Create files:**

- `core/sum_core/navigation/templatetags/__init__.py`
- `core/sum_core/navigation/templatetags/navigation_tags.py`

Implement 3 tags (prefer `@register.inclusion_tag(..., takes_context=True)` per spec task list).

### B) Implement `header_nav` tag

**Requirements (context output):**
Return a dict shaped like the spec example:

- `menu_items`: list of:

  - `label`
  - `href`
  - `is_external`
  - `attrs` (dict)
  - `attrs_str` (optional convenience)
  - `is_active` (True for current section)
  - `is_current` (True only for exact current page match)
  - `has_children`
  - `children`: list of submenu item dicts with same link metadata

- `show_phone` (from HeaderNavigation)
- `phone_number` (from NAV-004 resolver; only if show_phone True)
- `phone_href` (`tel:` normalised/cleaned)
- `header_cta`: dict:

  - `enabled`
  - `text`
  - `href`
  - `attrs`

- `current_page`: pass-through of the current page object if available (from request context)

**Active detection logic (minimum):**

- Determine current page (from `context.get("page")` or request routing).
- For _page-type_ links:

  - `is_current`: current page == linked page
  - `is_active`: current page is the linked page OR a descendant of it (section highlighting)

- For non-page links:

  - `is_current/is_active` can be path comparison (`request.path == href`) when safe, otherwise False.

**Data source:**

- Use `HeaderNavigation.for_request(request)` plus NAV-004 `get_effective_header_settings(...)` for phone + CTA.

### C) Implement `sticky_cta` tag

Return dict matching the spec’s sticky CTA acceptance needs:

- `enabled`
- `phone_enabled`
- `phone_number`
- `phone_href`
- `button_enabled`
- `button_text`
- `button_href`
- `button_attrs`

Use NAV-004 `get_effective_header_settings(...)` for toggles + CTA link resolution.

### D) Implement `footer_nav` tag

Return dict consistent with Footer requirements:

- `tagline` (from NAV-004 effective footer)
- `link_sections`: list of:

  - `title`
  - `links`: list of link dicts (label/text, href, attrs, is_external, opens_new_tab, etc.)

- `social`: canonical dict keys `facebook/instagram/linkedin/youtube/x/tiktok` (from NAV-004 effective footer)
- `business`: include `company_name`, `phone_number`, `email`, `address` when available (from NAV-004 resolver)
- `copyright`:

  - Provide `raw` and `rendered`
  - `rendered` must replace `{year}` and `{company_name}` placeholders using current year and effective company name.

### E) Read-through caching in tags

Implement caching inside tag functions (or via a small helper inside the module for now):

- Cache keys (must match spec):

  - `nav:header:{site_id}`
  - `nav:footer:{site_id}`
  - `nav:sticky:{site_id}`

- TTL: configurable, default 3600s (1 hour).
- On cache miss: build dict → store → return
- On cache hit: return cached dict
- Must gracefully fall back to DB if cache fails.

> Note: invalidation triggers (signals on save/publish) are explicitly deferred to NAV-006.

---

## Tests

**Create:** `tests/navigation/test_templatetags.py` (consistent with existing test layout)

Minimum tests (as per spec task list):

- `test_header_nav_returns_context` (structure + expected keys)
- `test_header_nav_active_detection` (page + descendant behaviour)
- `test_footer_nav_returns_context` (sections + social + business keys)
- `test_sticky_cta_returns_context` (toggles + hrefs)
- `test_tag_uses_cache` (second call returns cached content / builder not re-run)

---

## Acceptance Criteria

1. `{% header_nav %}`, `{% footer_nav %}`, `{% sticky_cta %}` exist and return stable context dicts aligned with spec examples.
2. Active page detection marks menu items appropriately (`is_active`, `is_current`).
3. Tags use site-specific cache keys and TTL default 1 hour.
4. Footer output supports `{year}` and `{company_name}` placeholders.
5. Unit tests pass.

---

## Manual QA

1. In any base template, load the tags and render them (temporary debug print or JSON dump is fine):

   - Confirm header context includes menu items, CTA, phone fields.
   - Confirm footer context includes sections, socials, business info, rendered copyright.

2. Hit the same page twice and confirm the second hit is served from cache (e.g., by temporarily logging “cache hit/miss” in the tag during development).
