## NAV-010 — Nested Menus (2-Level Dropdown + Mobile Accordion)

**Type:** Feature
**Priority:** P0
**Status:** Ready
**Depends on:** NAV-009 (so we’re building nested support on a stable base)

### Problem

Current navigation supports only one dropdown level (`MenuItemBlock.children`). We need **nested menus** (submenu items that can themselves have children) before we consider NAV complete.

### Goal

Add **2-level nested menu support** across:

- data model (blocks + settings)
- context build (template tags)
- templates (header/mobile menu)
- JS behaviour (nested toggles)
- tests (including graceful behaviour when deeper nesting is absent)

---

### Scope

#### In scope

- Introduce a second level of children (top-level → submenu → subsubmenu)
- Render nested structure desktop + mobile
- Correct ARIA attributes and keyboard basics for nested toggles
- Ensure active/current state propagates to all ancestors
- Ensure caching works (base tree cached; active overlay per request)

#### Out of scope

- Unlimited depth (keep to 2-level for now)
- Styling overhaul (keep existing CSS hooks)

---

### Implementation Tasks

#### A) Extend navigation blocks to support a second level

**Modify:** `core/sum_core/navigation/blocks.py`

Add a new block for second-level items (clean and avoids recursive Wagtail block complexity):

- `SubSubmenuItemBlock` (fields: `label`, `link`)
- Update `SubmenuItemBlock` to include:

  - `children = ListBlock(SubSubmenuItemBlock, required=False, max_num=8)` (recommend max 8 for symmetry)

Update `MenuItemBlock` unchanged except it now indirectly supports nesting.

**Update tests:** `tests/navigation/test_menu_blocks.py`

- Enforce new max constraint for submenu children.

#### B) Update header/footer settings wiring if needed

Likely no model change required (settings store StreamField values; blocks enforce shape).
But verify migrations are not required unless block definitions are referenced in migrations.

#### C) Update template tag builder to build nested trees

**Modify:** `core/sum_core/navigation/templatetags/navigation_tags.py`

- Update menu extraction/build so it recursively includes:

  - `children` for submenu items as well

- Update active/current logic:

  - A parent `is_active` if it is current/active OR any descendant is active

- Ensure cached base data includes enough stable info to compute active states without extra DB calls (e.g., store `page_id` for page-type links if needed).

Add tests in `tests/navigation/test_templatetags.py`:

- 2-level nested menu structure output test
- active state propagation test:

  - current page matches a subsubmenu link → submenu and top-level become `is_active=True`

#### D) Update templates to render nested structure

**Modify existing templates (not new ones):**

- `core/sum_core/templates/sum_core/includes/header.html`

Render:

- top-level items
- submenu lists
- within submenu item, render subsubmenu list if present

ARIA expectations:

- Each toggle button has:

  - `aria-expanded="false"`
  - `aria-controls="submenu-<id>"`

- Each submenu container:

  - `aria-hidden="true"` and hidden when collapsed

#### E) Update JS to handle nested toggles

**Modify:** `core/sum_core/static/sum_core/js/navigation.js`

- Support multiple toggle levels using data attributes (e.g. `data-nav-toggle`)
- Ensure Escape closes:

  - current open submenu
  - mobile drawer if open

- Ensure `aria-expanded` stays in sync across nested toggles

#### F) Add “fail gracefully” coverage

Add a test that ensures:

- if submenu children are absent, rendering still works
- if link data is malformed, tag returns safe defaults (optional but recommended based on review gaps)

---

### Acceptance Criteria

- Editors can add:

  - top-level menu items
  - submenu items
  - subsubmenu items (second-level)

- Header renders nested structure correctly.
- Mobile menu can expand/collapse nested levels.
- Active state propagates upward (subsubmenu active → submenu + top-level active).
- Cached base data still used; active overlay remains per-request.
- Tests cover nested structure + active propagation.

---

### Manual QA

1. In **Settings → Header Navigation**, create:

   - Top-level item A → submenu item A1 → subsubmenu item A1a

2. Visit the page linked by A1a:

   - A and A1 should appear active, and A1a current.

3. Mobile:

   - Open drawer → expand A → expand A1 → see A1a
   - Escape closes current open level; Escape again closes drawer.
