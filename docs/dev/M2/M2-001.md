## [M2-001] Base Block Infrastructure & HomePage StreamField

> **Implementation Plan mapping:** `BLOCKS-001 – Base Block Infrastructure` (Milestone 2: StreamField Blocks)

---

### Task Card (Implementation Plan Template)

**Task ID**: M2-001 (BLOCKS-001 – Base Block Infrastructure)

**Title**: Base StreamField Block Infrastructure & HomePage Wiring

**Goal**:
Establish the core `sum_core.blocks` module, define a canonical page StreamField block, and wire it into the test project `HomePage` so we have a proven end-to-end block pipeline (admin → database → templates → CSS design system).

**Workstream**:
3 – **StreamField Blocks** (Reusable content blocks, per Implementation Plan Workstreams table)

**Milestone**:
2 – **StreamField Blocks**

---

### Inputs Required

**PRD Section(s)** (business + UX requirements)

* **2.3 Epic: StreamField Blocks (US-B01–US-B09)**
  Defines all required block families (Hero, ServiceCards, Testimonials, CTA, Trust, Process, Gallery, Content, Forms) and their acceptance criteria, e.g.:

  * Hero blocks with configurable headline, subheadline and 0–2 CTA buttons.
  * Content blocks including `RichTextBlock`, `QuoteBlock`, `ButtonGroupBlock`, `SpacerBlock`, `DividerBlock`, `ImageBlock`.
  * `RichTextBlock` explicitly **disallows H1** and restricts formatting to H2–H4, lists, links, bold/italic.
* **6.6 Design Implementation Guardrails**

  * All colours, typography, spacing, radii and shadows **must come from CSS variables / tokens**, no inline hex, arbitrary pixel values, or custom shadows.
  * AI-generated templates/blocks must reuse existing components and match the `premium-trade-website-v3-final.html` reference, while maintaining accessibility and spacing rules.

**Tech / Implementation Plan Section(s)**

* **Implementation Plan v1.0 – “Milestone 2 – StreamField Blocks”**

  * Goal: implement all PRD blocks with templates using design tokens and unit tests.
  * “Done When”: all blocks render correctly in admin preview, use design tokens exclusively, and have documented `Meta.template` paths.
* **Implementation Plan v1.0 – Workstreams Table**

  * Workstream 3 (“StreamField Blocks”): key deliverable is “All PRD blocks with templates and validation”, dependent on Design System being complete.

**Test Strategy Section(s)**

* **Test Strategy v1.1 – 3.1 In Scope**
  StreamField blocks (Hero, ServiceCards, Testimonials, CTA, Trust, Stats, Process, FAQ, Gallery, Content, Forms) are in **P0 scope** with high test depth.
* **Testing Pyramid & Coverage Targets**
  Blocks sit at the **unit test layer** with high coverage, plus integration tests around page rendering and block combinations.

**Initiation Packet Section(s)**

* **2.1 Repository Structure (Monorepo)** – core layout:

  * `core/sum_core/blocks/` with per-feature modules: `hero.py`, `services.py`, `testimonials.py`, `cta.py`, `trust_strip.py`, `stats.py`, `process_steps.py`, `faq.py`, `gallery.py`, `content.py`, plus `__init__.py` as the export surface. 
  * `core/sum_core/templates/sum_core/blocks/` for block templates (e.g. hero variants).
* **5.4 Sprint 2: StreamField Blocks** – mirrors PRD block list and emphasizes flexible, editor-friendly blocks for homepage and service pages.

**Design References**

* **SolarCraft Premium – Design System 2.0** (`design_system.md`)

  * “Frame, not the paint”: premium feel comes from structure, spacing, and materiality, not specific colours.
  * HSL token system: derive palette from a single brand colour; everything goes through tokens like `--primary`, `--surface-tint`, `--text-main`.
  * Layout & spacing rules (“Breath”, “Pinky”, “Gallery”), editorial typography sizing, and elevation/glass patterns. 
* **Premium Trade HTML reference** (`premium-trade-website-v3-final.html`)

  * Concrete reference for hero layout, trust strip, cards, CTA bands, spacing and how tokens/classnames map to markup. 

**Dependencies**

* Milestone 0 (repo, tooling, test project) complete.
* Milestone 1 (design system, base templates, SiteSettings/branding tags) complete — tokens & layout shell must already be in place.
* DB + migrations working (Postgres via Docker for dev, or SQLite fallback).

---

### Context (from PRD – business requirement & user perspective)

* Content editors need to assemble **entire homepages and service pages** via StreamField blocks, without developer involvement, while still landing on a tightly controlled premium layout.
* Blocks must be **reusable, composable and brand-agnostic**: hero sections, trust strips, services grids, testimonials etc. should be built from a common underlying block infrastructure and rendered with CSS tokens.
* This task is the **first step for that system**: instead of dropping directly into specific block families (Hero, ServiceCards, etc.), we first define:

  * A canonical **page StreamField block** (the “body schema”).
  * A **module layout** and naming conventions for `sum_core.blocks`.
  * A **template pattern** for block HTML that sits neatly on top of the existing base layout and CSS tokens.

---

### Technical Requirements (from plan + current codebase)

**Architecture & Module Layout**

* Create/standardise the **`sum_core.blocks` package**:

  * `core/sum_core/blocks/__init__.py`

    * Acts as the **public export surface** for blocks used by page models.
    * Must expose a canonical StreamBlock class for page content, e.g. `PageStreamBlock`.
    * Re-export internal block classes from their modules as they are added (hero, services, etc), but for this task we focus on the core base block(s).

  * `core/sum_core/blocks/base.py`

    * Defines **foundational block classes**:

      * `PageStreamBlock` (or similar) – the canonical StreamBlock used by `HomePage` (and later `ServicePage`, `StandardPage`, etc).
      * Any abstract base/mixins that are clearly needed for almost all future blocks (but avoid premature abstraction):

        * e.g. a `BaseSectionBlock` subclassing `wagtail.blocks.StructBlock` with common Meta defaults and possibly shared “section settings” fields (like background style or alignment), if we’re confident they will be reused everywhere.
    * Uses Wagtail’s `StreamBlock`, `StructBlock`, `RichTextBlock`, etc. with **type hints**.

* Align with repo structure in Initiation Packet (block modules per feature, templates in `templates/sum_core/blocks/`). 

**Canonical StreamField**

* Choose a canonical **page body field** pattern:

  * Field name: `body` (aligns with PRD language: “StreamField body” for Service/Standard pages).
  * Type: `StreamField(PageStreamBlock, use_json_field=True, blank=True, null=True)` using `wagtail.fields.StreamField`.

* For this task, `PageStreamBlock` should:

  * Be defined in `base.py` and exported from `__init__.py`.
  * Include at least **one safe, useful content block** that proves the pipeline end-to-end, for example:

    * `rich_text = blocks.RichTextBlock(...)` configured to match PRD’s `RichTextBlock` constraints where possible:

      * H2–H4 headings only.
      * Lists, links, bold, italic.
      * No H1.
    * It’s fine if some details of US-B08 are deferred to the “Content Blocks” task, but don’t contradict them.

* The class must be designed to be easily extended later (adding hero, trust, gallery, etc.) without breaking migrations or page models.

**Page Model Wiring (Test Project)**

* Update `core/sum_core/test_project/home/models.py`:

  * Import `StreamField` and `PageStreamBlock` from `sum_core.blocks`.
  * Add `body` field to `HomePage` using `PageStreamBlock`.
  * Update `content_panels` to include the StreamField (`FieldPanel("body")`), while keeping existing fields (e.g. `intro`) for now.
  * Ensure this change comes with a new migration under the test project’s `home` app.

**Template Wiring**

* Update `core/sum_core/templates/sum_core/home_page.html`:

  * Keep the current hero layout (title + intro) for now; we’ll replace it with hero blocks in `M2-002`.
  * Below the hero section, render the StreamField:

    ```django
    {% if page.body %}
      {% for block in page.body %}
        {% include_block block %}
      {% endfor %}
    {% endif %}
    ```

* Introduce at least one block template under `core/sum_core/templates/sum_core/blocks/`, e.g.:

  * `blocks/rich_text.html` – wraps `{{ self|richtext }}` in `.section` / `.container` and any existing typography utilities from `main.css` (e.g. `.text-body`).
  * Ensure block templates **do not introduce new colours or arbitrary spacing**; they should rely purely on existing classes & tokens from `main.css` and the SolarCraft design system. 

**Coding Standards**

* All new Python modules must start with the project’s header comment:

  ```python
  """
  Name: [Module Name]
  Path: [File path]
  Purpose: [Brief description]
  Family: [What depends on this]
  Dependencies: [What this depends on]
  """
  ```

* Use **type hints** throughout, and follow existing formatting (Black, Ruff, isort).

* No magic numbers or hard-coded paths; import from `sum_core` or Wagtail where appropriate.

---

### Design Specifications (what “good” looks like visually)

* Use the existing layout primitives established in Milestone 1:

  * `.section`, `.section--tight`, `.section--muted`, `.section--inset` etc.
  * `.container` for width and horizontal padding.
  * Typography utilities: `.heading-*`, `.text-body`, `.text-muted`.

* Block templates must:

  * Respect the **“Breath” rule** (generous top/bottom padding via section classes, not inline `style` attributes). 
  * Not introduce inline styles or non-token CSS.
  * Use semantic HTML: `<section>`, `<h2>`, `<p>`, `<ul>` etc., with heading levels appropriate for content (H2+ for block headings, never H1).
  * Be ready to mirror the visual rhythm of `premium-trade-website-v3-final.html` when more blocks are added. 

* Accessibility:

  * Ensure rich text blocks use proper heading levels (H2–H4) and lists for structure.
  * No color-only indicators; rely on typography and layout for emphasis.
  * Markup must remain readable even with custom client typography via SiteSettings.

---

### Implementation Guidelines

**Files to Create**

* `core/sum_core/blocks/__init__.py`
* `core/sum_core/blocks/base.py`
* `core/sum_core/templates/sum_core/blocks/rich_text.html` (or equivalent initial block template)
* New test module(s), e.g.:

  * `tests/blocks/test_page_streamblock.py`
  * Or extend existing `tests/pages/test_home_page.py` to cover StreamField rendering

**Files to Modify**

* `core/sum_core/test_project/home/models.py` – add `body` StreamField and panel.
* `core/sum_core/templates/sum_core/home_page.html` – render `page.body`.
* Any existing test file that asserts the HomePage template content, to account for the new StreamField render (without breaking existing hero tests).

**Implementation Notes**

* Define `PageStreamBlock` in `base.py`, then re-export from `__init__.py` so page models can simply `from sum_core.blocks import PageStreamBlock`.
* Keep abstractions minimal for now; it’s OK if we only implement `rich_text` in `PageStreamBlock` in this task, as long as the class is clearly extendable.
* Avoid introducing new CSS; use existing utility classes and the design system. If a new class feels essential, it should be justified against the design system and added via tokens in a future styling task, not here.

---

### Acceptance Criteria

* [ ] `core/sum_core/blocks` is a proper Python package with `__init__.py` exporting `PageStreamBlock`.
* [ ] `PageStreamBlock` is defined in `core/sum_core/blocks/base.py` with type hints and at least one concrete block (e.g. `rich_text`) configured per PRD constraints (H2–H4, lists, links, bold/italic, no H1).
* [ ] `HomePage` in the test project has a `body` `StreamField(PageStreamBlock, ...)` wired into its `content_panels`.
* [ ] A Wagtail editor can add one or more blocks to `HomePage.body` in the admin, publish the page, and see them rendered on `/` with no errors.
* [ ] `home_page.html` renders `page.body` using `{% include_block %}` and does not break existing header/hero content.
* [ ] At least one block template exists under `templates/sum_core/blocks/` and uses only design tokens / existing CSS classes (no inline styles, hex colours, or arbitrary pixel spacing).
* [ ] New and updated Python modules include the standard header comment and type hints.
* [ ] Unit tests for `PageStreamBlock` and/or the `HomePage` StreamField render are added and passing (`make test`).
* [ ] No regressions in existing Milestone 0/1 tests (linting and test suite remain green).

---

### Dependencies & Prerequisites

* Milestone 1 tasks complete: tokens in `main.css`, base layout, branding tags, and navigation are working and tested.
* Test project is migrated and running (local dev env OK).
* Existing HomePage model and template are in place and currently render using the SUM base layout.

---

### Testing Requirements

**Unit Tests**

* New tests for `PageStreamBlock`:

  * Can be instantiated and deconstructed/reconstructed (Wagtail block deconstruction).
  * Accepts valid block data (e.g. a simple rich text block) and rejects invalid configuration (if any validation is implemented now).

**Integration Tests**

* Page rendering tests:

  * Create a `HomePage` instance in tests with at least one `PageStreamBlock` entry (e.g. `rich_text`) and assert:

    * The rendered HTML includes the block content.
    * The expected block template is used (e.g. via a class name or wrapper element).

**Manual Checks**

* In Wagtail admin:

  1. Create or edit the root `HomePage`.
  2. Add a `rich_text` block (or whatever initial block is configured) to the `body` StreamField, publish.
  3. Verify on the frontend:

     * The content appears under the hero section.
     * Typography and spacing look consistent with the existing design system.
     * No console errors or template exceptions.

---

### Context Bundle for AI

When this task is handed to an AI coding agent, include:

* Excerpts from **PRD 2.3 Epic: StreamField Blocks** for block families and especially `US-B08: Content Blocks` (to understand rich text constraints and future blocks).
* Excerpt from **PRD 6.6 Design Implementation Guardrails** emphasizing token-only styling and no inline hex/px.
* The **repo structure snippet** from the Project Initiation Packet showing `sum_core/blocks/` modules and `templates/sum_core/blocks/`. 
* The **SolarCraft design system** sections on token system, layout & spacing, and typography to guide markup and avoid ad-hoc CSS. 
* A small fragment of the **premium trade HTML reference** around a simple content section (not the full file) so the agent can mirror class structure. 
* Current `HomePage` model and `home_page.html` template contents, plus `main.css` component list, so the agent can follow existing patterns.

---

**Estimated Effort**: **M (3–4 hours)**
(Aligns with Implementation Plan estimate for `BLOCKS-001 – Base Block Infrastructure`.)

If you’re happy with this, the next step is to hand this card to the coding agent and then we can follow up with `M2-002 – Hero Blocks` once this pipeline is proven.
