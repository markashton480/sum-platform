**[M2-007] Process & FAQ Blocks (ProcessStepsBlock + FAQBlock)**
_Task ID: BLOCKS-007 • Workstream: Blocks • Milestone: 2 – StreamField Blocks_

---

## Context (from PRD)

**Business requirement excerpt – US-B06: Process & FAQ Blocks**

> As a content editor, I want process and FAQ blocks so that I can explain services clearly.

Key acceptance criteria from the PRD for this task:

- `ProcessStepsBlock`: numbered **timeline/steps layout**.
- Steps: **3–8 items**, each with **number (auto or manual), title, description**.
- Visual **connector lines** between steps.
- `FAQBlock`: **accordion-style** expandable questions/answers.
- FAQ items: **1–20 items**, each with **question + rich-text answer**.
- Accordion: **single-open or multi-open** behaviour, **configurable**.
- FAQ should emit **JSON-LD FAQPage schema**.
- Unit tests required for both block types.

---

## Technical Requirements

**Blocks & Python**

Create two new blocks within the `sum_core.blocks` family:

1. **`ProcessStepsBlock`**

   - Parent `StructBlock` with fields:

     - `eyebrow` (optional short label / kicker) – `CharBlock(required=False)`.
     - `heading` – either `CharBlock` or `RichTextBlock` (match the pattern used for Services/Testimonials headings).
     - `intro` – optional `RichTextBlock` for short supporting text.
     - `steps` – `ListBlock(ProcessStepBlock, min_num=3, max_num=8)`.

   - `ProcessStepBlock` (inner `StructBlock`):

     - `number` – `IntegerBlock(required=False, min_value=1, max_value=20)`

       - If provided, use as the displayed step number.
       - If omitted, default to **auto-numbering** via `forloop.counter` in the template.

     - `title` – `CharBlock(required=True)`.
     - `description` – `RichTextBlock` or `TextBlock` (allowing at least basic formatting like bold, italic, links, lists).

   - `Meta`:

     - `icon = "list-ol"` or similar.
     - `label = "Process Steps"`.
     - `template = "sum_core/blocks/process_steps.html"`.
     - `group = "Sections"` (ensure this is respected when wiring into `PageStreamBlock`).

2. **`FAQBlock`**

   - Parent `StructBlock` fields:

     - `eyebrow` (optional).
     - `heading`.
     - `intro` (optional).
     - `items` – `ListBlock(FAQItemBlock, min_num=1, max_num=20)`.
     - `allow_multiple_open` – `BooleanBlock(required=False, default=True)`.

   - `FAQItemBlock`:

     - `question` – `CharBlock(required=True)`.
     - `answer` – `RichTextBlock(required=True)` (standard feature set: headings, lists, bold, links).

   - `Meta`:

     - `icon = "help"` or `"question"`.
     - `label = "FAQ"`.
     - `template = "sum_core/blocks/faq.html"`.
     - `group = "Sections"`.

   - **JSON-LD FAQ schema**:

     - Implement `FAQBlock.get_context(...)` that:

       - Calls `super().get_context(...)`.

       - Builds a Python dict in the shape:

         ```python
         {
             "@context": "https://schema.org",
             "@type": "FAQPage",
             "mainEntity": [
                 {
                     "@type": "Question",
                     "name": question_text,
                     "acceptedAnswer": {
                         "@type": "Answer",
                         "text": plain_text_answer,
                     },
                 },
                 ...
             ],
         }
         ```

       - Use `django.utils.html.strip_tags` (and handle `RichText` values) to get a safe plain-text answer.

       - Serialise via `json.dumps(...)` and expose as `faq_schema_json` in the template context.

**Block wiring & exports**

- Create a new blocks module, e.g.:

  - `core/sum_core/blocks/process_faq.py`

- Update `core/sum_core/blocks/__init__.py`:

  - Import and re-export `ProcessStepsBlock` and `FAQBlock`.
  - Ensure they are included in `__all__` alongside existing blocks.

- Update `core/sum_core/blocks/base.py`:

  - Add both to `PageStreamBlock` with sensible names:

    ```python
    process = ProcessStepsBlock(group="Sections")
    faq = FAQBlock(group="Sections")
    ```

  - Follow existing ordering conventions (e.g. after trust/stats, before gallery, if that matches the design flow).

**Templates**

Create:

- `core/sum_core/templates/sum_core/blocks/process_steps.html`
- `core/sum_core/templates/sum_core/blocks/faq.html`

Guidelines:

1. **Process template (`process_steps.html`)**

   - Semantic structure:

     - `<section>` with base `.section` class (and optional modifier like `.section--muted` / `.section--inset` if appropriate).
     - Inner `.container`.
     - Shared section header pattern reused from existing blocks (Services/Testimonials):

       - Eyebrow, heading, intro should use the **same** classes and structure as other sections (no new heading-specific CSS).

     - Steps rendered as an ordered list: `<ol class="process__steps">` with `<li class="process__step">`.

   - Each step shows:

     - A number badge (from `step.number` or fallback to position).
     - Title (heading utility class).
     - Description (body text utility).

   - Layout:

     - On desktop: steps appear in a horizontal/timeline style grid (e.g. 3–4 columns, or horizontal flex with wrapping).
     - Visual connectors between steps using pure CSS (e.g. pseudo-elements `::before`/`::after` connecting step cards).

   - No inline styles; no hard-coded type/colour values.

2. **FAQ template (`faq.html`)**

   - Semantic structure:

     - `<section class="section section--faq">` (or similar), plus `.container`.
     - Reuse the **same section-heading pattern** as above for eyebrow/heading/intro.

   - Accordion structure:

     - For each FAQ item, use accessible markup:

       - Either `<details><summary>...</summary>...</details>` plus styling
         **or**
       - `<button>` for question + `<div role="region">` for answer, with `aria-expanded`, `aria-controls`, `id` attributes.

     - Mark root container with something like `data-faq-block` and include `data-allow-multiple="{{ self.allow_multiple_open|yesno:'true,false' }}"` for JS to read.

   - JSON-LD:

     - At the bottom of the section, render:

       ```html
       {% if faq_schema_json %}
       <script type="application/ld+json">
         {{ faq_schema_json|safe }}
       </script>
       {% endif %}
       ```

**JavaScript**

- Extend the existing JS (likely `core/sum_core/static/sum_core/js/main.js`) to support the FAQ accordion:

  - Use event delegation on a container attribute (e.g. `[data-faq-block]`).
  - On click of a question control:

    - Toggle `aria-expanded`.
    - If `allow_multiple_open` is `false`, close other open items in the same block.

  - Degrade gracefully:

    - If JS is disabled, all answers are visible or `details`/`summary` handles behaviour natively.

---

## Design Specifications

**General**

- **Use tokens only**:

  - Colours via `var(--color-...)` / `var(--surface-...)`.
  - Typography via `--font-heading`, `--font-body`, `--text-*`, etc.
  - Spacing via `--space-*`.
  - Shadows, radii, transitions via existing tokens.
  - If in doubt, consult the `css-architecture-tokens.md` document which explains the CSS system, patterns, and design tokens.
  - Existing tokens should be used where possible, ONLY create new tokens if necessary.

- **No hard-coded fonts or hex colours**.
- **No section-specific heading CSS** (no `.process-heading` / `.faq-heading` etc.):

  - Reuse the same section heading pattern used in Services and Testimonials (eyebrow + heading + intro).

- Responsive:

  - Mobile-first.
  - Uses existing breakpoint tokens/media queries already in `main.css`.

Follow the reference design in: `docs/dev/design/faq_and_process_design.html`
**Accessibility**

- Process:

  - Use `<ol>` + `<li>` to convey sequence.
  - Ensure colour is not the only cue for step order (numbers are visible).

- FAQ:

  - Use ARIA attributes or `<details>` semantics.
  - Ensure keyboard navigation works: questions focusable, space/enter toggles.
  - Announce expanded/collapsed state through `aria-expanded`.

---

## Implementation Guidelines

**Files to create/modify**

- **New**:

  - `core/sum_core/blocks/process_faq.py`
  - `core/sum_core/templates/sum_core/blocks/process_steps.html`
  - `core/sum_core/templates/sum_core/blocks/faq.html`
  - `tests/blocks/test_process_faq_blocks.py` (or similar)

- **Existing**:

  - `core/sum_core/blocks/__init__.py`
  - `core/sum_core/blocks/base.py`
  - `core/sum_core/static/sum_core/css/main.css` (add minimal BEM styles for process + FAQ; keep within the blocks/components area per the implementation guide)
  - `core/sum_core/static/sum_core/js/main.js` (accordion behaviour)
  - Optionally extend `tests/templates/test_homepage_rendering.py` or add a new template test focused on Process/FAQ.

**Required Python file header comment pattern**

For each new Python module:

```python
"""
Name: [Module Name]
Path: core/sum_core/blocks/[filename].py
Purpose: [Brief description]
Family: SUM core StreamField blocks (Process & FAQ).
Dependencies: Wagtail blocks, Django utilities, json.
"""
```

**Coding patterns**

- Add type hints everywhere (including `get_context`).
- Follow existing `BaseHeroBlock`/`ServiceCardsBlock` style for `Meta`, labels, icons.
- When reading `RichText` for schema, be defensive: handle both `str` and `RichText` values.

---

## Acceptance Criteria

**ProcessStepsBlock**

- Block appears in Wagtail StreamField chooser as “Process Steps” under the same group as other section blocks.
- Editor can add **3–8 steps**; validation prevents fewer/more.
- Each step displays:

  - A visible step number:

    - Uses the provided `number` if set.
    - Otherwise auto-numbers from position.

  - Title and description.

- Front-end:

  - Mark-up uses `<section>`, `.section`, `.container`, `<ol>`, `<li>`.
  - Visually connected layout with connector lines at desktop widths.
  - Mobile layout stacks steps vertically.

- All styling uses design tokens and existing typography utilities.

**FAQBlock**

- Block appears as “FAQ” in StreamField under “Sections”.
- Editor can add **1–20** Q&A items; validation enforces the range.
- `allow_multiple_open` field present and saved correctly.
- Front-end:

  - Renders an accessible accordion:

    - Keyboard operable.
    - `aria-expanded` and `aria-controls` wired correctly (if not using `<details>`).

  - `allow_multiple_open = True`: multiple items can be open.
  - `allow_multiple_open = False`: JS enforces only one open at a time (degrades to multi-open if JS disabled).

- JSON-LD:

  - A `<script type="application/ld+json">` element is present when there is at least one FAQ item.
  - Contains `@context: "https://schema.org"` and `@type: "FAQPage"`.
  - Each FAQ item is represented as a `Question` with an `acceptedAnswer`.

**Integration**

- `PageStreamBlock` exposes both blocks (e.g. `process` and `faq` keys).
- A test `HomePage` can be created in tests with both blocks present and renders without errors via Django test client.
- Changing SiteSettings fonts updates typography for headings/labels in these blocks automatically (no custom font declarations in their CSS).

---

## Dependencies & Prerequisites

- Milestone 1 completed (design tokens, base layout, SiteSettings, branding tags).
- Milestone 2 tasks completed up to:

  - Base block infrastructure.
  - Hero blocks.
  - Service cards.
  - Testimonials.
  - CTA.
  - Trust & stats.
  - Gallery.

- Existing test suite green (the db relation & outdated tests issue has already been resolved; keep imports like `from home.models import HomePage` consistent).

---

## Testing Requirements

**Unit tests**

Create `tests/blocks/test_process_faq_blocks.py` to cover:

1. **Structure & validation**

   - `ProcessStepsBlock` is a `StructBlock` with the expected child fields.
   - `steps` list has `min_num=3`, `max_num=8`.
   - `FAQBlock` is a `StructBlock` with `items` list having `min_num=1`, `max_num=20`.
   - `allow_multiple_open` defaults to `True`.

2. **Numbering behaviour**

   - When `number` is provided for a step, that value is present in the cleaned value.
   - When omitted, `clean()` still passes and template can derive index-based numbers (test by rendering template if needed).

3. **FAQ schema**

   - Build a sample value with 2 items.
   - Call `FAQBlock().get_context(value)` and assert:

     - `faq_schema_json` exists.
     - `json.loads(...)` returns a dict with:

       - `@type == "FAQPage"`.
       - `len(mainEntity) == 2`.
       - Each entity has `@type == "Question"` and nested `acceptedAnswer`.

**Template / integration tests**

- Extend `tests/templates/test_homepage_rendering.py` or add `test_homepage_renders_process_and_faq_blocks`:

  - Create a `HomePage` with a `body` StreamField containing:

    - One `process` block.
    - One `faq` block.

  - Render via Django test client.
  - Assert:

    - Status 200.
    - Presence of `.process` / `.faq` container classes.
    - Presence of JSON-LD `<script type="application/ld+json">` for FAQ.
    - Accordion structural elements (e.g. `data-faq-block`, `aria-expanded` etc.).
