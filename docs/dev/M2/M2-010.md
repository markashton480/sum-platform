**[M2-010] Form Blocks – Contact & Quote**

---

### Context (from PRD)

**Business requirement**

From **US-B09: Form Blocks** in the PRD:

> As a content editor, I want form blocks so that visitors can submit enquiries.

Key acceptance points for this task’s scope:

- `ContactFormBlock`: Pre-configured contact form (name, email, phone, message).
- `QuoteRequestFormBlock`: Quote form with configurable fields (project type, budget range, timeline, service area, additional details).
- All forms must support required-field validation, email/phone validation, spam protection (honeypot) and later integration into the lead system and reCAPTCHA.

From **Form System – 3.1.1 Form Configuration**:

- Contact form default field set and validations.
- Quote request form fields that are configurable per site (project type, budget range, etc.) via a `FormConfiguration` model.

**How this fits Milestone 2**

- This task lives in **Workstream 3 – StreamField Blocks**, and is scoped to:

  - Define `ContactFormBlock` and `QuoteRequestFormBlock` as reusable **StreamField blocks**.
  - Provide templates and CSS that match the design system and design-token rules.
  - Prepare hooks (metadata, attributes, honeypot field) so **Milestone 3 – Leads & Forms** can plug in the actual backend lead handling without rewriting templates.

Backend lead persistence, rate limiting, reCAPTCHA wiring and admin interfaces are explicitly left to **LEADS-001..003** in Milestone 3.

---

### Technical Requirements (from Implementation Plan & architecture)

**Scope**

- Implement **two blocks** in `sum_core`:

  - `ContactFormBlock`
  - `QuoteRequestFormBlock`

- Integrate them into the existing `PageStreamBlock` so they can be used on the HomePage and future page types.

**Block definitions**

Create a new module:

- `core/sum_core/blocks/forms.py`

With:

```python
class ContactFormBlock(StructBlock):
    heading = RichTextBlock(required=True, help_text="Section heading")
    intro = RichTextBlock(required=False, help_text="Optional introductory copy")
    success_message = TextBlock(required=False, default="Thanks, we’ll be in touch shortly.")
    submit_label = CharBlock(required=False, default="Send enquiry")

    class Meta:
        icon = "mail"
        template = "sum_core/blocks/contact_form.html"
        label = "Contact form"
        form_type = "contact"  # metadata for leads system
```

```python
class QuoteRequestFormBlock(StructBlock):
    heading = RichTextBlock(required=True)
    intro = RichTextBlock(required=False)
    success_message = TextBlock(required=False, default="Thanks, we’ll prepare your quote.")
    submit_label = CharBlock(required=False, default="Request a quote")
    show_compact_meta = BooleanBlock(required=False, help_text="Compact layout for sidebars/short sections.")

    class Meta:
        icon = "form"
        template = "sum_core/blocks/quote_request_form.html"
        label = "Quote request form"
        form_type = "quote"
```

> Exact field names can be tweaked, but **must** cover the headings/intro/success-message/submit-label surface area described above, and expose a `form_type` hint for later lead handling.

**Block registration**

- Update `core/sum_core/blocks/__init__.py` to export the new blocks.
- Update `core/sum_core/blocks/base.py`:

  ```python
  class PageStreamBlock(StreamBlock):
      # …existing blocks…
      contact_form = ContactFormBlock(group="Forms")
      quote_request_form = QuoteRequestFormBlock(group="Forms")
  ```

This mirrors the existing pattern used for hero, services, testimonials, process/FAQ, gallery, and content blocks.

**Backend behaviour (for now)**

- **No lead model or full submission flow in this task.**
- Forms should:

  - Render a `<form>` with `method="post"`, `novalidate` and `action=""` (post back to the same page).
  - Include a CSRF token placeholder (`{% csrf_token %}`).
  - Include a **honeypot** field that is present in markup but visually hidden (class hook for CSS) – actual spam logic will be implemented later.

- Treat any `form` object passed via context as a standard Django form:

  - Use `form.fields` and `form.errors` where appropriate in templates.
  - But **do not** introduce new dependencies on a concrete lead or form model – that belongs to Workstream 5.

---

### Design Specifications (Design System, CSS & Tokens)

Use the **design implementation workflow** and CSS architecture docs as your ground truth.

**Layout**

- Wrap each block in the standard section pattern:

  ```html
  <section class="section [modifiers]">
    <div class="container">
      <header class="section__header">
        {% if self.eyebrow %}<span class="section__eyebrow"
          >{{ self.eyebrow }}</span
        >{% endif %}
        <div class="section__heading">{{ self.heading|richtext }}</div>
        {% if self.intro %}
        <p class="section__intro text-lg">{{ self.intro|richtext }}</p>
        {% endif %}
      </header>

      <!-- Form goes here -->
    </div>
  </section>
  ```

- Likely modifiers:

  - `section--muted` for contact forms in main content.
  - `section--dark` if the design calls for a darker quote panel.

**Typography**

Follow the typography mapping from `design-implementation.md`:

- Section heading: `.heading-lg` or `.section__heading` wrapper (as we’ve used for other blocks).
- Intro/body: `.text-body` or `.text-lg`.
- Meta text (e.g. small disclaimers): `.text-sm` or `.text-xs` + `.text-muted`.

No `font-size`, `line-height`, or `font-family` declarations in component CSS. All of that must come from the existing type scale and tokens.

**Form styling**

Use reference design: `docs/dev/design/form_design.html`

Any layout customisation for this block (e.g. side-by-side fields for name/email) should be expressed via **additional BEM modifiers** in a new component stylesheet, not via ad-hoc classes on elements.

**Buttons**

- Use the shared button classes defined in `components.buttons.css`:

  - Primary: `.btn btn-primary`
  - Secondary: `.btn btn-secondary`
  - Ghost/tertiary (if needed): `.btn btn-ghost`

- If the design requires full-width submit buttons, introduce a reusable modifier like `.btn--full-width` in `components.buttons.css`, not a form-specific variant.

**Tokens**

All spacing, colours, radii and shadows **must** use design tokens from `tokens.css`:

- Spacing: `margin-top: var(--space-8);`, `gap: var(--space-4);`
- Colours: `background-color: hsla(var(--surface-tint), 1);`, `color: hsla(var(--text-main), 1);`
- Borders: `border-radius: var(--radius-lg);`
- Shadows: `box-shadow: var(--shadow-md);`

**Accessibility**

- Labels must be associated with inputs via `for`/`id`.
- Use `aria-describedby` to link fields to hint/error spans.
- Honeypot field must be hidden visually via CSS but still accessible to screen readers if necessary (we can also mark it `aria-hidden="true"` if we explicitly choose that pattern).
- Error states should be indicated by:

  - `.form__control--error`
  - `aria-invalid="true"` on inputs with errors.

---

### Implementation Guidelines

**Files to create/modify**

- **New Python module**

  - `core/sum_core/blocks/forms.py`

- **Existing Python modules**

  - `core/sum_core/blocks/__init__.py` – export new blocks.
  - `core/sum_core/blocks/base.py` – add `contact_form` and `quote_request_form` to `PageStreamBlock` (group `"Forms"`).

- **Templates**

  - `core/sum_core/templates/sum_core/blocks/contact_form.html`
  - `core/sum_core/templates/sum_core/blocks/quote_request_form.html`

- **CSS**

  - `core/sum_core/static/sum_core/css/components.forms.css` – **new** component stylesheet for form layouts specific to these blocks.
  - Ensure it is imported from `main.css` (the single CSS entry point).

- **Tests**

  - `tests/blocks/test_form_blocks.py`
  - `tests/templates/test_form_blocks_rendering.py`

**Required header comments for new files**

In `forms.py` and `components.forms.css`:

```python
"""
Name: Form Blocks
Path: core/sum_core/blocks/forms.py
Purpose: StreamField blocks for contact and quote request forms
Family: SUM Platform – StreamField Blocks
Dependencies: Wagtail core blocks, PageStreamBlock, templates in sum_core/blocks
"""
```

```css
/* ==========================================================================
   Name: Form Blocks
   Path: core/sum_core/static/sum_core/css/components.forms.css
   Purpose: Layout and styling for contact/quote form blocks
   Family: SUM Platform Design System – Components
   Dependencies: tokens.css, typography.css, layout.css, components.buttons.css
   ========================================================================== */
```

**Python specifics**

- Use type hints on all functions, including any helper methods.
- Follow existing block patterns (e.g. `Meta.template`, explicit `group` in `PageStreamBlock`).
- Don’t introduce new business logic (lead creation, rate limits) here – just structural hints (like `form_type` and `data-*` attributes on `<form>`).

**Template specifics**

- No inline `style=""`.
- Use `.section` + `.container` + `.section__header` pattern.
- Form markup should be generic enough for the future lead handler:

  - `data-form-type="{{ self.Meta.form_type }}"` or similar attribute on the `<form>` element.
  - Include honeypot field with a consistent name (e.g. `website` or `company`) and a class like `.form__field--honeypot`.

---

### Acceptance Criteria

**Block definitions**

- [ ] `ContactFormBlock` and `QuoteRequestFormBlock` exist in `core/sum_core/blocks/forms.py`.
- [ ] Both are registered in `PageStreamBlock` under the `"Forms"` group.
- [ ] `ContactFormBlock` covers fields: heading, intro, success_message, submit_label.
- [ ] `QuoteRequestFormBlock` covers the same surface plus at least one layout/config flag (e.g. compact vs full) to support different placements.
- [ ] Each block exposes a `form_type` metadata field (e.g. `"contact"` / `"quote"`) used to annotate the rendered `<form>`.

**Rendering & design**

- [ ] Both blocks render without errors in Wagtail admin preview.
- [ ] Output HTML:

  - Uses `.section` + `.container` + `.section__header`.
  - Uses typography classes from `typography.css` (no raw font-size/family).
  - Uses `.form`, `.form__field`, `.form__label`, `.form__control`, `.form__error`, `.form__hint`, `.form__actions`.
  - Uses `.btn` button classes for submit actions.

- [ ] All spacing and colours in `components.forms.css` use tokens only (`var(--space-*)`, `hsla(var(--*), 1)`, etc.).
- [ ] No inline styles, no hex colours, no raw font declarations.

**Validation & accessibility**

- [ ] Templates render standard Django `form` objects when provided, showing field-level errors next to inputs and non-field errors at the top.
- [ ] Honeypot field present with consistent name and class; visually hidden via CSS.
- [ ] Inputs with errors receive `aria-invalid="true"` and are associated with error text via `aria-describedby`.
- [ ] Labels correctly associate with their inputs (`for`/`id` pairs).

**Integration readiness**

- [ ] `<form>` root includes `method="post"`, `{% csrf_token %}`, and `data-form-type` attribute.
- [ ] No dependency on a concrete `Lead` or `FormConfiguration` model – the blocks work with any form compatible with Django’s form API.
- [ ] Tests describe and assert the presence of the honeypot field and `data-form-type` attribute so future changes don’t break lead integration.

**Testing**

- [ ] `tests/blocks/test_form_blocks.py` asserts:

  - Block existence and field definitions.
  - `Meta.template` paths.
  - `PageStreamBlock` includes both blocks.

- [ ] `tests/templates/test_form_blocks_rendering.py`:

  - Renders a fake `HomePage` with both blocks populated.
  - Asserts presence of `.form`, `.form__field`, `.form__label`, `.form__control`, `.section__header`, `.btn` and honeypot field.

- [ ] `make test` and `make lint` pass without new failures.

---

### Dependencies & Prerequisites

- **Must be complete beforehand**

  - M2-001: Base Block Infrastructure (`PageStreamBlock` in place).
  - Existing CSS modularisation (`tokens.css`, `typography.css`, `layout.css`, `components.buttons.css`, etc.).
  - HomePage already wired to `PageStreamBlock`.

- **Feeds into**

  - M3 – `LEADS-001`/`LEADS-003` (Lead model & form submission handler).
  - Contact/Standard pages in Milestone 3 (these will host the forms).

---

### Testing Requirements

**Unit tests**

- Block-level tests in `tests/blocks/test_form_blocks.py` for:

  - Field sets.
  - `Meta.template`.
  - Registration in `PageStreamBlock`.

**Integration tests**

- Template-level tests in `tests/templates/test_form_blocks_rendering.py`:

  - Render both blocks with a dummy form object in context.
  - Assert main structural classes and attributes (section, form, honeypot, data-form-type, submit button).

**Manual checklist**

- Add both blocks to the HomePage StreamField.
- Confirm they render correctly on desktop and mobile.
- Toggle different SiteSettings themes/fonts and confirm buttons, headings and form text update via tokens (no hard-coded fonts/colours).
- Confirm honeypot field is not visually obvious in the UI.
