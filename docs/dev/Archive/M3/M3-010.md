## **[M3-010] Lead notification email templates + Celery tasks + failure-mode guarantees (no lost leads)**

**Context** (from SSOT - Milestone 3 + Lead flow)

- Milestone 3 deliverables include **“Lead notification email templates”** and **“Celery tasks”**, and DoD includes **“Email notifications send.”**
- SSOT’s lead flow explicitly queues async tasks after Lead creation: `send_lead_notification` and `send_lead_webhook (if configured)`.
- Test Strategy requires integration tests for **failure modes** (SMTP errors, webhook failures, Celery/broker failures) while preserving “no lost leads” and making failures visible in admin.

---

## **Technical Requirements** (from SSOT + Test Strategy)

### A) Add Lead “integration status” fields (email + webhook)

Extend `sum_core.leads.models.Lead` with minimal, explicit fields to support visibility + retries:

**Email**

- `email_status` (choices: `pending`, `sent`, `failed`)
- `email_sent_at` (nullable datetime)
- `email_last_error` (text, blank=True)
- `email_attempts` (int, default 0)

**Webhook**

- `webhook_status` (choices: `pending`, `sent`, `failed`, `disabled`)
- `webhook_sent_at` (nullable datetime)
- `webhook_last_error` (text, blank=True)
- `webhook_attempts` (int, default 0)
- `webhook_last_status_code` (nullable int)

Why: this directly supports the strategy requirement that failures are visible and diagnosable.

> Keep it intentionally minimal — no “integration log” table yet.

---

### B) Implement email notification templates (Django templates)

Create templates that can be used both in sync tests and in Celery tasks:

- `core/sum_core/templates/sum_core/emails/lead_notification_subject.txt`
- `core/sum_core/templates/sum_core/emails/lead_notification_body.txt`
- Optional HTML variant (only if you want): `lead_notification_body.html`

Content requirements:

- Include: name, email, phone (if present), form_type, message
- Include attribution: lead_source + key UTMs + page_url/referrer (when available)
- Keep it readable and operational (this is “internal ops”, not marketing copy)

---

### C) Create Celery tasks for email + webhook

Add tasks that are **idempotent**, retry safely, and update the Lead status fields.

Tasks (names should mirror SSOT):

- `send_lead_notification(lead_id: UUID)`
- `send_lead_webhook(lead_id: UUID)` (only runs if configured)

Key behaviour:

1. Task loads Lead by ID (use `.select_for_update()` only if needed; don’t deadlock)
2. If already `sent`, exit early (idempotency)
3. Attempt send
4. Update status fields (`sent_at`, attempts, last_error)
5. On failure: mark `failed`, store error, retry with backoff

Config:

- Email uses standard Django email backend + SSOT env vars (DEFAULT_FROM_EMAIL, LEAD_NOTIFICATION_EMAIL).
- Webhook uses SSOT `ZAPIER_WEBHOOK_URL` (or per-site override later).

---

### D) Queue tasks from the submission flow _without breaking “no lost leads”_

Update the M3-008 form submission handler so that once Lead is persisted:

- it queues Celery tasks (email + webhook) **after** Lead creation is committed
- if Celery is unavailable / `.delay()` raises, Lead still exists and statuses are updated in a way that surfaces the failure

This is explicitly required by the Test Strategy’s failure-mode guarantees.

Implementation guidance:

- Keep “Lead create” step first and durable.
- Wrap task-queueing in its own try/except:

  - set `email_status/webhook_status` to `failed` (or a distinct `pending` + error) when queueing fails
  - store `last_error` including a concise reason
  - log exception (future Sentry integration can hook into this later)

---

## **Design Specifications**

- No frontend UI work.
- Wagtail admin should surface the new fields in the Lead detail view (read-only) so failures are visible. (You already have grouped panels in M3-009; add an “Integrations” group.)

---

## **Implementation Guidelines**

**Files to create/modify**

- `core/sum_core/leads/models.py` (new status fields + choices)
- `core/sum_core/leads/migrations/0004_*` (schema migration)
- `core/sum_core/leads/tasks.py` (new Celery tasks)
- `core/sum_core/leads/services.py`

  - helper: `build_lead_notification_context(lead)` (optional)
  - helper: `build_webhook_payload(lead)` (optional)

- `core/sum_core/forms/views.py` (enqueue tasks after lead creation)
- `core/sum_core/leads/wagtail_admin.py` (add integration fields to panels; read-only)
- Email templates under `core/sum_core/templates/sum_core/emails/…`

**Required header comment (new module)**

```python
"""
Name: Lead async tasks
Path: core/sum_core/leads/tasks.py
Purpose: Send lead notifications and webhooks asynchronously with retries and status tracking.
Family: Leads, forms, integrations, ops visibility.
Dependencies: Celery, Django email backend, HTTP client, Lead model.
"""
```

**Celery wiring**

- If Celery is already bootstrapped in the repo, follow the existing pattern.
- If not, add minimal Celery app config in `sum_core` package and test project settings consistent with SSOT’s stack.

---

## **Acceptance Criteria**

1. **Email templates exist and render**

   - Subject/body templates render with a Lead instance and contain required fields.

2. **Celery task: send_lead_notification**

   - On success: Lead `email_status=sent`, `email_sent_at` set, attempts incremented.
   - On SMTP/backend error: `email_status=failed`, `email_last_error` stored, attempts incremented, task retries.

3. **Celery task: send_lead_webhook (if configured)**

   - If webhook URL not configured: `webhook_status=disabled`
   - If configured:

     - On 2xx: `webhook_status=sent`, `webhook_sent_at` set
     - On timeout/5xx: `webhook_status=failed`, error + status code stored, retries

4. **Queueing failure does not lose leads**

   - If Celery queueing fails at submission time (broker down / `.delay()` raises):

     - Lead still exists
     - `*_status` fields reflect failure + contain error details
     - submission endpoint still returns success for valid user submission (or returns success + warning, but must not rollback Lead)

5. **Admin visibility**

   - Wagtail Lead detail view shows email/webhook status + last error clearly.

6. **Tests (must be green)**

   - Integration tests cover failure modes:

     - email send raises
     - webhook times out / returns 500
     - Celery queueing raises

   - In all cases, Lead exists and status fields updated appropriately.

7. **Repo gates**

   - `make test` fully passes (including fixing the remaining M3-009 test brittleness).
   - `make lint` passes
   - `makemigrations --check --dry-run` clean

---

## **Dependencies & Prerequisites**

- M3-008 form submission endpoint exists and is the correct place to enqueue tasks post-create.
- M3-006 “create lead first” invariant must remain intact.
- M3-009 Wagtail admin exists; we’ll extend it to show integration state (and we must finish making its tests robust).

---

## **Testing Requirements** (from test-strategy-v1.1.md)

- Integration tests must explicitly cover:

  - SMTP/email backend exceptions
  - webhook 4xx/5xx/timeout
  - Celery/broker unavailability or task raise
    And verify: Lead record exists + integration status fields updated + errors logged.

---

## **Estimated Complexity**

- **Time:** L
- **Risk:** Medium–High (async + retries + failure semantics are where platforms get “real”)
