**[M3-007] Lead attribution fields + LeadSourceRule + derived lead_source (foundation for real form handler)**

**Context** (from SSOT - Lead Management System)

- The SSOT Lead model includes **attribution fields** (UTM/referrer/page URLs) and **derived source** fields that power reporting and routing.
- SSOT defines explicit **Lead Source Attribution Rules** (UTM/referrer → `lead_source`).
- Milestone 3 deliverables explicitly include **“Lead model with attribution”** + **LeadSourceRule model** as part of lead management.
- M3-006 intentionally shipped the canonical Lead persistence core but deferred attribution + rule derivation; the implementation notes call out this exact follow-up.

---

## Technical Requirements (from SSOT)

### A) Extend Lead model to include attribution + derived source fields

Update `sum_core.leads.models.Lead` to add the SSOT attribution + derived source fields (keeping existing M3-006 fields intact).

**Add these fields (SSOT 8.1):**

- `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content` (blank=True)
- `landing_page_url` (blank=True)
- `page_url` (required in SSOT; for now allow blank/null only if you need backwards compat on existing rows—prefer a data migration to populate)
- `referrer_url` (blank=True)
- `lead_source` (derived enum-ish string: `google_ads`, `seo`, `direct`, etc.)
- `lead_source_detail` (blank=True)

**Notes**

- Keep `form_data` JSON as the “raw truth”; attribution fields are structured mirrors for filtering/reporting.
- Ensure any new non-null fields are safely migrated for existing rows (M3-006 created real DB tables).

---

### B) Implement LeadSourceRule model (configurable override layer)

Add a `LeadSourceRule` model that can compute/override `lead_source` from UTMs/referrer using a rule table (SSOT milestone requires this model).

Minimum viable for M3-007:

- Rule matching fields (start simple): `utm_source`, `utm_medium`, `referrer_contains` (nullable/blank)
- `derived_source` (string choice/enum)
- `priority` (int; lower = higher priority)
- `is_active` (bool)

This lets you keep SSOT’s static table as defaults while enabling future per-client customization.

---

### C) Implement derivation logic (single canonical function)

Create a single function used everywhere:

- `sum_core.leads.attribution.derive_lead_source(...) -> tuple[str, str]`

  - returns `(lead_source, lead_source_detail)`

Behaviour:

1. If matching active `LeadSourceRule` exists, use it (highest priority wins).
2. Else apply SSOT’s default attribution rules table (UTM/referrer-based).

This function is what the future form submission handler will call after it creates a Lead record (SSOT 8.3 flow).

---

### D) Wire M3-006 service to populate derived fields (without creating the endpoint yet)

Update `create_lead_from_submission(...)` so that when attribution inputs are provided (UTM/referrer/page_url), it:

- stores attribution fields on Lead
- derives `lead_source` + `lead_source_detail` via the canonical function
- still preserves the **“Lead record is created first”** invariant (don’t refactor into a single atomic block that could rollback creation on later failures).

---

## Design Specifications

- No frontend work required. This task is data model + derivation logic. (Forms will be wired in a subsequent task.)

---

## Implementation Guidelines

**Files to create/modify**

- `core/sum_core/leads/models.py` (extend Lead; add LeadSourceRule)
- `core/sum_core/leads/migrations/0002_*` (schema migration for Lead fields + LeadSourceRule table)
- `core/sum_core/leads/attribution.py` (new) – derivation logic + helpers
- `core/sum_core/leads/services.py` (update create function to accept/store attribution + derive source)
- `core/sum_core/leads/admin.py`

  - add LeadSourceRule admin
  - add attribution + lead_source columns/filters to Lead admin

**Required header comment example**

```python
"""
Name: Lead attribution & source derivation
Path: core/sum_core/leads/attribution.py
Purpose: Derive lead_source from UTMs/referrer using rules + defaults.
Family: Leads, attribution, reporting, integrations.
Dependencies: LeadSourceRule, URL parsing helpers (if used).
"""
```

**Data migration expectation**

- If `page_url` is required (per SSOT), include a data migration that sets:

  - `page_url = landing_page_url` if present, else empty string (only if absolutely necessary), or prefer allowing null temporarily and backfilling later.

- Be explicit and safe for existing rows from M3-006.

---

## Acceptance Criteria

1. **Lead model now supports attribution + derived source**

   - All SSOT 8.1 attribution + derived fields exist and migrate cleanly.

2. **LeadSourceRule model exists**

   - DB table created, admin-visible, ordering by priority works.

3. **Derivation logic matches SSOT defaults**

   - UTMs/referrer cases map correctly to the SSOT derived sources (`google_ads`, `seo`, `direct`, etc.).

4. **Rule overrides work**

   - When a matching `LeadSourceRule` is present, it overrides the default mapping (priority honoured).

5. **Service integration**

   - `create_lead_from_submission(...)` can accept attribution inputs and sets:

     - attribution fields
     - derived `lead_source` and `lead_source_detail`

   - Still maintains “create Lead first” durability guarantee.

6. **Quality gates**

   - `makemigrations --check --dry-run` clean.
   - `make test` passes.

---

## Dependencies & Prerequisites

- M3-006 Lead model + service layer already exist and are the integration point for this work.
- Form blocks exist (Contact/Quote) and will later pass UTMs/referrer/page_url into the submission service once the submission endpoint is implemented.

---

## Testing Requirements (from test-strategy-v1.1.md)

- **Unit tests** for derivation function covering:

  - SSOT default rule table cases
  - LeadSourceRule override + priority behaviour

- **Integration-ish tests** for service:

  - create Lead with attribution → derived fields populated
  - rule override applied

- (Failure-mode “no lost leads” tests remain relevant and should continue to pass; we’re not adding email/webhook/Celery here yet.)

---

## Estimated Complexity

- **Time:** M
- **Risk:** Medium (schema change on foundational model; needs careful migrations + backwards compatibility)
