**[M3-008] FormConfiguration model + real form submission handler (spam protection + Lead creation with attribution)**

**Context** (from SSOT - Milestone 3 Deliverables / Done When)

- Milestone 3 explicitly requires: **FormConfiguration model**, **form submission handler with spam protection**, and that **form submissions create Lead records with attribution**.
- You’ve now completed the core lead stack needed to support this:

  - Lead persistence service with “create first / no rollback” invariant.
  - Attribution + `LeadSourceRule` + derivation is in place and tested.

- Test Strategy makes form flows and “no lost leads” failure modes a P0 integration target (including spam checks in-flow).

---

## Technical Requirements (from SSOT + current implementation patterns)

### A) Add `FormConfiguration` model (per-site form settings)

Create a configurable model that allows a site to control how forms behave without code changes. This is a Milestone 3 deliverable.

**Minimum viable fields (M3-008 scope)**

- `site` (OneToOne to Wagtail `Site`, or FK with unique constraint)
- Spam protection:

  - `honeypot_field_name` (default `"company"` or similar)
  - `rate_limit_per_ip_per_hour` (int; default reasonable like 10–30)
  - `min_seconds_to_submit` (int; default e.g. 3–5)

- Notifications (config only; sending can be separate task):

  - `lead_notification_email` (nullable; fallback to env var later if you want)

- Presentation metadata:

  - `default_form_type` (optional; or leave in the request)

> Keep this intentionally minimal; we’re laying the _control-plane_ for forms.

---

### B) Implement a real submission endpoint that calls the Lead service

Implement a single HTTP endpoint in the platform package that:

- Accepts POST submissions for **Contact** and **Quote** (form_type drives behaviour)
- Runs spam checks
- Persists a Lead using `create_lead_from_submission(...)` including attribution fields (utm/referrer/page_url)
- Returns a stable JSON response:

  - `200` on success
  - `400` on validation errors (missing name/email/message/form_type)
  - `429` on rate limiting
  - `403` or `400` on spam triggers (choose and be consistent)

**Important invariant**

- For valid submissions, the Lead must be written before any side effects (email/webhook/celery), consistent with the platform’s “no lost leads” approach.

---

### C) Spam protection (M3-008 scope)

Implement the first layer of SSOT-required spam protection.

Minimum checks:

1. **Honeypot**

   - If honeypot field has a value → treat as spam (reject).

2. **Rate limiting** (per IP)

   - Use cache (Redis in prod, locmem in dev/CI) to track IP counters.

3. **Timing** (optional but low effort / high value)

   - Require a minimum elapsed time between “form rendered” and “submitted”.
   - This can be implemented via a signed timestamp token in a hidden field.

> Do not over-engineer reCAPTCHA yet; this should be “safe defaults, fast”.

---

### D) Wire the frontend blocks to submit to this endpoint

You already have Contact + Quote form blocks in Milestone 2 (per status report), so M3-008 wires them to the handler.

- Ensure the form templates include:

  - `form_type`
  - honeypot input
  - hidden fields for:

    - `page_url`
    - `landing_page_url` (if available)
    - `referrer_url` (can be JS-populated)
    - UTM params (JS or server-side capture; keep simple)

- Use your tokenised form CSS (already in place) and keep markup semantic.

---

## Design Specifications

- No new visual design required; reuse existing form styles (`.form__*`) already implemented.
- Ensure accessibility: labels, errors, keyboard flow, and readable server-side error output.

---

## Implementation Guidelines

**Files to create/modify (expected)**

- `core/sum_core/forms/models.py` (new) or `core/sum_core/leads/models.py` (if SSOT co-locates; prefer separate `forms/` app)
- `core/sum_core/forms/apps.py`, `__init__.py`, `migrations/0001_initial.py`
- `core/sum_core/forms/services.py` (spam checks + configuration fetch)
- `core/sum_core/forms/views.py` (submission endpoint)
- `core/sum_core/forms/urls.py` + include in test project URLs
- Update form block templates to post to endpoint:

  - `core/sum_core/templates/sum_core/blocks/forms/contact_form.html` (or your actual path)
  - `quote_request_form.html`

- Tests:

  - `tests/forms/test_form_submission.py`
  - `tests/forms/test_spam_protection.py`

**Required header comment (all new Python modules)**

```python
"""
Name: Form submission handler
Path: core/sum_core/forms/views.py
Purpose: Accept Contact/Quote submissions, apply spam checks, persist Leads.
Family: Forms, Leads, Attribution, Notifications.
Dependencies: FormConfiguration, Lead service, Django cache, Wagtail Site.
"""
```

**Patterns**

- Keep the HTTP endpoint thin; put logic in `services.py` so it’s testable.
- Use Django cache for rate limiting (avoid DB writes per hit).
- Use explicit input validation with clear error dicts.

---

## Acceptance Criteria

1. **FormConfiguration model exists**

   - Migrates cleanly and is site-scoped.
   - Admin-manageable (Django admin is fine for now; Wagtail viewset can come later).

2. **Submission endpoint works**

   - POST valid Contact payload → `200` and a Lead exists with attribution fields populated when provided.
   - POST invalid payload → `400` with errors; no Lead created.

3. **Spam protection works**

   - Honeypot triggers rejection.
   - Rate limit returns `429`.
   - (If timing implemented) too-fast submissions rejected.

4. **No lost leads invariant preserved**

   - For valid payloads, Lead is created even if an optional downstream hook raises (you can re-use the `post_create_hook` pattern in tests).

5. **Block wiring**

   - Contact + Quote blocks submit to the endpoint and include required hidden fields.

6. **Quality gates**

   - `makemigrations --check --dry-run` clean.
   - `make test` passes.
   - `make lint` passes.

---

## Dependencies & Prerequisites

- M3-006 Lead creation service exists and must remain the single canonical persistence entry point.
- M3-007 attribution derivation must be used rather than re-implemented in views/templates.
- Forms blocks exist from Milestone 2.

---

## Testing Requirements (from test-strategy-v1.1.md)

- **Integration tests** for the end-to-end flow: GET page → POST form → spam checks → Lead creation → (future async).
- Explicit failure-mode coverage is required for “no lost leads” (email/webhooks/celery failures are later tasks, but we simulate downstream failure now).
- Maintain coverage expectations and keep tests isolated (avoid the DB pollution issue you hit on M3-007—fixtures should clear rule/config tables as needed).

---

## Estimated Complexity

- **Time:** L (this is the first “real flow” that touches templates + HTTP + caching)
- **Risk:** Medium (spam/rate-limit edge cases + cross-site config)
