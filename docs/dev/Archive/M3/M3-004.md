## **[M3-004] Service Pages (ServiceIndexPage + ServicePage)**

**Context (from PRD)**
US-P02 requires Service pages so editors can describe each service in detail. Acceptance criteria require:

- `ServiceIndexPage` with intro StreamField + automatic child page grid
- `ServicePage` with featured image + short description + StreamField body
- Enforced hierarchy: ServicePage must be a child of ServiceIndexPage
  (“Related services” and JSON-LD schema are P1, so do not block Milestone 3.)

---

## Technical Requirements

### Page Models

Implement two Wagtail page types:

1. **ServiceIndexPage**

- Fields:

  - `intro` (StreamField) — “intro content area”

- Behaviour:

  - Automatically lists **live, public** child `ServicePage` items in the template (grid/cards)

- Hierarchy:

  - `subpage_types` must allow only `ServicePage` children (and any other explicitly approved types).

2. **ServicePage**

- Fields (P0):

  - `featured_image`
  - `short_description`
  - `body` (StreamField)

- Must include SEO/OG behaviour via the mixins already introduced in M3-001 (same pattern as StandardPage/HomePage).
- Hierarchy:

  - `parent_page_types` must restrict creation to `ServiceIndexPage`.

### Templates

- Create templates for both pages.
- Use the established layout primitives (`.section`, `.container`) and token-driven styling rules.
- No inline styles; no hard-coded colours/spacing outside tokens.

### Migrations (explicit requirement)

Because you are adding new model fields / models, you **must**:

- Create migrations
- Run migrations locally
- Ensure there are **no pending migrations** after the change (see checklist below)

This is especially important because CI and the packaged “test project” are used as the integration target.

---

## Files / Modules to Touch

> Exact filenames may vary slightly — follow the existing Milestone 3 page-model structure, but keep models under `/core/sum_core/pages/…` and templates under `/core/sum_core/templates/sum_core/…`.

**Core models**

- `core/sum_core/pages/services.py` _(new)_
- `core/sum_core/pages/__init__.py` _(export new page types if this is the pattern)_

**Templates**

- `core/sum_core/templates/sum_core/service_index_page.html` _(new)_
- `core/sum_core/templates/sum_core/service_page.html` _(new)_

**Migrations**

- `core/sum_core/pages/migrations/00xx_service_pages.py` _(new; actual number based on repo state)_

**Tests**

- `core/tests/pages/test_service_pages.py` _(new)_
- (Optional) `core/tests/templates/test_service_templates.py` _(if you keep template tests separate)_

---

## Implementation Guidelines

### 1) Model definitions

Add required header docstring to `services.py` (same standard used elsewhere in M3).

**ServiceIndexPage**

- Provide `intro` StreamField:

  - Use the project’s existing StreamField block set used for page bodies/intro areas (don’t invent a one-off block list).

- Add a `get_context()` (or equivalent) that returns:

  - `services = self.get_children().live().public().specific()` filtered to `ServicePage` (or robustly “child is ServicePage”).

**ServicePage**

- Fields:

  - `featured_image`: Wagtail image FK (nullable)
  - `short_description`: short text (set a max length and help_text)
  - `body`: StreamField (same block set as other pages)

- Panels:

  - `content_panels` should expose featured image, short_description, body
  - `promote_panels` should include SEO/OG panels from mixins (like HomePage does).

- Ensure the OG fallback chain behaves as intended (page OG → featured → site default) via the existing mixin logic.

### 2) Templates

**service_index_page.html**

- Renders:

  - Page title
  - `intro` StreamField
  - Grid of child services (cards)

- Cards should show:

  - Title
  - Short description (pull from child field)
  - Featured image (if present)
  - Link to the service page

**service_page.html**

- Renders:

  - Title
  - Featured image (if present)
  - Short description
  - Body StreamField
  - (Optional, defer if time) “Related services” can be simple siblings list, but since it’s P1 it must not block.

### 3) CSS / tokens

- Prefer reusing existing service card/grid styles if they already exist (you already have `services__grid` / `services__card` patterns in use).
- If you must add CSS:

  - Put it in the existing project structure (some repos still consolidate into `main.css`, others follow component files as described in the CSS guide).
  - Use tokens only.

### 4) Migrations (must-do checklist)

When finished with models:

- `python manage.py makemigrations`
- Confirm the migration file is created under the correct app’s migrations directory
- `python manage.py migrate`
- Verify clean state:

  - `python manage.py makemigrations --check --dry-run` should exit cleanly (no changes detected)

This prevents the exact “migrations weren’t ran” footgun you hit.

---

## Acceptance Criteria (testable)

1. **ServiceIndexPage exists**

- Can be created in admin
- Has intro StreamField
- Template renders intro + a grid of live child services

2. **ServicePage exists**

- Has: featured image, short description, StreamField body
- Uses M3 SEO/OG mixins and Promote tab shows fields (same pattern as HomePage/StandardPage).

3. **Hierarchy enforced**

- Cannot create a ServicePage under anything except ServiceIndexPage

4. **Migrations**

- Migration files committed
- Local migrate completes successfully
- No pending migrations after change (dry-run check passes)

5. **Tests**

- New tests exist and pass under `make test` (CI uses pytest against the test project).

---

## Testing Requirements

Aligning to the strategy: every P0 AC needs positive + negative coverage, and keep coverage ≥80%.

**Unit / integration tests to include**

- ✅ Can create ServiceIndexPage under root (or appropriate parent)
- ✅ Can create ServicePage under ServiceIndexPage
- ✅ ❌ Cannot create ServicePage under HomePage/StandardPage/root directly (negative)
- ✅ Index page context contains only live/public ServicePage children
- ✅ Render smoke: index page HTML contains the grid wrapper + at least one card when children exist

**Manual QA checklist**

- In admin:

  - Create ServiceIndexPage
  - Add 2–3 ServicePage children (mix of with/without featured image)
  - Publish

- Frontend:

  - Service index shows correct grid/cards
  - Service detail shows image (when present), short description, body
  - Meta tags render without errors (since templates include meta include already).

---

## Dependencies & Prerequisites

- M3-001 mixins + meta tag wiring already in place.
- Block library from M2 available for StreamField usage.

---

## Estimated Complexity

- Time: **L**
- Risk: **Medium** (hierarchy enforcement + templates + migration correctness)

---
