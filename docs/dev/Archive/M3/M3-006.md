**[M3-006] Lead model + form submission persistence (no lost leads)**

**Context** (from SSOT - Lead Management System)

* Business requirement excerpt: **“Create Lead record (ALWAYS succeeds)”** in the form submission flow. 
* Relevant user story: internal + client outcome is *no lost enquiries* (Lead capture survives downstream failures). This is a core testing objective and risk theme.
* Milestone alignment: Milestone 3 explicitly includes **“Forms capture to Lead model”** / “Form submissions create Lead records…” as milestone DoD.
* Current state: Page types + hierarchy are stabilised through M3-001 → M3-005.

---

## Technical Requirements (from SSOT)

### A) Implement canonical `Lead` persistence model

Implement the **Lead model** in `sum_core` per SSOT section **8.1 Lead Model**. 

Minimum required fields for this task (M3-006 scope):

* Core contact fields: `name`, `email`, `phone` (optional), `message`
* Form metadata: `form_type` (e.g. `contact`, `quote`), `form_data` (JSON)
* Page association: `source_page` FK to Wagtail `Page` (nullable, SET_NULL)
* Timestamps: `submitted_at` auto timestamp
* Workflow: `status` (default `new`)
* Soft delete: `is_archived` (default False)

**Deliberately defer (for later tasks):**

* Full attribution + LeadSourceRule derivation (SSOT 8.2)
* Integrations / email / Celery status fields (SSOT 8.3+ / 11.x)

### B) Form submission handler that *always* persists a Lead before any side-effects

Implement the “**Create Lead record (ALWAYS succeeds)**” invariant as the first durable step.

For M3-006, “always succeeds” means:

* For **valid submissions**, the Lead must be written to the DB before any optional downstream behaviour.
* If optional downstream behaviour fails (even if currently stubbed), the Lead remains persisted. (We can simulate this with a controlled failure hook in tests.)

### C) Admin visibility (minimum viable)

Provide an admin interface sufficient for internal verification:

* List view with key columns (submitted_at, name/email, form_type, source_page, status)
* Detail view showing form_data JSON clearly
* Read-only fields where appropriate (at least `submitted_at`), to avoid accidental editing in early stages

---

## Design Specifications (from SSOT)

* No frontend styling work required in this task; this is backend persistence + admin visibility. (Design system constraints still apply where templates are touched, but templates are not expected here.) 

---

## Implementation Guidelines

**Files to create/modify (align to current repo structure)**

* `core/sum_core/leads/models.py` (Lead model)
* `core/sum_core/leads/admin.py` or Wagtail admin integration location (depending on existing pattern)
* `core/sum_core/leads/apps.py` (if not already present)
* `core/sum_core/leads/__init__.py`
* Add app registration if needed (settings / `INSTALLED_APPS` for test project)
* Migration: `core/sum_core/leads/migrations/0001_initial.py` (or similar)
* Tests:

  * `tests/leads/test_lead_model.py`
  * `tests/leads/test_lead_submission_handler.py` (or `tests/forms/…` if you already have a forms test folder)

**Required header comments (all new Python modules)**

```python
"""
Name: Lead persistence
Path: core/sum_core/leads/models.py
Purpose: Store all inbound leads reliably (“no lost leads” invariant).
Family: Lead management, forms, integrations, admin visibility.
Dependencies: Django ORM, Wagtail Page model.
"""
```

**Model notes**

* Use type hints.
* Prefer `models.JSONField(default=dict)` for `form_data`.
* Use explicit `choices` for `status` per SSOT 8.1.
* Use `ForeignKey(Page, null=True, on_delete=models.SET_NULL)` for `source_page`.

**Submission handler notes**

* Implement a single internal function/service (preferred) rather than coupling to templates immediately, e.g.:

  * `core/sum_core/leads/services.py::create_lead_from_submission(...)`
* If you add an HTTP endpoint now (optional), it must:

  * validate minimally
  * call the service to persist
  * return a stable success response for valid submissions

**Migration requirements**

* Create + run migrations, and confirm `makemigrations --check --dry-run` is clean (as per your established workflow in prior tasks).

---

## Acceptance Criteria

1. **Lead model exists and migrates cleanly**

   * Migration applies without errors.
   * `makemigrations --check --dry-run` shows no pending changes. 

2. **Valid submissions create a Lead record**

   * Given a valid submission payload, a Lead is created with:

     * correct core fields
     * correct `form_type`
     * `form_data` persisted exactly
     * `status="new"` by default 

3. **“No lost leads” invariant holds for downstream failure (simulated)**

   * If a post-create hook (stubbed downstream step) raises an exception, the Lead record still exists.

4. **Admin visibility**

   * Leads are visible in admin with list + detail.
   * `form_data` is inspectable in a readable way.

5. **Tests**

   * Unit tests for Lead model defaults + field persistence. 
   * Integration-style tests for “submission → Lead created” + “downstream failure still persists Lead”. 
   * Coverage for touched modules meets the project bar (≥80% on affected area; overall already healthy).

---

## Dependencies & Prerequisites

* Milestone 2 form blocks exist (`ContactFormBlock`, `QuoteRequestFormBlock`) and can later call into this lead capture service. 
* Page hierarchy is stable after M3-005 (so `source_page` associations are reliable). 

---

## Testing Requirements (from test-strategy-v1.1.md)

* **Unit tests**: models (Lead), validators/service helpers. 
* **Integration tests**: form submission flows begin with Lead creation; explicitly test the “no lost leads” failure mode concept using a simulated downstream exception.
* Ensure DoD gates: lint/test pass; new behaviour has tests; coverage maintained. 

---

## Estimated Complexity

* **Time:** M
* **Risk:** Medium (foundational data model; future tasks build on it)
