## ✅ CM Ticket: Make Redis **required** in VPS Golden Path (remove “optional” ambiguity)

**[CM-M6-001-N1]: Redis is Mandatory for Production Golden Path**

**Objective**:
Update the M6-001 VPS Golden Path so Redis is **always installed, configured, and verified** as part of the default production stack—eliminating “optional” branching and aligning docs/scripts/health expectations.

---

### Context (from SSOT / Plan)

- SSOT runtime architecture includes Redis as part of the per-client runtime (cache + Celery broker).
- Post-MVP mega plan explicitly models Redis as part of the “Updated Stack” under Caddy + Gunicorn + Postgres + Redis + Celery.
- Current M6-001 report already notes that boilerplate production settings effectively require Redis (cache configured + `/health/` treats cache as critical).

**Why CM is needed**: right now the runbook language and provisioning flow still read like Redis is “optional” in places, but the system behaves as if it’s required. That mismatch will cause drift + operator confusion.

---

### Technical Requirements (what to change)

#### 1) Docs: Make Redis unambiguously required

**File:** `infrastructure/docs/vps-golden-path.md`

- Remove any “Redis only if…” phrasing.
- Move Redis into the baseline `apt install` block (or a clearly-marked “required” step immediately after).
- Add a short “Why Redis is required” section:

  - Django cache (performance + stability assumptions)
  - Celery broker (even if Celery itself remains non-critical)
  - Health check dependency: cache is critical in default stack

#### 2) Provisioning: Install + harden Redis by default

**File:** `infrastructure/scripts/provision_vps.sh` (or your equivalent helper)

Add:

- `apt install redis-server`
- `systemctl enable --now redis-server`
- Verify Redis is listening locally and responding:

  - `redis-cli ping` → `PONG`

**Hardening baseline (keep it boring & safe):**

- Ensure Redis is **not exposed publicly**

  - Confirm bind is localhost (`127.0.0.1 ::1`) and **UFW does not allow 6379**

- Document explicitly: “We do not open Redis to the internet. If you ever need remote access, stop and redesign.”

_(We can keep auth off if it’s strictly localhost-only; adding passwords introduces more secret handling and URL formatting. The key is: no public exposure.)_

#### 3) Deploy script: Optional sanity check (recommended)

**File:** `infrastructure/scripts/deploy.sh`

Before running migrations / restart:

- If `redis-cli` exists, run `redis-cli ping` and fail-fast if not `PONG`.
  This catches the “Redis service down” class of issues earlier than “why is /health failing”.

#### 4) systemd dependencies (small quality tweak)

**Files:** templates in `infrastructure/systemd/`

- Add `After=redis-server.service` and `Wants=redis-server.service` to:

  - gunicorn _only if_ your app hard-depends on cache at boot (often it doesn’t)
  - celery worker template should definitely want Redis (if Celery is enabled)

Keep Celery as **non-critical** (per current philosophy), but Redis can still be required for the default production stack.

---

### Acceptance Criteria

- Running the runbook on a fresh Ubuntu VPS always installs Redis and enables it.
- `redis-cli ping` returns `PONG`.
- `/health/` returns:

  - `200` for `ok`/`degraded`
  - `503` only for `unhealthy`

- Deploy script fails early with a clear message if Redis is down.
- No remaining documentation suggests Redis is “optional” for the default production deployment path.

---

### Dependencies & Prerequisites

- M6-001 already landed the runbook + scripts and updated `.env.example` etc.
- Confirm current production settings still configure Redis cache by default (they do per M6-001 report).

---

### Testing Requirements (from test-strategy-v1.1)

- **Manual staging validation** (required for ops):

  - Health endpoint behaves as expected
  - Backup script produces a restorable artifact; restore drill performed on staging

- Add/update a small “ops smoke checklist” section in the runbook:

  - `systemctl status redis-server`
  - `redis-cli ping`
  - `/health/` check

---

### Estimated Complexity

- **Time:** S
- **Risk:** Medium (docs/scripts changes can break the runbook if done sloppily; but contained)
- **Suggested Model:** GPT-5.1 (Med) or Claude Sonnet
