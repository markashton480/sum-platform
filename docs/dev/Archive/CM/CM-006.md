## **[CM-006]: Resolve M5-001 red flags (health contract, HomePage ownership, docs & tests alignment)**

**Objective**: Remove the three identified “shape” risks introduced by M5-001 so the platform is consistent, predictable, and ready for M5 factory work:

1. **Define and enforce** the `/health/` **HTTP status contract** (esp. degraded vs unhealthy).
2. **Clarify HomePage ownership** (client vs core vs harness) and prevent duplication/confusion.
3. **Update docs + tests** so nothing implicitly depends on `test_project` and the repo story stays coherent.

---

## **Context** (from PRD/README/Test Strategy)

- The platform currently documents `/health/` as an **observability baseline** returning JSON with DB/cache/Celery checks.
- The test strategy explicitly calls out health endpoint validation: “Health endpoint `/health/` returns expected JSON, including version and check statuses.”
- The README still describes **HomePage living in the core test harness**: “`HomePage` (in `core/sum_core/test_project/home/`)…”
- The PRD requires a `HomePage` model as P0, including “Only one HomePage allowed per site (enforced).”
- The M5-001 report shows `sum_client` now defines its own `HomePage` model and that `/health/` can return `"status": "degraded"` when Celery is unavailable.
- The M5-001 report also includes a test asserting `503` when degraded, which may not match the intended contract and could become brittle across clients.
- See also `M5-001_followup.md` report for additional context.

---

## **Technical Requirements**

### 1) Health endpoint contract (core + consumer tests)

- Decide and document the **authoritative contract** for `/health/`:

  - What statuses exist (`ok`, `degraded`, `fail`/`unhealthy`), and
  - Which statuses map to which **HTTP status codes** (e.g. always `200` with JSON status vs `503` for degraded/unhealthy).

- Ensure **`sum_core.ops`** implements this contract consistently for consumers. (Do _not_ duplicate health logic in `sum_client`.)
- Update `clients/sum_client/tests/test_health.py` to reflect the contract:

  - Keep tests focused on **structure** (“JSON contains status + checks”) as per test strategy, not internal check ordering or fragile assumptions.

### 2) HomePage ownership + duplication guardrails

- Establish a single “source of truth” decision:

  - **Option A (recommended for M5):** HomePage lives in `sum_client` (client-owned “content layer”), core provides mixins/templates/blocks only.
  - **Option B:** HomePage moved into `sum_core/pages/` (core-owned page types).

- Whichever option is chosen:

  - Update docs to remove ambiguity (README + wiring inventory references).
  - Ensure there is no accidental “two HomePages” possibility across harness/client.

- Maintain PRD requirement: “Only one HomePage allowed per site (enforced).”

### 3) Documentation alignment (stop implying test harness is the product)

- Update repo docs so “how to run” and “what is real vs planned” do not mislead:

  - README currently frames `test_project` as the main run target and includes test-project-specific DB notes.
  - Align this with M5’s direction: `sum_client` is the canonical consumer and should be the recommended “real site” reference moving forward (even if `test_project` remains for CI harnessing).

### 4) Dependency pinning clarity

- Ensure the client consumer’s dependency story matches the PRD’s boilerplate requirement: pinned `sum-core==X.Y.Z` (or, for our chosen approach, pinned to a git tag equivalent) and clearly explained.

---

## **Design Specifications**

- None (behavioral + documentation corrective mission).

---

## **Implementation Guidelines**

### Files to modify (expected)

- `core/sum_core/ops/` (health endpoint implementation + docs/comments as needed)
- `clients/sum_client/tests/test_health.py` (align to chosen HTTP contract)
- `README.md` (update HomePage location + “what to run” narrative, reduce test_project-centric wording)
- Any “wiring inventory” / dev docs referenced by README as needed (keep minimal but accurate).

### Required header comments

All new Python modules must include:

```python
"""
Name: [Module Name]
Path: [File path]
Purpose: [Brief description]
Family: [What depends on this]
Dependencies: [What this depends on]
"""
```

### Principles

- **Single source of truth** for health semantics: enforce in core, validate in consumer.
- Tests should verify:

  - JSON shape (`status`, `checks`, optionally `version`)
  - HTTP status mapping rules (but only as per contract; no guesswork)

- Documentation should describe the real developer path:

  - `test_project` can remain the harness, but docs must stop implying it’s the primary “real client” reference now that `sum_client` exists.

---

## **Acceptance Criteria**

### Health endpoint

- `/health/` contract is documented (in code docstring and/or dev docs) and reflected in tests.
- `clients/sum_client/tests/test_health.py` no longer contains ambiguous/contradictory expectations (e.g. “200 always” _and_ “503 when degraded” unless contract explicitly defines that split).

### HomePage clarity

- README no longer claims HomePage lives in `core/sum_core/test_project/home/` if `sum_client` is the canonical location.
- Clear statement exists describing where HomePage lives and why (client vs core), preventing future duplication.

### Docs

- README “Quick Start” (or equivalent) includes a clear “real client consumer” path using `clients/sum_client` (even if test_project remains documented for CI/dev harnessing).
- When finished this task, generate a full work report and file in `docs/dev/CM/CM-006_followup.md`.

### Dependency pinning narrative

- `sum_client` dependency guidance matches the PRD boilerplate expectations (pinned core version / pinned tag strategy clearly stated).

---

## **Dependencies & Prerequisites**

- M5-001 is merged or at least available locally for modification.
- No major refactor inside `sum_core` beyond clarifying/enforcing contracts (fits M5 non-goals).

---

## **Testing Requirements** (from test strategy v1.1)

- Maintain CI gates: lint + type-check + tests, coverage ≥ 80% overall.
- Add/adjust integration-level tests ensuring:

  - `/health/` returns expected JSON shape and status behavior.

---

## **Estimated Complexity**

- **Time:** S–M
- **Risk:** Medium (contract decisions propagate into future boilerplate + monitoring + uptime checks)
- **Suggested Model:** GPT-5.2 Thinking (decision clarity + cross-cutting consistency)

---

### Practical recommendation (to reduce future pain)

Pick one of these now and bake it in:

- **Health contract**:

  - `200` for `ok`/`degraded`, `503` only for `unhealthy` (hard fail).
    This makes uptime monitors usable without “Celery down” causing false alarms, while still letting you fail hard when DB/cache are dead.

- **HomePage ownership**:

  - Keep it in `sum_client` for M5 (client content layer), and treat `test_project` as a harness-only fixture.
    This matches the “factory” mental model and keeps `sum_core` more reusable across different client page-model decisions.
