## **[CM-01]: Production Hardening Sweep (Forms, Tasks, Caching, App Registration)**

**Objective**: Eliminate the **blockers and high-priority production risks** identified in the 2025-12-14 code review by fixing form-template security issues, strengthening server-side validation, making async lead notifications idempotent under concurrency, reducing nav cache staleness risk, and ensuring SEO app registration is not test-only. 

---

## **Context** (from SSOT - PRD Section)

This corrective mission exists because the daily code review flagged:

* **BLOCKER**: XSS/CSP risk from template variables embedded inside inline JS string literals in form templates.
* **BLOCKER**: Missing email format validation in form submission handler.
* **HIGH**: Potential Celery race condition causing duplicate emails/webhooks.
* **HIGH**: Navigation cache TTL hardcoded to 1 hour, causing “changes don’t appear” UX.
* **HIGH**: Missing phone validation (optional but if supplied must be sane).
* **Also relevant to M4**: `sum_core.seo` being registered only in test settings risks “works in tests, fails in real runtime”. 

---

## **Technical Requirements** (from SSOT - Tech Spec Section)

### A) Forms: remove inline JS template interpolation and prevent XSS/CSP issues (BLOCKER)

**Target files** (per report):

* `core/sum_core/templates/sum_core/blocks/contact_form.html`
* `core/sum_core/templates/sum_core/blocks/quote_request_form.html` 

**Required change**

* Stop doing this pattern (or equivalents):

  * `innerHTML = '<p> {{ template_var }} </p>'`
* Move success/error messages to one of:

  * `data-*` attributes on the form (preferred), or
  * hidden DOM template nodes that are cloned.
* The JS must build DOM content safely (string concat OK if source is trusted admin content, but do not inject raw template output into JS string literals).

**Acceptance intent**

* Eliminates XSS vectors, quote-breaking bugs, and future CSP conflicts. 

---

### B) Forms: add server-side email validation (BLOCKER)

**Target file**:

* `core/sum_core/forms/views.py` in `_validate_submission` 

**Required change**

* Validate email **format** using Django’s built-in validator (`validate_email`).
* Presence checks are not sufficient.

**Required tests**

* Add/extend tests to assert invalid email is rejected and does **not** create a Lead. 

---

### C) Forms: add server-side phone validation (HIGH)

**Target file**:

* `core/sum_core/forms/views.py` in `_validate_submission` 

**Required change**

* Phone remains optional, but if provided it must be validated.
* Choose one approach and implement consistently:

  * `phonenumbers` (best), default region `GB`, or
  * a minimal UK regex (acceptable if you want no dependency).

**Required tests**

* Invalid phone is rejected; valid phone passes. 

---

### D) Lead notification tasks: prevent duplicate sends under concurrency (HIGH)

**Target file**:

* `core/sum_core/leads/tasks.py` (email + webhook tasks) 

**Required change**

* Make status transitions concurrency-safe:

  * Use `select_for_update()` inside an atomic transaction when checking/updating send status.
* Ensure idempotency claims are actually true when tasks overlap (retry + new trigger).

**Required tests**

* Add at least one test that simulates the “double-run” scenario and asserts only one send path can mark SENT (mock send function). 

---

### E) Navigation caching: reduce staleness risk (HIGH)

**Target file**:

* `core/sum_core/navigation/templatetags/navigation_tags.py` 

**Required change (short-term)**

* Reduce default TTL from 3600 to **300 seconds** (5 minutes), unless overridden by a documented settings value.

**Required tests (lightweight)**

* If you have a nav cache helper, add a unit test verifying default TTL is 300 and settings override is respected.

---

### F) Ensure `sum_core.seo` app registration is not test-only (M4 stability)

**Problem**

* The report flags “tests were removed/reinstated” and you also observed `sum_core.seo` was added to INSTALLED_APPS in **test project settings** to fix tag discovery — we must ensure this doesn’t become test-only behaviour. 

**Required change**

* Audit all settings entry points (core test project + client/boilerplate settings).
* Ensure `sum_core.seo` is included consistently in runtime contexts (not “only in tests”).

---

## **Design Specifications** (from SSOT - Design Section)

* No UI redesign.
* Template changes must preserve current markup structure for forms (classes, tokens, layout).
* Replace inline styles where flagged (optional polish in CM-02 if this becomes too large). 

---

## **Implementation Guidelines**

**Files to create/modify (expected)**

* Modify:

  * `core/sum_core/templates/sum_core/blocks/contact_form.html`
  * `core/sum_core/templates/sum_core/blocks/quote_request_form.html`
  * `core/sum_core/forms/views.py`
  * `core/sum_core/leads/tasks.py`
  * `core/sum_core/navigation/templatetags/navigation_tags.py`
  * relevant settings modules / boilerplate settings

**Strong suggestion**

* While touching form templates, consider extracting duplicated inline AJAX submission JS into:

  * `core/sum_core/static/sum_core/js/form_submission.js`
  * and initialize via `data-*` config (this aligns with the review’s tech-debt note), BUT do not let it balloon—security/validation first. 

---

## **Acceptance Criteria**

**Security / Forms**

* [ ] No template variables embedded inside JS string literals in form templates.
* [ ] Success/error messaging is implemented via data attributes or hidden DOM templates.
* [ ] Invalid email formats are rejected server-side and do not create Leads.
* [ ] Invalid phone formats (if provided) are rejected server-side.

**Async idempotency**

* [ ] Email task and webhook task cannot double-send under concurrent execution (DB lock + status gating).
* [ ] Tests cover at least one concurrency/idempotency scenario.

**Navigation**

* [ ] Default nav cache TTL is 300 seconds (or overridden by explicit setting).
* [ ] Editor navigation changes no longer “stick” for up to an hour by default.

**Runtime correctness**

* [ ] `sum_core.seo` is registered consistently outside of test settings (no “works only in tests” trap).

**Quality gates**

* [ ] `make test` passes.
* [ ] `make lint` passes. 

---

## **Dependencies & Prerequisites**

* Current main branch includes M3 + M4 work referenced by the report.
* No migrations expected unless you introduce `phonenumbers` and add settings, etc. (avoid schema changes in this CM).

---

## **Testing Requirements** (from test-strategy-v1.1.md + review)

* Add tests for:

  * `test_invalid_email_rejected`
  * `test_malformed_phone_rejected`
  * `test_duplicate_email_tasks_only_send_once` (mock send call)
* Keep tests deterministic; do not skip/xfail to “get green”. 

---

## **Estimated Complexity**

* **Time:** M (because it touches multiple layers)
* **Risk:** High (security + async correctness)
* **Payoff:** Very high (prevents production incidents/support tickets)

---
