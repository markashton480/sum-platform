## [M2-003] Service Cards Block for HomePage StreamField

> **Implementation Plan mapping:** `BLOCKS-003 – Service Cards Block` (Milestone 2: StreamField Blocks)
> **PRD mapping:** `US-B02: Service Cards Block` (Epic: StreamField Blocks)

---

### Task ID

**Task ID**: M2-003 (BLOCKS-003 – Service Cards Block)
**Title**: ServiceCardsBlock – Configurable Service Grid

---

### Goal

Implement a `ServiceCardsBlock` (with service card items) and wire it into `PageStreamBlock`, so editors can showcase 1–12 services in a responsive, token-based card grid that matches the premium trade design.

---

### Workstream & Milestone

- **Workstream**: 3 – StreamField Blocks
- **Milestone**: 2 – StreamField Blocks

---

### Inputs Required

**PRD**

- **Epic: StreamField Blocks → US-B02: Service Cards Block**

  > As a content editor, I want service card blocks so that I can showcase services in an attractive grid layout.

  Acceptance criteria include:

  - `ServiceCardsBlock` with 3-column desktop, 2-column tablet, 1-column mobile grid.
  - Each card: icon (SVG or image), title, description (rich text), link (optional).
  - 1–12 cards per block.
  - Hover states with smooth transitions (transform, shadow).
  - Cards maintain equal height in a row.
  - Unit tests for block structure and card count validation.

**Implementation Plan**

- Milestone 2 table:

  - `BLOCKS-003 | Service Cards Block | M (4–5h)`

**Project Initiation Packet**

- **Sprint 2 – S2-US02: Service Cards Block** repeats much of the above (3-col desktop grid, 1-col mobile, 1–12 cards, tests).
- Repo structure:

  - `core/sum_core/blocks/services.py` – StreamField blocks for services.
  - `core/sum_core/templates/sum_core/blocks/` – block templates.

**Design References**

- **SolarCraft Premium design system** (`design_system.md`):

  - “Frame, not the paint”: strict layout and spacing, dynamic token system for colors.
  - Card materiality: surfaces, radii, subtle borders and elevation via tokens, no hard-coded hex.

- **Premium Trade HTML reference** (`premium-trade-website-v3-final.html`):

  - “Services” / features section:

    ```html
    <section class="section" id="services">
      <div class="container">
        <div class="features-header">
          <h2>More Than Just Panels.</h2>
          <p>Comprehensive energy architecture for the modern home.</p>
        </div>
        <div class="features-container">
          <div class="feature-card">
            <span class="feature-icon">✦</span>
            <h3>Aesthetic Integration</h3>
            <p>…description…</p>
          </div>
          …
        </div>
      </div>
    </section>
    ```

  - Uses responsive grid, hover elevation, token-based colors (`hsla(var(--surface-pure)…)`, etc.).

**Test Strategy**

- StreamField blocks (Hero, ServiceCards, Testimonials, etc.) are P0 with high unit test depth and integration tests around page rendering.

---

### Context (from PRD – business & UX)

- Editors need to highlight key offerings (e.g. “Aesthetic Integration”, “Energy Autonomy”) in a **visually rich but consistent** way across client sites.
- The block must:

  - Be easy to manage in Wagtail: add/remove/reorder cards with clear constraints (1–12).
  - Always land on a **premium layout**: equal-height cards, clean grid, elegant hover transitions.
  - Stay brand-agnostic: colors, typography, and shadows driven by the token system, not client-specific hex codes.

- This block will be used on **homepages and service pages** as a major visual anchor just below the hero.

---

### Technical Requirements

#### 1. Block module: `sum_core.blocks.services`

Create `core/sum_core/blocks/services.py`:

```python
"""
Name: Service Blocks
Path: core/sum_core/blocks/services.py
Purpose: StreamField blocks for service card grids
Family: Used by PageStreamBlock and core page models (HomePage, ServicePage, etc.)
Dependencies: Wagtail blocks, wagtailimages, sum_core.blocks.base, design system CSS
"""
```

Implement:

1. **ServiceCardItemBlock**

   - `StructBlock` representing a single service card:

     - `icon` – `CharBlock(required=False, max_length=4, help_text="Emoji or short icon text (optional)")`

       - Used for simple iconography (e.g. ✦, ⚡); optional because we also support an image.

     - `image` – `ImageChooserBlock(required=False)`

       - Allows proper image/icon; render as the primary visual if present.

     - `title` – `CharBlock(required=True, max_length=120)`
     - `description` – `RichTextBlock` limited to paragraphs + basic inline formatting (no headings, no H1):

       - Use the same feature set we chose for the base `rich_text` block (e.g. bold, italic, lists, links).

     - `link_url` – `URLBlock(required=False)`
     - `link_label` – `CharBlock(required=False, max_length=50, help_text="Defaults to “Learn more” if left blank.")`

   - Type hints on class and any helper methods.

2. **ServiceCardsBlock**

   - `StructBlock` that owns the section:

     - `eyebrow` – `CharBlock(required=False, max_length=120, help_text="Short label above the heading (optional).")`
     - `heading` – `CharBlock(required=True, max_length=150)`
     - `intro` – `TextBlock(required=False, help_text="Short supporting paragraph.")`

       - Could be rendered as `<p class="text-body text-muted">…</p>`.

     - `cards` – `ListBlock(ServiceCardItemBlock(), min_num=1, max_num=12)`
     - Optional layout controls (keep minimal):

       - `layout_style` – `ChoiceBlock(choices=[("default", "Default"), ("tight", "Tight spacing")], default="default", required=False)` – mainly to future-proof spacing variants.

   - Meta:

     ```python
     class Meta:
         template = "sum_core/blocks/service_cards.html"
         icon = "list-ul"
         label = "Service cards"
         help_text = "Showcase services in a responsive card grid (1–12 cards)."
     ```

#### 2. Integrate with `PageStreamBlock`

- Update `core/sum_core/blocks/base.py`:

  - Import `ServiceCardsBlock` from `.services`.
  - Add to `PageStreamBlock`:

    ```python
    class PageStreamBlock(blocks.StreamBlock):
        hero_image = HeroImageBlock(group="Hero")
        hero_gradient = HeroGradientBlock(group="Hero")
        service_cards = ServiceCardsBlock(group="Services")
        rich_text = RichTextBlock(..., group="Content")
        # existing blocks stay intact
    ```

- Ensure the new entry doesn’t break migrations (no lambdas or in-line nested class definitions that affect deconstruction).

- Export from `core/sum_core/blocks/__init__.py`:

  ```python
  from .services import ServiceCardsBlock, ServiceCardItemBlock
  ```

#### 3. Templates: `service_cards.html`

Create `core/sum_core/templates/sum_core/blocks/service_cards.html`:

- Use existing layout primitives:

  ```django
  {% load wagtailcore_tags wagtailimages_tags %}

  <section class="section section--inset services">
      <div class="container">
          <div class="services__header">
              {% if self.eyebrow %}
                  <p class="text-muted services__eyebrow">{{ self.eyebrow }}</p>
              {% endif %}
              <h2 class="heading-lg services__heading">
                  {{ self.heading }}
              </h2>
              {% if self.intro %}
                  <p class="text-body text-muted services__intro">
                      {{ self.intro }}
                  </p>
              {% endif %}
          </div>

          {% if self.cards %}
              <div class="services__grid">
                  {% for card in self.cards %}
                      <article class="card services__card">
                          <div class="card__body">
                              {% if card.image %}
                                  <div class="services__icon services__icon--image">
                                      {% image card.image fill-160x160 class="services__icon-image" %}
                                  </div>
                              {% elif card.icon %}
                                  <div class="services__icon services__icon--emoji">
                                      {{ card.icon }}
                                  </div>
                              {% endif %}

                              <h3 class="heading-md services__card-title">
                                  {{ card.title }}
                              </h3>

                              {% if card.description %}
                                  <div class="text-body services__card-description">
                                      {{ card.description|richtext }}
                                  </div>
                              {% endif %}

                              {% if card.link_url %}
                                  <div class="services__card-link">
                                      <a href="{{ card.link_url }}" class="btn btn--link">
                                          {{ card.link_label|default:"Learn more" }}
                                      </a>
                                  </div>
                              {% endif %}
                          </div>
                      </article>
                  {% endfor %}
              </div>
          {% endif %}
      </div>
  </section>
  ```

- Styling expectations:

  - `services__grid` should use CSS Grid or Flexbox:

    - Mobile: 1 column.
    - Tablet: 2 columns.
    - Desktop: 3 columns.

  - Cards must stretch to the same height per row (e.g. `align-items: stretch;` and `.card { height: 100%; display: flex; flex-direction: column; }`).
  - Hover states via CSS transitions on transform/shadow.

- **No inline styles** and **no raw hex/px values**; rely on:

  - Section spacing via `.section` and spacing tokens (`--space-*`).
  - Surfaces via palette tokens (`--color-surface`, `--color-surface-elevated`, `--color-text`, etc.).
  - Borders/shadows via token-based variables.

#### 4. CSS: extend `main.css` minimally

Add small, token-based CSS in `core/sum_core/static/sum_core/css/main.css`:

- A grid utility for services:

  ```css
  .services__grid {
    display: grid;
    gap: var(--space-xl);
    grid-template-columns: 1fr;
  }

  @media (min-width: 768px) {
    .services__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .services__grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  .services__card {
    height: 100%;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .services__card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
  }

  .services__icon {
    margin-bottom: var(--space-md);
  }

  .services__icon--emoji {
    font-size: var(--text-3xl);
  }
  ```

- Use existing `.card` base styles for padding, background, border, radius where possible.

---

### Design Specifications

- **Layout**

  - Section uses `.section` + `.container`, optionally `.section--inset` to echo the reference design’s vertical rhythm.
  - Header area mirrors “More Than Just Panels” pattern: heading plus a short intro paragraph.
  - Grid: 3-col desktop, 2-col tablet, 1-col mobile (matching PRD / Initiation Packet).

- **Visual style**

  - Card surfaces use token-based background and border (e.g. `var(--color-surface-elevated)`, `var(--shadow-sm/md)`).
  - Hover:

    - Slight upward shift (`translateY(-4px)` or similar).
    - Mild shadow change using token (no heavy drop shadows).

- **Typography**

  - Section heading: `heading-lg`.
  - Card title: `heading-md`.
  - Body copy: `text-body`.
  - Intro text / eyebrow: `text-muted` class where appropriate.

- **Accessibility**

  - Card titles as `<h3>` for semantic structure beneath an `<h2>` section heading.
  - Link text must be meaningful (fallback “Learn more” is acceptable for now, but a future enhancement may encourage more descriptive labels).
  - Icons/images are decorative; alt text is not mandatory for the image icon if the title conveys the main meaning.

---

### Implementation Guidelines

**Files to Create**

- `core/sum_core/blocks/services.py`
- `core/sum_core/templates/sum_core/blocks/service_cards.html`
- Tests:

  - `tests/blocks/test_service_cards_block.py` (new)
  - Optional: `tests/templates/test_service_cards_template.py` or extend existing page tests.

**Files to Modify**

- `core/sum_core/blocks/__init__.py` – export `ServiceCardsBlock`, `ServiceCardItemBlock`.
- `core/sum_core/blocks/base.py` – add `service_cards` to `PageStreamBlock`.
- `core/sum_core/static/sum_core/css/main.css` – add services grid/card hover rules using tokens.
- `tests/pages/test_home_page.py` – add integration test case that includes `service_cards` in `page.body`.

**Coding Standards**

- Header comment on any new Python file (as above).
- Type hints for block classes and helper methods.
- Follow existing patterns for blocks (e.g. how hero blocks are structured and integrated).
- Keep abstractions light: don’t prematurely create a shared “LinkBlock” unless it’s trivial and clearly reusable.

---

### Acceptance Criteria

- [ ] `ServiceCardItemBlock` and `ServiceCardsBlock` are implemented in `sum_core.blocks.services` with fields matching PRD (icon/image, title, description, optional link; 1–12 cards).
- [ ] `PageStreamBlock` includes `service_cards` with `group="Services"` and existing blocks remain intact.
- [ ] `ServiceCardsBlock` has `Meta.template = "sum_core/blocks/service_cards.html"` and renders without errors.
- [ ] The `service_cards` block renders a responsive grid:

  - 3 columns on desktop, 2 on tablet, 1 on mobile.
  - Cards maintain equal height within each row.

- [ ] Card hover state uses smooth transform/shadow transitions and token-based CSS (no inline styles or raw hex/px).
- [ ] Wagtail editors can:

  - Add a `Service cards` block to `HomePage.body`.
  - Configure 1–12 cards.
  - See the block preview in admin without errors.

- [ ] A `HomePage` using `service_cards` renders successfully on `/` with visible card titles, descriptions, and optional links.
- [ ] Unit tests cover:

  - Card count validation (0 and >12 rejected).
  - Required fields (`title`) enforced.
  - Block deconstruction/reconstruction for migrations.

- [ ] Integration tests cover:

  - Page rendering with a `service_cards` block.
  - Presence of expected heading, service titles, and key CSS classes in HTML.

- [ ] `make test` and `make lint` still pass.

---

### Dependencies & Prerequisites

- **Completed**:

  - M2-001: `PageStreamBlock` and base StreamField infrastructure.
  - M2-002: Hero blocks integrated and rendering correctly.

- **Required**:

  - Design system tokens & `.card` component in `main.css` from Milestone 1.
  - Wagtail images set up and working (media serving issues already resolved in dev).

---

### Testing Requirements

**Unit Tests (`tests/blocks/test_service_cards_block.py`)**

- `ServiceCardItemBlock`:

  - Valid data passes clean().
  - Missing title raises validation error.
  - Link URL validation behaves as expected.

- `ServiceCardsBlock`:

  - `cards` with 0 items fails (min_num=1).
  - `cards` with 13 items fails (max_num=12).
  - Deconstruction/reconstruction works (block can be used in migrations without issues).

**Integration Tests**

- Extend `tests/pages/test_home_page.py`:

  - Create a `HomePage` instance with `body` containing:

    - A `service_cards` block with at least 3 cards.

  - Render the page and assert:

    - Response contains section heading text.
    - At least one card title and description appear.
    - Grid wrapper class (e.g. `services__grid`) is present.

**Manual Checks**

In Wagtail admin:

1. Add a `Service cards` block under the hero on `HomePage`.
2. Configure 3–6 cards with mix of icon-only, image-only and both.
3. Publish and verify:

   - Layout matches expectations on mobile, tablet, desktop.
   - Hover interactions feel smooth and premium.
   - Equal-height cards per row.

4. Try to create block with 0 cards → validation prevents it.

---

### Estimated Effort

- **Time**: **M (4–5 hours)**
- **Risk**: Low–Medium (block implementation is straightforward; subtle CSS and equal-height grid behaviours need a bit of care but are well understood).
