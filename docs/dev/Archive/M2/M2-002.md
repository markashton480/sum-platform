## [M2-002] Hero Blocks for HomePage StreamField

> **Implementation Plan mapping:** `BLOCKS-002 – Hero Blocks` (Milestone 2: StreamField Blocks)

---

### Task Card

**Task ID**: M2-002 (BLOCKS-002 – Hero Blocks)

**Title**: HeroImageBlock & HeroGradientBlock + HomePage Integration

**Goal**:
Implement hero StreamField blocks (`HeroImageBlock` and `HeroGradientBlock`) and wire them into the existing `PageStreamBlock`/`HomePage` so editors can configure page hero sections via Wagtail, matching the premium trade layout while respecting the token-based design system.

**Workstream**:
3 – **StreamField Blocks**

**Milestone**:
2 – **StreamField Blocks**

---

### Inputs Required

**PRD Sections**

* **2.3 Epic: StreamField Blocks – US-B01: Hero Blocks**

  > As a content editor, I want hero section blocks so that I can create impactful page headers with flexible layouts.

  | ID  | Acceptance Criteria                                                                 |
  | --- | ----------------------------------------------------------------------------------- |
  | AC1 | `HeroImageBlock`: Full-width image background with configurable overlay opacity     |
  | AC2 | `HeroGradientBlock`: Gradient background using brand colours                        |
  | AC3 | Configurable fields: headline (required), subheadline (optional), CTA buttons (0–2) |
  | AC4 | CTA button options: text, URL, style (primary/secondary/outline), open in new tab   |
  | AC5 | Image field with required alt text for `HeroImageBlock`                             |
  | AC6 | Responsive: Text stacks properly on mobile, image scales appropriately              |
  | AC7 | Preview renders correctly in Wagtail admin                                          |
  | AC8 | Unit tests validate block structure and required fields                             |

* **2.4 Epic: Page Types – US-P01: Homepage**

  > As a content editor, I want a flexible homepage so that I can create an engaging entry point for visitors.

  Key points:

  * `HomePage` model with **StreamField body accepting all homepage blocks** (including Hero).
  * Template renders all blocks with proper spacing.

* **6.6 Design Implementation Guardrails**

  * Token-only styling: all colors, type, spacing, radii, shadows via CSS variables/design tokens.
  * Component reuse: use existing button, layout, and section primitives.
  * Grid & spacing consistency: section padding via spacing tokens, no arbitrary px; headings/typography via token scale.

**Implementation Plan Sections**

* **Milestone 2 task table**

  * `BLOCKS-002 – Hero Blocks` (Effort L 5–6h).
* **Task Card Template** (Section 3, already used on M2-001).

**Project Initiation Packet**

* Repo layout for blocks:

  * `sum_core/blocks/hero.py` for hero block definitions.
  * `sum_core/templates/sum_core/blocks/` for block templates.

* Sprint 2 / S2-US01 “Hero Blocks” mirrors PRD’s hero acceptance criteria (Image + Gradient variants, configurable content, responsive, tests).

**Design References**

* **Design System – SolarCraft Premium**

  * Layout & spacing rules:

    * “Breath” (generous vertical section padding).
    * “Pinky” rule for tappable elements.
    * “Gallery” rule for media sizing.
  * Type scale and hierarchy (display heading, supporting copy, button hierarchy).
  * Emphasis on **structure + spacing + material** over fixed colors.

* **Premium Trade reference HTML**

  * Hero section markup uses something like:

    ```html
    <section class="section hero">
      <div class="container hero-grid">
        <div class="hero-content">
          <div class="hero-status">…</div>
          <h1>…</h1>
          <p class="hero-desc">…</p>
          <div class="hero-actions">
            <a class="btn btn-primary">…</a>
            <a class="btn btn-outline">…</a>
          </div>
        </div>
        <div class="hero-visual">
          <img class="hero-main-img" …>
          <div class="float-card">…</div>
        </div>
      </div>
    </section>
    ```

  * Use this as a **structural** reference, but update CSS to comply with token rules and existing `main.css` utilities.

**Test Strategy**

* StreamField blocks are **P0**:

  * High unit test depth on fields/validation.
  * Integration tests ensuring blocks render on key pages (HomePage).
  * Editor-facing failure modes minimized (invalid config should be clear).

---

### Context (from PRD – business & UX)

* Hero block is the **first impression** for each page, and **non-technical editors** must be able to configure it: switch between image-based hero and gradient-based hero without code changes.
* Layout must still feel consistently “premium” regardless of brand colors/fonts:

  * Strong, spacious hero with clear headline hierarchy and crisp CTAs.
* The hero system must be **safe**:

  * Enforce required copy (headline).
  * Limit CTAs to 0–2 with clear styles.
  * Require alt text on images for accessibility.
* M2-002 is about **moving the hero from hard-coded template** into a well-defined block structure, connected to the design system and SiteSettings-driven branding.

---

### Technical Requirements

#### 1. Block Definitions (`sum_core.blocks.hero`)

Create a new module:

* `core/sum_core/blocks/hero.py`

  With header comment:

  ```python
  """
  Name: Hero Blocks
  Path: core/sum_core/blocks/hero.py
  Purpose: StreamField hero blocks (image/gradient) for page headers
  Family: Used by PageStreamBlock and page models (HomePage, future core pages)
  Dependencies: Wagtail blocks, sum_core.blocks.base, CSS design system
  """
  ```

Implement:

1. **Common CTA block**

   ```python
   class HeroCTABlock(blocks.StructBlock):
       label = blocks.CharBlock(required=True, max_length=100)
       url = blocks.URLBlock(required=True)
       style = blocks.ChoiceBlock(
           choices=[
               ("primary", "Primary"),
               ("secondary", "Secondary"),
               ("outline", "Outline"),
           ],
           default="primary",
       )
       open_in_new_tab = blocks.BooleanBlock(required=False, default=False)
   ```

   * Use type hints on the class and any helper methods.
   * This will be reused later by CTA blocks/content blocks if needed.

2. **Base hero struct (optional but useful)**

   ```python
   class BaseHeroBlock(blocks.StructBlock):
       headline = blocks.CharBlock(required=True, max_length=150)
       subheadline = blocks.TextBlock(required=False)
       ctas = blocks.ListBlock(
           HeroCTABlock(),
           min_num=0,
           max_num=2,
           required=False,
       )
       # Optional: small "eyebrow/status" text field
       status = blocks.CharBlock(required=False, max_length=120)
   ```

   * Mark it `abstract = True` in `Meta` if you use it as a base.
   * Keep fields aligned with PRD (headline required, subheadline optional, 0–2 CTAs).

3. **HeroImageBlock**

   ```python
   class HeroImageBlock(BaseHeroBlock):
       image = ImageChooserBlock(required=True)
       image_alt = blocks.CharBlock(required=True, max_length=150)
       overlay_opacity = blocks.ChoiceBlock(
           choices=[
               ("none", "No overlay"),
               ("light", "Light"),
               ("medium", "Medium"),
               ("strong", "Strong"),
           ],
           default="medium",
       )

       class Meta:
           template = "sum_core/blocks/hero_image.html"
           icon = "image"
           label = "Hero (Image)"
           help_text = "Full-width image hero with overlay and CTA buttons."
   ```

   * `overlay_opacity` gives the “configurable overlay opacity” required in PRD.
   * Implementation detail of exact opacity values is in the template/CSS.

4. **HeroGradientBlock**

   ```python
   class HeroGradientBlock(BaseHeroBlock):
       gradient_style = blocks.ChoiceBlock(
           choices=[
               ("primary", "Primary gradient"),
               ("secondary", "Secondary gradient"),
               ("accent", "Accent gradient"),
           ],
           default="primary",
       )

       class Meta:
           template = "sum_core/blocks/hero_gradient.html"
           icon = "placeholder"
           label = "Hero (Gradient)"
           help_text = "Hero with gradient background using brand colours."
   ```

   * Gradients should be built using existing token values (`var(--color-primary)` etc.) inside CSS/template, not hard-coded hex.

5. **Exports**

   In `core/sum_core/blocks/__init__.py`:

   * Import and re-export:

     ```python
     from .base import PageStreamBlock
     from .hero import HeroImageBlock, HeroGradientBlock, HeroCTABlock
     ```

   * Ensure the public interface stays clean (`__all__ = [...]` is helpful).

#### 2. Integrate Hero Blocks into `PageStreamBlock`

* Update `core/sum_core/blocks/base.py`:

  * Extend `PageStreamBlock` to include hero block types, grouped appropriately in Wagtail:

    ```python
    class PageStreamBlock(blocks.StreamBlock):
        hero_image = HeroImageBlock(group="Hero")
        hero_gradient = HeroGradientBlock(group="Hero")

        # existing entries like:
        # rich_text = blocks.RichTextBlock(..., group="Content")
        # (leave existing blocks intact)
    ```

  * Ensure deconstruction works (no lambdas, nested inline classes that break migrations).

#### 3. Template Implementation for Hero Blocks

Create new templates:

* `core/sum_core/templates/sum_core/blocks/hero_image.html`
* `core/sum_core/templates/sum_core/blocks/hero_gradient.html`

Guidelines:

* Use semantic structure inspired by the reference hero:

  ```django
  <section class="section section--hero hero">
      <div class="container hero__grid">
          <div class="hero__content">
              {% if self.status %}
                  <p class="hero__status text-muted">{{ self.status }}</p>
              {% endif %}
              <h1 class="heading-xl">
                  {{ self.headline }}
              </h1>
              {% if self.subheadline %}
                  <p class="hero__desc text-body">
                      {{ self.subheadline }}
                  </p>
              {% endif %}
              {% if self.ctas %}
                  <div class="hero__actions">
                      {% for cta in self.ctas %}
                          <a
                            href="{{ cta.url }}"
                            class="btn {% if cta.style == 'primary' %}btn--primary{% elif cta.style == 'secondary' %}btn--secondary{% else %}btn--ghost{% endif %}"
                            {% if cta.open_in_new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}
                          >
                              {{ cta.label }}
                          </a>
                      {% endfor %}
                  </div>
              {% endif %}
          </div>

          {# For HeroImageBlock: #}
          <div class="hero__visual">
              {% image self.image fill-1200x800 alt=self.image_alt class="hero__img" %}
              {# Optional floating annotation could come later #}
          </div>
      </div>
      {# For HeroImageBlock overlay: add an overlay div or apply overlay class to section #}
  </section>
  ```

* For `HeroGradientBlock`, use a similar structure but:

  * No image; instead apply a `hero--gradient` and/or `hero--gradient-{{ self.gradient_style }}` class.
  * Gradient implementation should live in CSS and use tokens (primary/secondary/accent colours).

* **No inline styles** and **no raw hex colors**; only existing tokens and utility classes from `main.css`.

* If new hero-specific classes are needed (e.g. `.hero__grid`, `.hero__content`), add them to `main.css` in a token-friendly way (spacing from `--space-*`, colors from `--color-*`).

#### 4. Wiring into `HomePage` Template

Update `core/sum_core/templates/sum_core/home_page.html`:

* Current state (from previous milestone) likely has:

  * A hard-coded hero section using `page.title` and/or `page.intro`.
  * A StreamField body loop (`{% for block in page.body %}{% include_block block %}{% endfor %}`).

* New behaviour:

  1. **Hero via blocks**:

     * Hero blocks (image/gradient) are normal entries in `page.body`.
     * Their templates include the `<section class="section section--hero">` wrapper, so `home_page.html` should **not** wrap them in an extra hero section.

  2. **Fallback behaviour**:

     * If `page.body` contains no hero blocks at all, render a simple fallback hero using the existing markup (page title + intro) **before** the StreamField loop.

     * Detect hero presence with something like:

       ```django
       {% with has_hero=False %}
         {% for block in page.body %}
           {% if block.block_type in ("hero_image", "hero_gradient") %}
             {% with has_hero=True %}{% endwith %}
           {% endif %}
         {% endfor %}
       {% endwith %}
       ```

       Or, in Python on the page model via helper property if you prefer.

     * In this task, a simple in-template check is acceptable; no need to over-engineer.

  3. **StreamField loop**:

     * Keep the generic loop to render all blocks (hero and others):

       ```django
       {% if page.body %}
           {% for block in page.body %}
               {% include_block block %}
           {% endfor %}
       {% endif %}
       ```

* Make sure you don’t end up with **duplicate heroes** (one static, one from a block).

#### 5. Admin UX

* Ensure hero blocks appear in the StreamField chooser with clear labels and icons:

  * “Hero (Image)” and “Hero (Gradient)”.

* Group them under a “Hero” group in the chooser (`group="Hero"` on `PageStreamBlock` entries).

---

### Design Specifications

* Respect base layout and typography from Milestone 1:

  * `.section`, `.section--tight`, `.container`.
  * `.heading-xl`, `.text-body`, `.btn`, `.btn--primary`, `.btn--secondary`, `.btn--ghost`.

* Use design system rules:

  * **Breath**: hero sections should feel generous; implement via `.section` padding and spacing tokens – not arbitrary px.
  * **Pinky** rule: ensure button padding remains comfortable (existing `.btn` classes should already enforce this).
  * **Material**: if overlays or “glass” elements are used, build them from token-based background, border, and shadow variables.

* Responsiveness:

  * On mobile:

    * Hero content stacks vertically (content then image).
    * Text remains legible (avoid overly large display sizes if they don’t scale well).
  * On larger screens:

    * Two-column layout (content + image) with comfortable gap (`gap` from spacing tokens).

* Accessibility:

  * Enforce image alt text on `HeroImageBlock`.
  * Respect heading hierarchy: hero headline is logically the page’s H1; no additional H1s underneath in body blocks.
  * Buttons used for CTAs must be keyboard-focusable links with appropriate `rel` on `target="_blank"`.

---

### Implementation Guidelines

**Files to Create**

* `core/sum_core/blocks/hero.py`
* `core/sum_core/templates/sum_core/blocks/hero_image.html`
* `core/sum_core/templates/sum_core/blocks/hero_gradient.html`
* Tests:

  * `tests/blocks/test_hero_blocks.py` (new)
  * Optionally, extend `tests/pages/test_home_page.py` for hero integration tests.

**Files to Modify**

* `core/sum_core/blocks/__init__.py` – export hero blocks.
* `core/sum_core/blocks/base.py` – add hero block entries to `PageStreamBlock`.
* `core/sum_core/templates/sum_core/home_page.html` – wire hero blocks and fallback.
* `core/sum_core/static/sum_core/css/main.css` – only if minimal new hero utility classes are required (must comply with token rules).
* Existing tests that assert on `home_page.html` output (update expectations if markup changed).

**Coding Standards**

* All new Python files use the header comment format.
* Type hints on all functions/classes.
* Follow existing import ordering and formatting (Black, isort, Ruff).
* No hard-coded colors or arbitrary px values in any new CSS.

---

### Acceptance Criteria

* [ ] `HeroImageBlock` and `HeroGradientBlock` are implemented in `sum_core.blocks.hero` with fields that satisfy PRD US-B01 (headline, subheadline, CTAs 0–2, overlay opacity, alt text, gradient style).
* [ ] `PageStreamBlock` includes `hero_image` and `hero_gradient` block types and they appear in the Wagtail admin StreamField chooser under a “Hero” group.
* [ ] `HeroImageBlock` and `HeroGradientBlock` have `Meta.template` values pointing to `sum_core/blocks/hero_image.html` and `sum_core/blocks/hero_gradient.html` respectively.
* [ ] Hero block templates render a responsive hero section using the token-based design system and existing layout/utilities (no inline styles, no raw hex, no arbitrary px).
* [ ] `HomePage` template uses hero blocks from `page.body` for the hero area, with a sensible fallback hero if no hero block is present.
* [ ] Wagtail admin preview for hero blocks renders without errors, showing the expected structure.
* [ ] Unit tests validate:

  * Required fields (headline, image, image_alt) are enforced.
  * CTA count limits (0–2) work as expected.
  * Block deconstruction/reconstruction works for migrations.
* [ ] Integration tests confirm that a `HomePage` with a hero block as the first `body` block renders a hero section with CTAs in the response HTML.
* [ ] All existing tests and linters still pass (`make test`, `make lint`).

---

### Dependencies & Prerequisites

* M2-001 (Base Block Infrastructure) complete:

  * `PageStreamBlock` exists and is wired to `HomePage.body`.
  * Basic block rendering from `HomePage.body` is already working.
* Design system & CSS token infrastructure are in place (Milestone 1 complete).
* Test project migrations applied and dev environment running.

---

### Testing Requirements

**Unit tests**

* `tests/blocks/test_hero_blocks.py`:

  * Test `HeroImageBlock`:

    * `headline` and `image_alt` required; blank values should raise validation errors.
    * `overlay_opacity` accepts only defined choices.
  * Test `HeroGradientBlock`:

    * `headline` required.
    * `gradient_style` accepts defined choices.
  * Test `HeroCTABlock`:

    * Valid CTA data (label, URL, style, open_in_new_tab) serializes and cleans correctly.
    * Invalid style choice or missing label fails validation.

**Integration tests**

* Extend `tests/pages/test_home_page.py`:

  * Create a `HomePage` with a `body` containing:

    * First block: `hero_image` with a dummy image, headline, subheadline, 1–2 CTAs.
  * Render the page and assert:

    * Response contains hero section wrapper (e.g. `section` with class `hero` or `section--hero`).
    * Headline, subheadline, and CTA labels appear.
    * CTA links contain appropriate classes for primary/secondary/outline.

* Optional: test fallback hero behaviour when no hero block is present.

**Manual checks**

In Wagtail admin:

1. Edit the root `HomePage`.
2. Add a `Hero (Image)` block with all fields filled in; add a second block (e.g. rich text).
3. Publish and confirm:

   * Hero uses the image background, overlay looks reasonable, text is readable.
   * CTAs render as styled buttons; link behaviour correct (including `target="_blank"` where enabled).
4. Replace with a `Hero (Gradient)` block and verify:

   * Background gradient uses brand colors (via tokens).
   * Layout remains responsive on mobile and desktop.
5. Remove all hero blocks and confirm fallback hero still appears.

---

### Context Bundle for AI

When you hand this to a coding agent, include:

* PRD excerpts:

  * US-B01: Hero Blocks.
  * US-P01: Homepage (StreamField body must accept hero + homepage blocks).
  * Section 6.6 Design Implementation Guardrails.
* Implementation Plan:

  * Milestone 2 task table row for `BLOCKS-002 – Hero Blocks`.
  * Task Card Template (to keep structure consistent).
* Initiation Packet:

  * Repository structure snippet for `sum_core/blocks/hero.py` and templates under `sum_core/templates/sum_core/blocks/`.
  * Sprint 2 S2-US01 hero block story and acceptance table.
* Design system:

  * Sections on Layout & Spacing Rules, Typography Hierarchy, and Material system.
* Premium trade HTML:

  * Hero `<section class="section hero"> …` snippet plus any relevant CSS snippet (truncated) to guide structure, but with a note to replace direct hex/px with tokens.
* Current code:

  * `PageStreamBlock` implementation (`core/sum_core/blocks/base.py`).
  * `HomePage` model and `home_page.html` template.
  * `main.css` token + layout utilities, especially any existing `.hero*` classes.

