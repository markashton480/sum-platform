## [M2-012] Block Library QA & Documentation (Milestone 2 Wrap-Up)

**Milestone:** 2 – StreamField Blocks
**Type:** Hardening / QA / Documentation
**Depends on:** M2-001 … M2-011 (all blocks + StandardPage in place)

---

### 1. Context (from PRD & Implementation Plan)

From **Implementation Plan – Milestone 2: StreamField Blocks**:

> **Goal**: Implement all StreamField blocks required by the PRD, with templates and styling using the design token system.
> **Done When**:
>
> * All blocks render correctly in Wagtail admin preview
> * Blocks use design tokens exclusively (no hardcoded values)
> * Validation enforces min/max items per PRD specs
> * Responsive layouts work across breakpoints (mobile/tablet/desktop)
> * **Unit tests pass with ≥80% coverage on blocks module**
> * **Each block has documented `Meta.template` path**

We’ve now **implemented all the blocks**:

* Hero blocks (image/gradient variants)
* ServiceCards
* Testimonials
* CTA blocks
* TrustStrip & Stats
* ProcessSteps & FAQ
* Gallery / Portfolio
* Content blocks (RichText, Quote, Image, ButtonGroup, Spacer, Divider)
* Form blocks (Contact & Quote)
* Plus `StandardPage` wired to `PageStreamBlock` (even a bit ahead into Milestone 3)

What’s missing is the **“hardening + documentation” layer**: making sure everything is:

* Token clean (no rogue hex/px/`font-family`/ad-hoc colours)
* Test-covered to the level the implementation plan and test strategy expect
* Properly documented so future you (and future agents) don’t keep guessing block semantics

This task is that final pass.

---

### 2. Technical Requirements

#### 2.1 Block audit – existence, wiring, templates

For **each block type** listed in Milestone 2 deliverables:

* HeroImageBlock / HeroGradientBlock
* ServiceCardsBlock
* TestimonialsBlock
* CTAInlineBlock / CTAFullWidthBlock
* TrustStripBlock / StatsBlock
* ProcessStepsBlock / FAQBlock
* GalleryBlock / PortfolioBlock
* RichTextContentBlock / QuoteBlock / ImageBlock / ButtonGroupBlock / SpacerBlock / DividerBlock
* ContactFormBlock / QuoteRequestFormBlock

Do the following:

1. **Verify block definitions**

   * Block class exists in `core/sum_core/blocks/...`.
   * `Meta.template` is present and points to a real template under `core/sum_core/templates/sum_core/blocks/`.
   * Block is wired into `PageStreamBlock` with a stable key name and sensible `group` (e.g. “Sections”, “Content”, “Forms”).

2. **Verify template + wiring**

   * Template path matches `Meta.template` exactly.
   * Template renders via `{% include_block %}` on both `HomePage` and `StandardPage` (where appropriate).

Produce a short internal summary (markdown file) like `docs/dev/M2/block-audit.md` that lists:

* Block name
* Path to class
* `Meta.template` value
* StreamField key (in PageStreamBlock)
* Any TODOs discovered (e.g. “needs token cleanup”, “needs an extra test for min_num”).

#### 2.2 Token & design-system compliance sweep

Using:

* `docs/dev/design/css-architecture-and-tokens.md`
* `docs/dev/design/design-implementation.md`

For every block template + CSS partial:

1. **CSS rules**

   * In all component CSS (`components.*.css`) for blocks:

     * ✅ Spacing uses `var(--space-*)`
     * ✅ Colours use `hsla(var(--token-name), alpha)` with tokens that **exist** in `tokens.css`
     * ✅ No `font-family`, `font-size`, `line-height`, `letter-spacing` set at block level
     * ✅ No inline `style=""` in templates
   * Fix any legacy/rogue usage (`#123456`, `var(--color-...)`, random `16px`) by mapping to the correct tokens.
   * Ensure headings and intros use the shared patterns (e.g. `.section__header`, `.section__heading`, `.block-heading`/typography utilities) instead of one-off heading classes.

2. **Responsive layout**

   * Verify each block that lays out items (services, testimonials, process, gallery/portfolio, stats, FAQ, trust strip, etc.) uses:

     * The **standard grid patterns** defined in the CSS architecture (1/2/3 columns where applicable).
     * Breakpoints consistent with the design system (no bespoke media queries that diverge without reason).

3. **Design-implementation checklist**

   For each block, run the checklist from `design-implementation.md`:

   * Uses `.section` + `.container` structure
   * Headings via typography utilities (`.heading-*`) and shared header pattern
   * No inline styles
   * Animations only via existing observer/reveal hooks (`observe-me`, `is-in-view`) and shared JS, not block-specific JS unless explicitly needed

Document any intentional deviations and why.

#### 2.3 Test coverage – ≥80% on blocks module

Using the **Test Strategy v1.1** and Milestone 2 “Done when” criteria:

1. **Add / refine unit tests** for items where coverage is thin:

   * Structure/field tests for each block:

     * Assert required fields and `min_num`/`max_num` constraints.
     * Assert `Meta.template` values.
     * Assert the block key exists in `PageStreamBlock().child_blocks`.
   * Validation tests:

     * At least one negative case per block type (e.g. empty items, too many items) where constraints exist.
   * Behavioural tests where we have extra logic:

     * FAQ JSON-LD generation.
     * Process block step numbering (auto vs explicit).
     * ButtonGroupBlock alignment/style behaviour if any logic exists beyond simple rendering.

2. **Integration / template tests**:

   * For each **block family**, ensure there is at least one template test that:

     * Builds a `HomePage` or `StandardPage` with that block populated in `body`.
     * Renders via Django test client.
     * Asserts that key CSS hooks/classes appear (e.g. `.hero`, `.service-cards`, `.quote-block`, `.gallery__grid`, `.stats__grid`, `.faq-accordion`, `.form`, `.btn` etc.).
   * We don’t need a separate integration test per block, but every family (Hero/Services/Testimonials/CTA/Trust/Process+FAQ/Gallery/Content/Forms) needs **at least one** integration test that proves the pipeline.

3. **Coverage target**

   * Run coverage for the blocks package (e.g. `pytest --cov=sum_core.blocks` or your existing coverage setup).
   * Aim for **≥80%** on `sum_core/blocks` as per Implementation Plan.
   * If some edge cases are too awkward to reach (e.g. defensive branches), document them in `docs/dev/M2/block-audit.md` so future you knows why.

#### 2.4 Block Reference Documentation

Create a **Block Reference doc** so you and future agents stop guessing field shapes. Suggested path:

* `docs/dev/blocks-reference.md`

For each block:

* **Name & key**

  * Display name (as in the chooser).
  * StreamField key (e.g. `"hero"`, `"services"`, `"gallery"`, `"content_richtext"`, `"contact_form"`).
* **Purpose / usage**

  * 1–3 sentences on what it’s for and where it’s typically used (homepage top, mid-page content, sidebar, etc.).
* **Fields**

  * List of fields with types and any important constraints (min/max list items, required vs optional).
* **Template**

  * `Meta.template` path.
* **Notes / gotchas**

  * Anything an agent should know (e.g. “heading is RichText; italic words in heading are accent-coloured by CSS”, “image uses 16:9 cover crop”).

Keep it concise but concrete. This doc becomes the **thing we link in future task tickets** when we say “see block reference for field definitions”.

---

### 3. Implementation Guidelines

**Files to create**

* `docs/dev/reports/M2/block-audit.md`
* `docs/dev/blocks-reference.md` (or similar central doc)

**Files to update**

* `core/sum_core/blocks/*.py` (only where you need to adjust `Meta.template` or add missing metadata)
* `core/sum_core/templates/sum_core/blocks/*.html` (only to fix token usage / heading patterns / inline styles)
* `core/sum_core/static/sum_core/css/components.*.css` (for token clean-up & consistent patterns)
* `tests/blocks/*.py` (add tests)
* `tests/templates/*.py` (add/extend integration tests)

Follow existing header comment pattern on any new Python files, and keep type hints consistent.

---

### 4. Acceptance Criteria

This task is done when:

1. **Audit & wiring**

   * ✅ `block-audit.md` exists and lists all Milestone 2 blocks, with:

     * Class path
     * `Meta.template`
     * StreamField key
     * Any open TODOs explicitly listed (should be minimal or none).

2. **Design/token compliance**

   * ✅ No component CSS for blocks contains:

     * Raw hex colours
     * `font-family` / `font-size` / `line-height` / `letter-spacing` rules
     * Non-token spacing (e.g. `margin: 32px` instead of `var(--space-*)`)
   * ✅ All section wrappers use `.section` + `.container` and shared header patterns.
   * ✅ Any deviations are documented in `block-audit.md`.

3. **Tests & coverage**

   * ✅ Every block type has at least:

     * One unit test verifying structure/constraints.
     * Coverage of its `Meta.template` path and PageStreamBlock registration.
   * ✅ Each block family has at least one integration test rendering it inside a page.
   * ✅ Coverage report shows **≥80%** on the `sum_core.blocks` package.

4. **Block Reference**

   * ✅ `blocks-reference.md` describes every Milestone 2 block with:

     * Purpose
     * Fields
     * Template path
     * Key usage notes

5. **CI / commands**

   * ✅ `make test` and `make lint` pass.
   * ✅ No new TODOs introduced in code; any remaining gaps are clearly documented.

---

### 5. Dependencies & Prerequisites

* All previous M2 tasks (001–011) complete:

  * All blocks implemented.
  * Content/Portfolio/Form blocks done.
  * `StandardPage` exists and uses `PageStreamBlock`.
* Design system docs up to date:

  * `css-architecture-and-tokens.md`
  * `design-implementation.md`

---

### 6. Testing Requirements

* Run the **full test suite** after each clean-up chunk.
* Run coverage and capture the report (even if you don’t commit it) to verify the ≥80% target.
* Manually spot-check:

  * At least one page with each block type on desktop + mobile.
  * A couple of SiteSettings theme/font presets to ensure no hard-coded styling leaks through.
