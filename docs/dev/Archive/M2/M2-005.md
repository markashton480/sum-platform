## [M2-005] Gallery Block – Image Grid Section

**Task Type:** Feature – StreamField block + template + CSS + tests
**Status:** Ready to start

---

### 1. Context (from PRD & overall vision)

**Business need (PRD – Blocks / Page Builder, paraphrased)**
The marketing site needs a reusable **Gallery** section so trade businesses can showcase finished projects in a way that feels “premium but simple” – a clean grid of photos, good spacing, and mobile-friendly layout, not a fiddly lightbox. This is part of the core Block Library used across pages, not a one-off.

**User story (editor-focused, paraphrased)**

> As a business owner or marketing assistant, I want to drop in a gallery of project photos, add alt text and captions, and know it will look good on any device without me having to fiddle with code or custom CSS.

Key intent:

- Simple, **image-first** gallery (no lightbox / fancy JS for v1).
- Reusable across pages via `PageStreamBlock`.
- Fully driven by the design token system so branding changes (fonts, colours) flow through automatically.

---

### 2. Technical Requirements

**Block architecture**

- Add a new gallery block module:

  - `core/sum_core/blocks/gallery.py` with:

    - `GalleryImageBlock` – a `StructBlock` for individual items.
    - `GalleryBlock` – a `StructBlock` wrapping heading/intro + list of images.

- Fields (proposed):

  ```python
  class GalleryImageBlock(blocks.StructBlock):
      image = ImageChooserBlock(required=True, help_text="Project photo.")
      alt_text = blocks.CharBlock(
          required=False,
          max_length=255,
          help_text="For screen readers. If blank, the image title will be used."
      )
      caption = blocks.CharBlock(
          required=False,
          max_length=255,
          help_text="Short caption, e.g. location or project type."
      )

  class GalleryBlock(blocks.StructBlock):
      heading = blocks.CharBlock(required=True, max_length=120)
      intro = blocks.TextBlock(required=False, help_text="Optional supporting text.")
      images = blocks.ListBlock(
          GalleryImageBlock(),
          min_num=1,
          max_num=24,
          help_text="Add 1–24 images to the gallery."
      )

      class Meta:
          icon = "image"
          label = "Gallery"
          help_text = "Grid of project images with optional captions."
          template = "sum_core/blocks/gallery.html"
  ```

- Use the existing patterns from `service_cards` and `testimonials` blocks:

  - Clear Meta, icon, label, help_text.
  - Group under `"Sections"` in `PageStreamBlock`.

**Integration into `PageStreamBlock`**

- Update `core/sum_core/blocks/base.py`:

  - Import `GalleryBlock` from `.gallery`.
  - Add `gallery = GalleryBlock(group="Sections")` to `PageStreamBlock`.

- Ensure `GalleryBlock` is exported from `core/sum_core/blocks/__init__.py` alongside other blocks so `from sum_core.blocks import PageStreamBlock` remains the single public entry point.

**Template**

- Create `core/sum_core/templates/sum_core/blocks/gallery.html`:

  - Wrap in a standard section shell, consistent with existing sections:

    ```html
    <section class="section gallery">
      <div class="container">
        {% if self.heading %}
        <header class="section__header gallery__header">
          <h2 class="heading-lg">{{ self.heading }}</h2>
          {% if self.intro %}
          <p class="text-body text-muted gallery__intro">{{ self.intro }}</p>
          {% endif %}
        </header>
        {% endif %} {% if self.images %}
        <div class="gallery__grid">
          {% for item in self.images %}
          <figure class="gallery__item">
            {% image item.image fill-600x400 as rendition %}
            <img
              src="{{ rendition.url }}"
              width="{{ rendition.width }}"
              height="{{ rendition.height }}"
              alt="{{ item.alt_text|default:item.image.title }}"
              class="gallery__image"
              loading="lazy"
            />
            {% if item.caption %}
            <figcaption class="gallery__caption text-sm text-muted">
              {{ item.caption }}
            </figcaption>
            {% endif %}
          </figure>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </section>
    ```

  - Use `heading-lg`, `text-body`, `text-muted` etc. **Do not** define font sizes or families directly in this template.

**CSS (respecting token + modular architecture)**

- Implement gallery styles using the token system already validated in the code review (typography scale, spacing, colours, etc.).

- Depending on where you are with CSS modularisation:

  - If partials exist (e.g. `css/_gallery.css` or `css/blocks/_gallery.css`):

    - Add gallery styles there and ensure it’s imported into the main CSS bundle.

  - If still single-file:

    - Add a clearly demarcated “Gallery” section near other section-level blocks in `main.css`.

- Styling goals:

  - `.gallery` / `.section.gallery`:

    - Vertical spacing using `var(--space-*)` tokens.
    - Optional subtle background (if used) via colour tokens (`var(--color-surface)`, etc.), not hard-coded hex.

  - `.gallery__grid`:

    - Responsive CSS grid:

      - Mobile: 1 column.
      - Tablet: 2 columns.
      - Desktop: 3 columns.

    - Use `gap` values from spacing tokens (e.g. `var(--space-5)`).

  - `.gallery__item`:

    - Use border-radius and shadow tokens for cards if desired (`var(--radius-lg)`, `var(--shadow-md)` etc., per your design guide).
    - Ensure image maintains aspect ratio without distortion.

  - `.gallery__image`:

    - `display: block; width: 100%; height: auto;`.

  - `.gallery__caption`:

    - Smaller text using existing typography utilities (`text-sm`, `text-muted`), no explicit `font-size` or `font-family`.

- **No hard-coded fonts or hex values**: rely on CSS variables and utility classes so changes in `SiteSettings` (fonts, colours) propagate automatically.

---

### 3. Design Specifications (layout & behaviour)

- **Layout:**

  - Section heading + intro centred or left-aligned in line with other sections (follow whatever pattern you established for testimonials to keep things visually coherent).
  - Grid should feel “airy” – consistent breathing room around items using `--space-*` tokens.
  - Images should align to a common visual baseline; no jagged layout for v1 (fixed ratio renditions like `fill-600x400`).
  - See design reference: @gallery_design.html

- **Responsiveness:**

  - Use the same breakpoints as the rest of the system (768px / 1024px) from the existing CSS strategy.
  - 1-column mobile → 2-column tablet → 3-column desktop.

- **Accessibility:**

  - Alt text:

    - If editor supplies `alt_text`, use it.
    - Otherwise, fall back to `item.image.title`.

  - Use `<figure>` and `<figcaption>` for semantic grouping.
  - Ensure text contrast is handled by tokens (branding/theming system already covers contrast concerns).

---

### 4. Implementation Guidelines

**Files to create/modify**

1. **Blocks**

   - `core/sum_core/blocks/gallery.py` (new)
   - `core/sum_core/blocks/__init__.py` (export gallery blocks)
   - `core/sum_core/blocks/base.py` (add `gallery` to `PageStreamBlock`)

2. **Template**

   - `core/sum_core/templates/sum_core/blocks/gallery.html` (new)

3. **CSS**

   - Preferred: `core/sum_core/static/sum_core/css/blocks/_gallery.css` (or equivalent partial) + main CSS import.
   - Minimal alternative: new “Gallery” section in `main.css` with clear comments.

4. **Tests**

   - `tests/blocks/test_gallery_block.py` (new)
   - Update `tests/blocks/test_page_streamblock.py` to assert that `PageStreamBlock` includes `"gallery"` in `child_blocks`.
   - Extend `tests/templates/test_homepage_rendering.py` (or a new dedicated test file) to cover rendering of a gallery section on the HomePage.

**Header comments**

For each new Python file, include the standard header, e.g.:

```python
"""
Name: Gallery Blocks
Path: core/sum_core/blocks/gallery.py
Purpose: StreamField blocks for gallery/image grid sections.
Family: Used via PageStreamBlock on core pages (e.g., HomePage) and other templates.
Dependencies: Wagtail blocks, wagtail.images ImageChooserBlock, sum_core design tokens.
"""
```

**Patterns to follow**

- Maintain type hints and imports style consistent with existing blocks (see hero/service/testimonials).
- Use the block-level design guidance you captured in your new design/tokens doc – typography via utilities, layout via tokens, no ad-hoc styles.

---

### 5. Acceptance Criteria

**Editor experience**

1. In Wagtail admin, when editing `HomePage.body`:

   - A “Gallery” block is available under the **Sections** group, with an image-related icon.
   - Editors can add between **1 and 24** images.
   - Each image can have optional `alt_text` and `caption`.

2. Saving a page with a valid gallery block works without validation errors.

**Rendering & layout**

3. A `HomePage` with a Gallery block renders at `/` with:

   - A `<section>` element that includes `class="section gallery"` (or consistent class naming based on your scheme).
   - A nested `.gallery__grid` container.
   - One `.gallery__item` per image, each containing:

     - An `<img>` tag with:

       - `src` referencing a Wagtail rendition URL.
       - `alt` set to the editor-specified alt text or the image title if none supplied.

     - Optional `<figcaption>` only when caption is provided.

4. On small screens, items stack in a single column; on larger screens, the grid expands to 2 and then 3 columns as per CSS breakpoints.

5. No block-specific CSS introduces hard-coded fonts or hex colours; all styling uses existing tokens and typography utility classes.

**Tests**

6. `tests/blocks/test_gallery_block.py`:

   - Confirms `GalleryBlock` has `heading`, `intro`, and `images` child blocks.
   - Confirms `images` is a `ListBlock` of `GalleryImageBlock` with the configured `min_num` and `max_num`.
   - Confirms `GalleryImageBlock` contains `image`, `alt_text`, `caption` with expected requiredness.

7. `tests/blocks/test_page_streamblock.py`:

   - Updated to assert `"gallery"` is present in `PageStreamBlock().child_blocks`.

8. Template/integration test:

   - Creates a `HomePage` with a gallery block (using existing fixtures/helpers from `tests/conftest.py`).
   - Requests the page and asserts:

     - HTTP 200.
     - Presence of `.gallery__grid` and `.gallery__item`.
     - Correct number of rendered images.
     - Alt text/caption behaviour (at least one test case with custom alt, one with fallback, one with caption).

9. `make test` passes with all tests green (no regressions to existing 40+ tests).

---

### 6. Dependencies & Prerequisites

- Requires:

  - **M2-001**: PageStreamBlock + `HomePage.body` StreamField already in place.
  - **Existing blocks** (hero, services, testimonials, trust strip, etc.) implemented and tested.
  - CSS token system + branding/theming working (already verified in code review).

- No new database migrations expected (adding a new block type to an existing `StreamField` is schema-safe).

---

### 7. Testing Requirements

**Unit tests**

- `tests/blocks/test_gallery_block.py` for structure and constraints.
- Updated `test_page_streamblock` to verify presence of `"gallery"`.

**Integration / template tests**

- Extend `tests/templates/test_homepage_rendering.py` (or similar) to:

  - Render `HomePage` with a gallery block.
  - Assert markup structure and core behaviours.

**Manual checks**

- In Wagtail admin:

  - Add a Gallery block with:

    - 3+ images.
    - Some with custom alt text, some without.
    - Some with captions, some without.

  - Ensure:

    - Page renders correctly on desktop and mobile viewport sizes.
    - Captions only appear where set.
    - Alt text behaviour matches expectations.

---

### 8. Estimated Complexity

- **Time:** M (medium – new block + template + CSS + tests, but aligned with existing patterns)
- **Risk:** Low

  - Mostly additive.
  - Follows established StreamField and design token patterns.
  - Regression risk mitigated by the existing test suite and new block-specific tests.
