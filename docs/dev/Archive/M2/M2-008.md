## [M2-008] Content Blocks + Button System Refresh

**Task Type:** Feature – Blocks + CSS refactor
**Milestone:** 2 – StreamField Blocks
**Depends on:** M2-001–M2-007, CSS modularisation, design implementation workflow

---

### 1. Context (from PRD / design)

From the PRD, we need a flexible set of **content blocks** that editors can drop into pages to build rich editorial sections (case studies, about pages, long-form content), not just hero/marketing strips. These content blocks include:

- Rich text (headings, paragraphs, links, lists)
- Editorial quotes / pull-quotes
- Standalone images with captions
- Button groups (CTAs within content)
- Simple spacers / dividers for rhythm

You’ve provided a cohesive reference in `content_blocks_design.html` which shows all of these working together in a “blog / case study” context: rich text with upgraded typography, an editorial quote block, a cinematic image block, and a “physics” button group.

We also already have a basic button system in the design system, but it doesn’t match this new interaction and visual spec. The goal is to **upgrade the button system globally** so:

- All existing `.btn` usage benefits.
- New content blocks can use `.btn`, `.btn-primary`, `.btn-secondary` without block-specific hacks.

---

### 2. Technical Requirements

#### 2.1 Block definitions

Implement or refine the following blocks in `sum_core.blocks` (exact module naming can follow your current pattern, e.g. `core/sum_core/blocks/content.py`):

1. **RichTextContentBlock**

   - A flexible block for general content sections.
   - Fields:

     - `body` – `RichTextBlock` (using the standard featureset: H2, H3, H4, bold, italic, links, lists).

   - `Meta`:

     - `icon = "doc-full"`
     - `label = "Content (Rich Text)"`
     - `template = "sum_core/blocks/content_richtext.html"`

2. **QuoteBlock** (editorial quote)

   - Fields:

     - `quote` – `TextBlock` or `RichTextBlock` (short, 1–3 sentences).
     - `author` – `CharBlock(required=False)`.
     - `role` – `CharBlock(required=False, help_text="Role/description, e.g. Property Owner")`.

   - `Meta`:

     - `icon = "openquote"`
     - `label = "Editorial Quote"`
     - `template = "sum_core/blocks/content_quote.html"`

3. **ImageBlock** (cinematic image)

   - Fields:

     - `image` – `ImageChooserBlock(required=True)`.
     - `alt_text` – `CharBlock(required=True, max_length=255)`.
     - `caption` – `CharBlock(required=False, help_text="Short caption under the image.")`.
     - (Optional) `full_width` – `BooleanBlock(required=False, default=False, help_text="Stretch to full-width container.")`.

   - `Meta`:

     - `icon = "image"`
     - `label = "Image"`
     - `template = "sum_core/blocks/content_image.html"`

4. **ButtonGroupBlock**

   - Fields:

     - `alignment` – `ChoiceBlock` with values:

       - `"left"`, `"center"`, `"right"`

     - `buttons` – `ListBlock(ButtonBlock, min_num=1, max_num=3)`

   - `ButtonBlock` struct:

     - `label` – `CharBlock`
     - `url` – `URLBlock` (or `PageChooserBlock` + `URLBlock` if you want to allow both, but keep it simple for now).
     - `style` – `ChoiceBlock` with options:

       - `primary`, `secondary` (maps to `.btn-primary`, `.btn-secondary`).

   - `Meta`:

     - `icon = "snippet"`
     - `label = "Button Group"`
     - `template = "sum_core/blocks/content_buttons.html"`

5. **SpacerBlock**

   - Fields:

     - `size` – `ChoiceBlock`:

       - `small`, `medium`, `large`, `xlarge`

   - `Meta`:

     - `icon = "horizontalrule"`
     - `label = "Spacer"`
     - `template = "sum_core/blocks/content_spacer.html"`

   - Mapping to tokens (baked into CSS, not hardcoded margins):

     - `small` → e.g. `var(--space-6)`
     - `medium` → `var(--space-10)`
     - `large` → `var(--space-16)`
     - `xlarge` → `var(--space-24)`

6. **DividerBlock**

   - Fields:

     - `style` – `ChoiceBlock`:

       - `muted` (subtle line),
       - `strong`,
       - `accent`.

   - `Meta`:

     - `icon = "horizontalrule"`
     - `label = "Divider"`
     - `template = "sum_core/blocks/content_divider.html"`

   - Styles map to:

     - Muted: thin line with `hsla(var(--text-muted), 0.3)`.
     - Strong: slightly thicker or higher opacity using `hsla(var(--text-main), 0.4)`.
     - Accent: `hsla(var(--accent-pop), 1)`.

> **Integration**:
> All of these should be added to `PageStreamBlock` under a sensible group (e.g. `"Content"`), so they’re available on `HomePage` and future StreamField-based pages.

#### 2.2 Templates

Implement the following templates under `core/sum_core/templates/sum_core/blocks/`:

1. `content_richtext.html`

   - Wrap body content in:

     ```html
     <section class="section section--content">
       <div class="container container--narrow">
         <div
           class="content-block content-block--rich-text rich-text observe-me"
         >
           {{ self.body|richtext }}
         </div>
       </div>
     </section>
     ```

   - Use `.rich-text` class as the hook for the enhanced typography/links pattern from the design.

2. `content_quote.html`

   - Structure mirroring the design:

     ```html
     <section class="section section--content">
       <div class="container container--narrow">
         <blockquote class="quote-block observe-me">
           <div class="quote-line"></div>
           <div class="quote-content">
             <p class="quote-text">{{ self.quote }}</p>
             {% if self.author or self.role %}
             <div class="quote-attribution">
               {% if self.author %}
               <span class="quote-author">{{ self.author }}</span>
               {% endif %} {% if self.role %}
               <span class="quote-role"> — {{ self.role }}</span>
               {% endif %}
             </div>
             {% endif %}
           </div>
         </blockquote>
       </div>
     </section>
     ```

   - This should replicate the animated vertical line and attribution fade-in pattern.

3. `content_image.html`

   - Structure:

     ```html
     <section class="section section--content">
       <div
         class="container{% if not self.full_width %} container--narrow{% endif %}"
       >
         <figure class="image-block observe-me">
           <div class="image-wrapper">
             {% image self.image width-1600 alt=self.alt_text %}
           </div>
           {% if self.caption %}
           <figcaption class="image-caption text-sm">
             {{ self.caption }}
           </figcaption>
           {% endif %}
         </figure>
       </div>
     </section>
     ```

   - Behaviour: cinematic “curtain” reveal + zoom-out as in the reference design.

4. `content_buttons.html`

   - Structure:

     ```html
     <section class="section section--content">
       <div class="container container--narrow">
         <div
           class="button-group observe-me button-group--{{ self.alignment|default:'left' }}"
         >
           {% for btn in self.buttons %}
           <a
             href="{{ btn.url }}"
             class="btn {% if btn.style == 'primary' %}btn-primary{% else %}btn-secondary{% endif %}"
           >
             {{ btn.label }}
           </a>
           {% endfor %}
         </div>
       </div>
     </section>
     ```

   - Use `.button-group` and `.btn` classes from the updated button system.

5. `content_spacer.html`

   - Very simple:

     ```html
     <div
       class="content-spacer content-spacer--{{ self.size|default:'medium' }}"
     ></div>
     ```

   - This doesn’t need `section`/`container`, it just introduces vertical space between blocks.

6. `content_divider.html`

   - Similarly simple:

     ```html
     <div
       class="content-divider content-divider--{{ self.style|default:'muted' }}"
     ></div>
     ```

   - The visual is entirely controlled via CSS.

All templates must respect the design implementation checklist (no inline styles, use `.section`/`.container` appropriately, etc.).

#### 2.3 Button system refresh (global)

Update buttons so **all `.btn` usage** (existing hero/service/testimonial CTAs, plus new content button groups) share the new physics-style design.

- Implement button styles in `core/sum_core/static/sum_core/css/components.buttons.css`:

  - Migrate/adapt the behaviour from the design reference:

    - Base `.btn`:

      - Inline-flex, centre aligned, uppercase, tracking, letter spacing.
      - Padding via `var(--space-*)` tokens.
      - Border-radius via `var(--radius-sm)` or `var(--radius-md)`.
      - Transition using `var(--ease-out-expo)`.

    - `.btn-primary`:

      - Solid primary background: `hsla(var(--primary), 1)`.
      - Border: `1px solid hsla(var(--primary), 1)`.
      - `::before` pseudo-element for deeper shade `hsla(var(--primary-deep), 1)` if you have that token; or define a semantic token in `tokens.css` and use it.

    - `.btn-secondary`:

      - Transparent background, text `hsla(var(--text-main), 1)`.
      - Border `hsla(var(--text-main), 0.2)`.
      - `::before` slide fill from left, using `hsla(var(--text-main), 1)`.

  - Respect the token rules from `css-architecture-and-tokens.md`: use only tokens and `hsla(var(--*), 1)`; no raw hex or font sizes.

- Ensure existing templates that use `.btn` or `.btn--primary` etc. still look good or are updated to match the new naming (`.btn-primary`, `.btn-secondary`, etc.) while keeping backwards compatibility where possible.

---

### 3. Implementation Guidelines

**Files to create/modify**

- **Blocks (Python)**

  - `core/sum_core/blocks/content.py` (new or extended)
  - `core/sum_core/blocks/__init__.py` (export new blocks)
  - `core/sum_core/blocks/base.py` (add new blocks to `PageStreamBlock` under “Content” group)

- **Templates**

  - `core/sum_core/templates/sum_core/blocks/content_richtext.html`
  - `core/sum_core/templates/sum_core/blocks/content_quote.html`
  - `core/sum_core/templates/sum_core/blocks/content_image.html`
  - `core/sum_core/templates/sum_core/blocks/content_buttons.html`
  - `core/sum_core/templates/sum_core/blocks/content_spacer.html`
  - `core/sum_core/templates/sum_core/blocks/content_divider.html`

- **CSS**

  - `core/sum_core/static/sum_core/css/components.content.css` (for `.rich-text`, `.quote-block`, `.image-block`, spacer, divider, etc., adapted from `content_blocks_design.html`).
  - `core/sum_core/static/sum_core/css/components.buttons.css` (update/extend to new physics buttons).
  - `core/sum_core/static/sum_core/css/main.css` – ensure it imports `components.content.css` and updated `components.buttons.css` in correct order.

- **JS**

  - If not already present, ensure `main.js` implements the generic “observe-me”/IntersectionObserver pattern used in the design reference (it looks like you already have this from other sections; reuse the same hooks rather than reimplement).

**Header comments**

- Add standard header comments to all new Python and CSS files (as per your existing convention).

---

### 4. Acceptance Criteria

**Blocks & Admin**

- All six blocks (`RichTextContentBlock`, `QuoteBlock`, `ImageBlock`, `ButtonGroupBlock`, `SpacerBlock`, `DividerBlock`) appear in the StreamField chooser for `HomePage.body`, under a “Content” (or similarly named) group.
- Editors can add and configure each block without validation errors.

**Rendering & Design**

- RichText block:

  - Uses `.rich-text` typography and link styles from the design reference.
  - H2/H3/H4 styling and link “swoosh” match the content design.

- Quote block:

  - Displays the animated vertical line and attribution behaviour when in view.
  - Looks visually identical (within reason) to the editorial quote in `content_blocks_design.html`.

- Image block:

  - Applies the cinematic reveal + zoom-out effect when scrolled into view.
  - Caption styling matches the reference.

- Button group:

  - Alignment options work (`left`, `center`, `right`).
  - Buttons use the upgraded `.btn` styles (primary + secondary) and respect the physics interactions.

- Spacer and divider:

  - Spacer sizes visibly correspond to increasing vertical rhythm.
  - Dividers render correctly for `muted`, `strong`, and `accent` and use only token colours.

**Token & CSS compliance**

- No inline `style=""` in new templates (except where unavoidable and explicitly noted – ideally zero).
- No raw hex or font-size declarations in `components.content.css` or `components.buttons.css`.
- All spacing uses `var(--space-*)`.
- All colours use `hsla(var(--*), 1)` with tokens from `tokens.css`.

**Tests**

- New tests under `tests/blocks/test_content_blocks.py`:

  - Validate block structures and choice constraints.

- New template tests under `tests/templates/test_content_blocks_rendering.py`:

  - Create a `HomePage` with each content block type and assert:

    - 200 OK.
    - Presence of key CSS classes (`.rich-text`, `.quote-block`, `.image-block`, `.button-group`, `.content-spacer--small`, etc.).

- `make test` and `make lint` pass.
