### Task ID

**M2-004 – BLOCKS-004: Testimonials Block**

### Goal

Implement a reusable, token-driven `TestimonialsBlock` StreamField block (plus templates, styling and tests) so editors can add testimonial/social proof sections to pages – starting with `HomePage` – in line with **US-B03: Testimonials Block**.

---

### Workstream

- **Workstream:** StreamField Blocks
- **Milestone:** Milestone 2 – StreamField Blocks (Homepage core blocks)

---

### Inputs Required

**From PRD**

- **Epic: StreamField Blocks – US-B03: Testimonials Block** (structure & behaviour):

  - `TestimonialsBlock` with card-based layout.
  - Each testimonial: **quote text (required)**, **author name (required)**, **company (optional)**, **photo (optional)**, **rating (1–5 stars, optional)**.
  - Star rating must render as filled/empty stars.
  - Responsive grid: **3-col desktop**, **2-col tablet**, **1-col mobile**.

- **Epic: Page Types – US-P01: HomePage** – HomePage body must accept the Testimonials block.
- **Design specs & guardrails:** token-driven design, card components, section rhythms, responsive behaviour, and accessibility.

**From Implementation Plan**

- Milestone 2 task summary for **BLOCKS-004 – Testimonials Block** (implement block, templates, tests; plug into HomePage).

**From Test Strategy**

- Unit tests for StreamField blocks: structural validation, field constraints (like rating bounds), and coverage expectations.

**Design Reference**

- `testimonials_design.html` – testimonials / social proof area as a visual reference for card layout, spacing, and tone (clean cards, subtle backgrounds, clear attribution).

---

### Files / Modules to Touch

> **Note:** Exact file names may differ slightly depending on what M2-001–003 created; follow existing patterns in `sum_core/blocks/` and tests.

**Core block definitions**

- `core/sum_core/blocks/testimonials.py` (new)

  - Define `TestimonialBlock` (a `StructBlock`) and `TestimonialsBlock` (a `StructBlock` or `StructBlock` + `ListBlock`) using the existing base/mixin patterns from M2-001.

- `core/sum_core/blocks/__init__.py` or the equivalent block registry module

  - Export `TestimonialsBlock` and add it into the homepage block set used by `HomePage.body` (e.g. `HOME_PAGE_STREAM_BLOCK`, `HOME_PAGE_BLOCKS`, etc.), alongside Hero and ServiceCards.

**Templates**

- `core/sum_core/templates/sum_core/blocks/testimonials.html` (new)

  - Template for rendering `TestimonialsBlock` as a responsive testimonial section.
  - Uses existing layout helpers: `.section`, `.section--muted`/`.section--inset`, `.container`, `.card`, etc.

**CSS**

- `core/sum_core/static/sum_core/css/main.css`

  - Add BEM-ish classes for testimonials while reusing existing primitives:

    - `.testimonials`, `.testimonials__grid`
    - `.testimonial-card`, `.testimonial-card__quote`, `.testimonial-card__meta`, `.testimonial-card__rating`, `.testimonial-card__avatar`

  - Use **design tokens** only (no raw hex/px beyond what’s already allowed in the design system).

**Pages / wiring**

- `core/sum_core/test_project/home/models.py`

  - Ensure the `HomePage.body` StreamField includes the `TestimonialsBlock` in its block list (whatever constant/Block class M2-001 introduced for homepage blocks).

**Tests**

- `tests/unit/test_blocks/test_testimonials_block.py` (or whatever naming convention M2-002/003 used, e.g. `tests/unit/blocks/test_testimonials_block.py`)

  - Unit tests for block structure and validation.

- `tests/templates/test_homepage_rendering.py` (if you’ve already got a “homepage renders blocks” test module from earlier tasks)

  - Add an assertion that Testimonials blocks render without error and output expected classes.

---

### Implementation Guidelines

#### 1. Block Definitions

In `core/sum_core/blocks/testimonials.py`:

Add standard header docstring:

```python
"""
Name: Testimonials Blocks
Path: core/sum_core/blocks/testimonials.py
Purpose: StreamField blocks for testimonial/social proof sections.
Family: Used by HomePage and other page StreamFields accepting social proof blocks.
Dependencies: Wagtail core blocks, base block mixins (from sum_core.blocks.base or similar), design system templates/CSS.
"""
```

**Structure**

- Define an inner struct for a single testimonial:

```python
class TestimonialBlock(StructBlock):
    quote = TextBlock(required=True, help_text="Customer quote or review text.")
    author_name = CharBlock(required=True, help_text="Name of the customer.")
    company = CharBlock(required=False, help_text="Company or context (optional).")
    photo = ImageChooserBlock(required=False, help_text="Optional headshot or avatar.")
    rating = IntegerBlock(
        required=False,
        min_value=1,
        max_value=5,
        help_text="Optional rating from 1 to 5 stars."
    )

    class Meta:
        icon = "user"
        label = "Testimonial"
```

- Define the section-level block:

```python
class TestimonialsBlock(StructBlock):
    heading = CharBlock(required=False, help_text="Optional section heading.")
    intro = RichTextBlock(required=False, help_text="Optional introductory text.")
    testimonials = ListBlock(
        TestimonialBlock(),
        min_num=1,
        max_num=12,
        help_text="One or more testimonial cards."
    )

    class Meta:
        template = "sum_core/blocks/testimonials.html"
        icon = "group"
        label = "Testimonials"
```

- If M2-001 introduced a base section mixin (e.g. `SectionBlockMixin` for padding/id/background options), apply it here consistently instead of re-inventing fields.

#### 2. Wiring into the homepage block set

- Locate where your homepage StreamField is defined (added in M2-001):

  - Either in `HomePage.body = StreamField(HOME_PAGE_BLOCKS, ...)`
  - Or via a custom `HomePageStreamBlock` class.

- Add `TestimonialsBlock` to the available homepage blocks, using the existing naming convention:

```python
("testimonials", TestimonialsBlock()),
```

This must ensure:

- `HomePage` satisfies PRD **US-P01 AC2**: Testimonials available as a homepage block.

#### 3. Template

Create `templates/sum_core/blocks/testimonials.html`:

- Wrap in a `.section` and `.container`, following hero/service cards patterns.
- Use a semantic structure, for example:

```html
<section class="section section--muted testimonials">
  <div class="container">
    {% if self.heading %}
    <h2 class="heading-lg testimonials__heading">{{ self.heading }}</h2>
    {% endif %} {% if self.intro %}
    <div class="text-body text-muted testimonials__intro">
      {{ self.intro|richtext }}
    </div>
    {% endif %}

    <div class="testimonials__grid">
      {% for item in self.testimonials %}
      <article class="card testimonial-card">
        {% if item.quote %}
        <div class="testimonial-card__quote">
          <span class="testimonial-card__quote-mark" aria-hidden="true">“</span>
          <p>{{ item.quote }}</p>
        </div>
        {% endif %}

        <footer class="testimonial-card__meta">
          {% if item.photo %}
          <div class="testimonial-card__avatar">
            {% image item.photo fill-80x80 class="testimonial-card__avatar-img"
            %}
          </div>
          {% endif %}
          <div class="testimonial-card__author">
            <p class="testimonial-card__author-name">{{ item.author_name }}</p>
            {% if item.company %}
            <p class="testimonial-card__author-company text-muted">
              {{ item.company }}
            </p>
            {% endif %} {% if item.rating %}
            <div
              class="testimonial-card__rating"
              aria-label="{{ item.rating }} out of 5 stars"
            >
              {% for _ in "12345" %}
              <span
                class="testimonial-card__star {% if forloop.counter <= item.rating %}testimonial-card__star--filled{% endif %}"
                aria-hidden="true"
                >★</span
              >
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </footer>
      </article>
      {% endfor %}
    </div>
  </div>
</section>
```

Key points:

- **Star rating:** uses text stars (`★`) with CSS to control colour for filled vs empty; includes `aria-label` for screen readers. This satisfies “filled/empty star icons” without adding an icon library.
- **Responsive grid:** grid behaviour handled via CSS (see below).

#### 4. CSS

In `main.css`:

- Reuse existing grid & card primitives where possible (if M2-003 created a generic `.card-grid` or `.cards` class, prefer that). Otherwise, add minimal new classes:

```css
.testimonials {
  /* optional: subtle background via existing surface tokens */
}

.testimonials__grid {
  display: grid;
  gap: var(--space-6);
  grid-template-columns: 1fr;
}

@media (min-width: 768px) {
  .testimonials__grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (min-width: 1024px) {
  .testimonials__grid {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

.testimonial-card {
  /* extend existing .card styles where relevant */
}

.testimonial-card__quote {
  font-size: var(--text-md);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-4);
}

.testimonial-card__quote-mark {
  font-size: var(--text-3xl);
  color: var(--color-accent);
}

.testimonial-card__author-name {
  font-weight: var(--font-semibold);
}

.testimonial-card__rating {
  margin-top: var(--space-2);
  font-size: var(--text-sm);
}

.testimonial-card__star {
  opacity: 0.3;
}

.testimonial-card__star--filled {
  opacity: 1;
}
```

- Use only token-driven values (e.g., `--color-accent`, `--space-*`, `--text-*`, `--font-*`).

#### 5. Accessibility & semantics

- Use `<section>` with an `<h2>` when heading is present for landmark navigation.
- Ensure colour contrast of stars and text meets WCAG 2.1 AA (reuse existing text colours rather than inventing new ones).
- Provide `aria-label` for star ratings and hide decorative quote marks (`aria-hidden="true"`).

---

### Acceptance Criteria (for this task)

This task is considered done when:

1. **Block structure & fields**

   - `TestimonialsBlock` exists in `sum_core.blocks` and:

     - Supports a heading + intro at section level (optional).
     - Contains a list of testimonial items (min 1, max 12).
     - Each testimonial has:

       - `quote` (required).
       - `author_name` (required).
       - `company` (optional).
       - `photo` (optional, image chooser).
       - `rating` (optional, 1–5 only).

2. **Homepage availability**

   - `HomePage.body` StreamField accepts `TestimonialsBlock` as one of its blocks, satisfying **US-P01 AC2** for homepage blocks.

3. **Rendering & layout**

   - `TestimonialsBlock` renders via `sum_core/blocks/testimonials.html` without errors.
   - Frontend layout:

     - Uses card-based styling.
     - Grid is 3 columns on desktop (≥1024px), 2 on tablet, 1 on mobile.

   - Quote marks are visually styled (decorative opening quote) and don’t interfere with screen readers.

4. **Star ratings**

   - When rating is set, stars display as filled/empty up to 5.
   - When rating is not set, no stars are shown.

5. **Design system compliance**

   - All new CSS respects token-driven rules (no hard-coded brand colours or fonts).
   - Typography and spacing feel consistent with hero and service cards sections using the existing tokens.

6. **Testing**

   - Unit tests cover:

     - Validation of `rating` (cannot be <1 or >5 when provided).
     - At least one testimonial is required.
     - Block de-/serialisation for simple sample values.

   - Template tests (or integration test) assert:

     - Testimonials block can be added to `HomePage.body` in a test instance.
     - The rendered HTML contains the expected wrapper classes (`.testimonials`, `.testimonials__grid`, `.testimonial-card`, etc.).

   - All tests pass via `make test`.

---

### Dependencies & Prerequisites

- **Must already be complete:**

  - **M2-001 – Base Block Infrastructure & HomePage StreamField** (so there is a place to plug in `TestimonialsBlock`).
  - **M2-002 – Hero Blocks** and **M2-003 – Service Cards Block** as references for base block patterns, CSS integration, and tests.
  - Design system tokens & card components from Milestone 1.

- **No new database migrations** expected if `HomePage.body` is already using `use_json_field=True` and block sets are defined in Python, but the implementer should confirm this matches existing patterns.

---

### Testing Requirements

**Unit Tests**

- Location: `tests/unit/test_blocks/test_testimonials_block.py` (or equivalent).
- Cover:

  - `TestimonialsBlock` structure (field names/types as per PRD).
  - Validation of `rating` bounds (1–5).
  - `testimonials` list min constraint (at least one item).
  - Simple round-trip test: initialise block value dict, render to JSON, re-parse to struct.

**Integration / Template Tests**

- Location: whichever module currently covers homepage rendering (e.g. `tests/templates/test_home_page.py`).
- Add a test that:

  - Builds a `HomePage` instance with a `TestimonialsBlock` in `body`.
  - Renders the page (e.g. using Django test client).
  - Asserts that:

    - The testimonials section is present (`.testimonials` selector).
    - At least one testimonial card is present.
    - When a rating is set, five star elements exist and the correct number are “filled”.

**Manual QA Checklist**

- From Wagtail admin, add a HomePage with:

  - 1 testimonial (basic case).
  - 3+ testimonials with mixed presence of company, photo, and rating.

- Verify visually:

  - Mobile: single column, readable text, sufficient padding.
  - Tablet: two columns.
  - Desktop: three columns.
  - Stars look good at all sizes and don’t break layout.

- Confirm:

  - Empty rating hides stars.
  - Section still looks good with no heading/intro (just cards).

---

### Estimated Complexity

- **Time:** **M (Medium)** – new block, template, CSS, and tests, but reusing hero/service patterns.
- **Risk:** **Low–Medium** – mostly isolated to frontend and blocks; main risk is consistency with design system and ensuring rating rendering is accessible.

---

When you’re ready, you can hand this straight to the coding agent. If you like, we can then follow up with a quick “design check” pass once it’s implemented to keep the testimonials feeling as polished as the new hero and service cards.
