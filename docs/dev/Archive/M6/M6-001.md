## **[M6-001]: VPS Golden Path Deployment (Ubuntu + Caddy + systemd + Postgres + backups)**

**Objective**
Establish a **repeatable, boring, production-ready “golden path”** for deploying a SUM client site to a single Ubuntu VPS using **Caddy + systemd + Postgres** (and Redis if needed), including deploy + backup/restore scripts and a step-by-step runbook. This is the foundation for practicing deploy + upgrades across multiple sites.

**Context** (from SSOT/PRD)

* Milestone 5 includes deployment scripts, service templates, backup/restore scripts, and VPS setup docs as required deliverables. 
* Test strategy requires backup/restore to be successfully tested on staging, and emphasizes predictable rollout + rollback paths.
* Platform currently has a `/health/` endpoint and production settings expect Postgres and (optionally) Redis/Celery; health semantics are already hardened.

---

## Technical Requirements

### Deployment target (golden path)

* **Ubuntu VPS**
* **Caddy** as reverse proxy + TLS termination (decision locked; SSOT mentions nginx but we are explicitly using Caddy going forward)
* **systemd** for process supervision
* **Gunicorn** (WSGI) for Django/Wagtail
* **Postgres** (required)
* **Redis** (required only if Celery/broker or cache configured in prod settings)

### Non-goals

* No “one-click deploy SaaS”
* No multi-cloud support
* No Docker production requirement (OK to use it locally)

---

## Design Specifications

Not a UI task. Focus is operational correctness and DX.

---

## Implementation Guidelines

### Files to create/modify (expected)

Create an `infrastructure/` directory with subfolders:

* `infrastructure/caddy/`

  * `Caddyfile.template`
* `infrastructure/systemd/`

  * `sum-site-gunicorn.service.template`
  * `sum-site-gunicorn.socket.template` *(optional; can simplify restarts)*
  * `sum-site-celery.service.template` *(optional; only if you decide Celery is part of golden path)*
* `infrastructure/scripts/`

  * `deploy.sh`
  * `backup_db.sh`
  * `restore_db.sh`
  * `provision_vps.sh` *(optional helper; keep it explicit and idempotent if included)*
* `docs/dev/deploy/vps-golden-path.md` *(new runbook)*
* Update `boilerplate/.env.example` if any missing production env vars are required for this runbook.

### Required header comments (for Python files)

If you add any Python helpers, include:

```python
"""
Name: ...
Path: ...
Purpose: ...
Family: ...
Dependencies: ...
"""
```

### Script rules

* Must be **idempotent where it matters** (deploy and backup must not corrupt state if re-run).
* Must **fail fast** with clear output (`set -euo pipefail`).
* Must not hardcode secrets; read from `.env` on server.
* Must support **multiple sites** eventually (even if you deploy only one now): use a `SITE_SLUG` / directory-based pattern.

---

## Golden Path Architecture

### On-server layout (standard)

* `/srv/sum/<site_slug>/app/` → the Django project (client repo clone)
* `/srv/sum/<site_slug>/venv/` → Python venv
* `/srv/sum/<site_slug>/.env` → environment variables (owned by root or deploy user; not in git)
* `/var/log/sum/<site_slug>/` → app logs (or journald only; decide and document)
* Static/media:

  * `STATIC_ROOT=/srv/sum/<site_slug>/static/`
  * `MEDIA_ROOT=/srv/sum/<site_slug>/media/`

### systemd units

* `gunicorn` service:

  * runs `gunicorn <project>.wsgi:application`
  * binds to unix socket (recommended) or localhost port
  * uses env vars from `.env`
* Optional Celery worker service if you decide it’s required for the golden path:

  * keep it off by default unless you truly need async in production day 1

### Caddy

* Reverse proxy to gunicorn socket/port
* Automatic TLS
* Serve `/static/` and `/media/` directly (recommended) or via Django (not recommended)

---

## Deployment Script Requirements (`deploy.sh`)

Must perform:

1. Pull latest code (or checkout provided ref/tag)
2. Ensure venv exists + install requirements
3. Run migrations
4. Collect static
5. Restart services (systemd)
6. Run a smoke check:

   * `curl -f https://<domain>/health/` returns 200 or degraded 200
   * Optionally `curl -f https://<domain>/sitemap.xml` returns 200 (non-blocking but logged)

Include safe modes:

* `--ref vX.Y.Z` (checkout tag)
* `--no-restart` (for debugging)
* Print next-steps / where logs are

---

## Backup / Restore Script Requirements

### `backup_db.sh`

* Create a **gzipped** PostgreSQL dump:

  * `pg_dump` in custom format or plain SQL; choose one and document restore method
* Name includes:

  * site_slug
  * timestamp (UTC)
* Save to:

  * `/srv/sum/<site_slug>/backups/`
* Should output the final file path

### `restore_db.sh`

* Restore from a chosen backup file
* Require explicit confirmation flag (e.g. `--i-know-this-will-overwrite`)
* Must support restoring into the site’s DB name/user

---

## Documentation Requirements (`vps-golden-path.md`)

Must include:

* VPS prerequisites (Ubuntu version, required packages)
* Create deploy user + SSH hardening basics
* Firewall basics (UFW minimal rules)
* Postgres setup:

  * create DB + user
  * set password
  * verify connectivity
* Redis setup (only if required)
* Project setup:

  * directory layout
  * `.env` placement and permissions
* systemd enable/start commands
* Caddy setup + domain + TLS
* First deploy instructions
* Upgrade flow:

  * update `SUM_CORE_GIT_REF` in client requirements (tag pinning)
  * deploy script usage
* Backup + restore rehearsal steps (required by test strategy)

---

## Acceptance Criteria

**Provisioning**

* A fresh Ubuntu VPS can be prepared using the documented runbook (no hidden steps).

**Deploy**

* A scaffolded client site (from `sum init`) can be deployed and served over HTTPS.
* `https://<domain>/health/` returns JSON and HTTP 200 (ok or degraded).
* Deploy script successfully runs:

  * `migrate`
  * `collectstatic`
  * restart gunicorn via systemd

**Backup/Restore**

* Backup script produces a gzipped dump file.
* Restore script can restore that dump to a clean DB (documented rehearsal).

**Operational sanity**

* Logs are accessible (journald or file logs documented).
* Rollback is possible by deploying a previous git tag (documented, not automated).

---

## Dependencies & Prerequisites

* Milestone 5 is frozen; release workflow exists (tag pinning discipline).
* Client boilerplate exists and supports production settings split.

---

## Testing Requirements (from test-strategy-v1.1)

* Add at least one **smoke checklist** section and require a **backup/restore rehearsal** on staging/VPS.
* No requirement for full E2E automation in this task, but ensure deploy path supports future Playwright/Lighthouse checks.

---

## Estimated Complexity

* **Time:** L
* **Risk:** Medium (ops correctness + security footguns)
* **Suggested Model:** GPT-5.2 (High complexity) / Claude Opus (High)

---

