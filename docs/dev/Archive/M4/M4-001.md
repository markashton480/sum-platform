**[M4-001]: Analytics template tags (GA4/GTM injection)**

**Objective**: Implement the **analytics template tags** that inject GA4 or GTM scripts (head + body) based on per-site `SiteSettings`, following the priority logic defined in SSOT, with solid test coverage.

---

## Context (from SSOT / PRD)

**Context** (from SSOT – _Analytics & SEO_)

- “### 10.1 Analytics Template Tags
  `{% load analytics_tags %} {% analytics_head %} … {% analytics_body %}`”
- “**Priority Logic:** 1) If GTM Container ID present → inject GTM 2) Else if GA4 Measurement ID present → inject GA4 3) Neither present → no scripts”
- Reference: **SSOT §10.1**, **SSOT Milestone 4 Deliverables**

**Context** (from PRD – _Analytics & SEO_)

- US-A01 (Google Analytics Integration): “GA4 Measurement ID field… GA4 script injected… GTM Container ID field… GTM takes precedence… No scripts loaded when IDs are empty.”
- Reference: **PRD §2.7 (US-A01)**

---

## Technical Requirements (from SSOT / repo state)

- Create template tags:

  - `{% analytics_head %}`: emits the correct `<script>` blocks for **either** GTM or GA4.
  - `{% analytics_body %}`: emits GTM `<noscript>` fallback **only** when GTM is active.

- Enforce priority:

  - GTM wins if both are configured.

- No output if no IDs are set.
- Use existing settings fields:

  - `SiteSettings.gtm_container_id`, `SiteSettings.ga_measurement_id` already exist (per README “Current status”). (No schema changes expected.)

**Implementation locations (expected)**

- `core/sum_core/analytics/templatetags/analytics_tags.py`
- `core/sum_core/templates/sum_core/includes/analytics/ga4_head.html`
- `core/sum_core/templates/sum_core/includes/analytics/gtm_head.html`
- `core/sum_core/templates/sum_core/includes/analytics/gtm_body.html`
- Ensure base template includes:

  - in `<head>`: `{% analytics_head %}`
  - just inside `<body>`: `{% analytics_body %}`
  - Reference: SSOT base template pattern shows these hooks. (SSOT Appendix / template snippet.)

**Required header comments**
Add the standard module header comment block to any new Python module per project rules.

---

## Design Specifications (SSOT)

- This work is non-visual, but must preserve the base template structure and avoid adding inline styling.
- Reference: **SSOT §6.7 (Base Template Structure)** + **SSOT §10.1 (template tag contract)**

---

## Acceptance Criteria

1. **GTM only**: with `gtm_container_id` set, `{% analytics_head %}` emits GTM head script and `{% analytics_body %}` emits the noscript iframe fallback.
2. **GA4 only**: with `ga_measurement_id` set (and GTM empty), `{% analytics_head %}` emits GA4 script; `{% analytics_body %}` emits nothing.
3. **Both set**: GTM takes precedence; GA4 is not injected.
4. **Neither set**: both tags emit nothing (empty string).
5. Base template renders without errors and includes the tags in the correct locations.
6. Tests added and passing; milestone target coverage maintained (≥80% per Milestone 4 “Done When”).

---

## Dependencies & Prerequisites

- Milestone 3 completed (SiteSettings + base templates exist).
- Existing `get_site_settings` / SiteSettings access pattern available.

---

## Testing Requirements (from test-strategy-v1.1.md)

**Unit tests**

- Template tag output selection logic (GTM vs GA4 vs none).
- Ensure returned HTML contains expected key markers (`googletagmanager.com`, `gtag/js?id=…`, etc).

**Integration tests**

- Render a simple page (e.g. HomePage) with different SiteSettings configurations and assert:

  - Script presence/absence in response HTML
  - GTM precedence behavior

**References**

- Integration testing scope includes verifying “Page rendering” and cross-component behavior. **Test Strategy §4.2**.
- SEO & Analytics NFRs include “GA4/GTM injected based on SiteSettings”. **Test Strategy §4.4.3**.

---

## Estimated Complexity

- **Time:** S (small, contained surface area)
- **Risk:** Low (pure server-rendered injection; no DB migrations anticipated)
