## **[M4-011]: Email Deliverability Controls (From/Reply-To, Subject Prefix, Site Branding, Failure Telemetry)**

**Objective**: Harden lead notification email delivery by adding **per-site sender identity controls** (From name/address + Reply-To), optional subject prefixing, and failure telemetry that ties into the new observability baseline (request_id + structured logs), while preserving the “no lost leads” guarantee and keeping tests deterministic.

---

## **Context** (from SSOT / PRD)

- Milestone 4 includes email delivery as a core reliability concern (US-I03) and we now have:

  - async lead notification tasks
  - idempotency locking (CM-001)
  - observability baseline (M4-009)
  - HTML + text email templates (M4-010)

- The missing piece is operational control of deliverability:

  - consistent “From” identity avoids spam flags
  - Reply-To makes client replies go to the right place
  - subject prefixes help internal teams route messages
  - structured telemetry makes failures diagnosable

---

## **Technical Requirements**

### 1) Per-site sender configuration (Wagtail SiteSettings)

Add (or confirm existing) fields on `SiteSettings`:

- `notification_from_name` (e.g., “Straight Up Marketing”)
- `notification_from_email` (e.g., “[leads@yourdomain.co.uk](mailto:leads@yourdomain.co.uk)”)
- `notification_reply_to_email` (e.g., the client’s inbox)
- `notification_subject_prefix` (optional, e.g., “[New Lead]”)

Rules:

- If fields are blank, fallback to Django `DEFAULT_FROM_EMAIL` and/or existing platform defaults.
- Reply-To should only be set when configured; otherwise omit.

### 2) Apply these settings in lead notification sending

Update the lead email send path to:

- Use `EmailMultiAlternatives` (already used in M4-010)
- Set:

  - `from_email` using “Name <email>” formatting
  - `reply_to=[…]` when configured
  - subject prefixed by `notification_subject_prefix` when present

### 3) Telemetry alignment with observability baseline

- On send failure:

  - log one structured error event including:

    - `lead_id`, `site_id`, `email_status`, `request_id` (if available)
    - exception class + message (truncated)

  - do **not** include raw email/phone/message contents in logs

### 4) Backwards compatibility / safety

- Must not change behaviour for sites with no custom settings.
- Must not break tests in M4-010.

---

## **Design Specifications**

- Admin-only: add fields under a panel like “Notifications → Email”.
- No frontend changes.

---

## **Implementation Guidelines**

### Files to create/modify (expected)

- Modify:

  - `core/sum_core/branding/models.py` (SiteSettings fields + panels)
  - `core/sum_core/leads/tasks.py` (apply From/Reply-To/Subject prefix)
  - `tests/leads/test_notification_tasks.py` (assert headers)

- Add migration if new SiteSettings fields are added.

### Guardrails

- Don’t add provider SDKs.
- Don’t add complex templating logic for branding—use existing templates.
- Keep status transitions idempotent (respect CM-001 transaction + lock patterns).

---

## **Acceptance Criteria**

- [ ] When SiteSettings sender fields are set, outgoing lead notification emails use:

  - custom From name/email
  - custom Reply-To
  - subject prefix

- [ ] When SiteSettings fields are not set, defaults apply and email still sends
- [ ] Failure logs include correlation identifiers (lead_id, site_id, request_id where available)
- [ ] `make test` and `make lint` pass

---

## **Testing Requirements**

- Unit/integration tests using Django’s locmem email backend:

  - Verify `from_email` formatting
  - Verify Reply-To header presence/absence
  - Verify subject prefix behaviour

- Failure test:

  - mock send to raise and assert structured log call (without PII)

---

## **Estimated Complexity**

- **Time:** S–M
- **Risk:** Low–Medium (mostly settings plumbing)
