## **[M4-005]: JSON-LD Structured Data via `{% render_schema page %}`**

**Objective**: Implement `{% render_schema page %}` in the existing `seo_tags` library to emit **valid JSON-LD** in `<head>` for the required schema types (LocalBusiness, Article, FAQPage, BreadcrumbList; ServicePage schema is P1), using existing page fields + SiteSettings, with unit + integration tests that prove the output is present and structurally correct.

---

### **Context** (from SSOT - PRD Section)

**SSOT requirements**

- Template tag contract includes `{% render_schema page %}` as part of SEO tags.
- Schema mapping requirements:
  LocalBusiness (HomePage, ContactPage), Article (BlogPostPage), Service (ServicePage P1), FAQ (pages with FAQBlock P1), BreadcrumbList (all pages P1).

**PRD acceptance criteria (US-A05)**

- AC1–AC7 define required schema coverage and that schema outputs as JSON-LD in `<head>`.
- Service schema on ServicePage is explicitly P1.

---

### **Technical Requirements** (from SSOT - Tech Spec Section)

#### 1) Add `{% render_schema page %}` to `seo_tags`

- Implement a new template tag:

  - `{% render_schema page %}` → returns one or more:

    - `<script type="application/ld+json">…</script>`

- JSON must be:

  - Valid JSON (no trailing commas)
  - Correct content-type (`application/ld+json`)
  - Deterministic output (stable key order preferred; stable list order required)

**Reference:** SSOT §10.3 + §10.5.

#### 2) Schema types and when to emit them

**A) LocalBusiness (P0)**

- Emit on:

  - HomePage
  - ContactPage

- Must include (when data exists):

  - name
  - address
  - phone
  - email
  - opening hours
  - geo coordinates

- Source data:

  - Prefer `SiteSettings` business fields (do not invent a new settings model).

**B) Article (P1)**

- Emit on:

  - BlogPostPage

- Include (when present):

  - headline
  - author
  - datePublished
  - image (absolute URL)

**C) FAQPage (P1)**

- Emit on:

  - Any page containing FAQBlock in StreamField

- Include:

  - `mainEntity` list of `{ "@type": "Question", "name": ..., "acceptedAnswer": { "@type": "Answer", "text": ... } }`

**D) BreadcrumbList (P1)**

- Emit on:

  - All pages (where breadcrumb ancestors can be resolved)

- Include:

  - `itemListElement` ordered by position
  - absolute URLs for each item

**E) Service schema (P1)**

- Emit on:

  - ServicePage

- Minimal acceptable (v1):

  - `@type: "Service"`
  - name, description, url
  - provider (optional, from SiteSettings company name)

#### 3) URL + image absoluting rules

- All schema URLs must be **absolute**:

  - `url`, breadcrumb `item`, article `image.url`

- Reuse (or create) a single helper to absolute-ify URLs using the request context or known site hostname.
- If a value is missing, **omit the property** (do not output empty strings).

#### 4) Wire into `<head>`

- Ensure `base.html` calls:

  - `{% render_schema page %}` inside `<head>` alongside meta/OG.

- Follow the same guard pattern you adopted for `render_meta/render_og` (do not crash if `page` missing).

---

### **Design Specifications** (from SSOT - Design Section)

- No visual changes.
- Only inject `<script type="application/ld+json">` blocks.

---

### **Implementation Guidelines**

**Files to create/modify**

- Modify:

  - `core/sum_core/seo/templatetags/seo_tags.py` (add tag + minimal orchestration)

- Create (recommended for testability):

  - `core/sum_core/seo/schema.py` — pure functions that return Python dicts/lists for each schema type.

**Required header comments**

```python
"""
Name: schema
Path: core/sum_core/seo/schema.py
Purpose: Build JSON-LD schema dicts for LocalBusiness, Article, FAQPage, BreadcrumbList, Service.
Family: seo_tags.render_schema; SEO tests
Dependencies: Wagtail Page tree, SiteSettings, page mixins/fields
"""
```

**Agent guardrails**

- No DB queries inside templates.
- Avoid import-time side effects (keep discovery safe; don’t repeat M4-004B problems).
- Use `json.dumps(..., ensure_ascii=False)` and escape safely.

---

### **Acceptance Criteria**

- [ ] `{% render_schema page %}` outputs JSON-LD in `<head>` when `page` exists.
- [ ] HomePage + ContactPage output LocalBusiness schema with required fields when available.
- [ ] BlogPostPage outputs Article schema (headline/datePublished/image; author if present).
- [ ] Pages containing FAQBlock output FAQPage schema; pages without do not.
- [ ] All supported pages output BreadcrumbList schema with correct ordering and absolute URLs.
- [ ] ServicePage outputs Service schema (P1) if ServicePage exists in this repo version.
- [ ] No schema output occurs (and no errors) when `page` is missing from template context.

---

### **Dependencies & Prerequisites**

- M4-004 + M4-004B complete (stable SEO tags + test environment).
- SiteSettings contains business identity/contact fields (used as LocalBusiness source of truth).

---

### **Testing Requirements** (from test-strategy-v1.1.md)

Test strategy expects explicit SEO/technical checks, including schema.

**Unit tests**

- `build_localbusiness_schema()` includes required keys when inputs exist.
- `build_breadcrumb_schema()` returns ordered list with positions.
- FAQ extraction returns stable Q/A pairs.

**Integration tests**

- Render HomePage: assert JSON-LD script exists and contains `"@type": "LocalBusiness"` and `"@type": "BreadcrumbList"`.
- Render BlogPostPage: assert `"@type": "Article"`.
- Render a page with FAQBlock: assert `"@type": "FAQPage"`.

**Manual check**

- Copy output into a schema validator / Rich Results test to confirm JSON validity (no need to automate yet).

---

### **Estimated Complexity**

- **Time:** M
- **Risk:** Medium (page-type detection + FAQ extraction + absolute URLs)
