## [M1-005] Implement Theme Preset System for Site Branding

### Context (from PRD)

**Epic: Branding & Customisation → US-BR03: Theme Presets**

> As an admin, I want theme presets so that I can quickly apply proven colour schemes.

Acceptance criteria:

* **AC1** – 5 preset themes defined: `"Premium Trade"`, `"Professional Blue"`, `"Modern Green"`, `"Warm Earth"`, `"Clean Slate"`
* **AC2** – Each preset: primary, secondary, accent colours + recommended font pairing
* **AC3** – One-click preset application in SiteSettings admin (internal use only)
* **AC4** – Preset populates colour/font fields as starting point; always customised to client brand
* **AC5** – All fields remain manually editable after preset application

**Appendix C.5 – Theme Preset Definitions** – canonical colours & fonts

| Preset            | Primary | Secondary | Accent  | Heading Font     | Body Font     |
| ----------------- | ------- | --------- | ------- | ---------------- | ------------- |
| Premium Trade     | #1e3a5f | #0f172a   | #f59e0b | Montserrat       | Open Sans     |
| Professional Blue | #2563eb | #1e40af   | #f97316 | Poppins          | Inter         |
| Modern Green      | #059669 | #064e3b   | #fbbf24 | DM Sans          | Source Sans 3 |
| Warm Earth        | #92400e | #78350f   | #dc2626 | Playfair Display | Lato          |
| Clean Slate       | #374151 | #1f2937   | #6366f1 | Work Sans        | Roboto        |

Implementation Plan calls out **“Theme preset system (5 presets as internal admin tool)”** as part of Milestone 1.

We already have:

* `SiteSettings` with colour + typography fields and logos, business info, socials, etc. (per S4-US01)
* Dynamic branding tags `{% branding_css %}` and `{% branding_fonts %}` wired into `base.html`.

This task wires in the **preset system on top of that** – no new DB fields, just behaviour.

---

### Technical Requirements

1. **Preset definitions (code-level)**

   * Define a small, typed structure (e.g. `@dataclass ThemePreset`) with:

     * `key` (slug)
     * `label` (human-readable name)
     * `primary_color`
     * `secondary_color`
     * `accent_color`
     * `heading_font`
     * `body_font`
   * Create a constant mapping of exactly 5 presets, matching the PRD table **exactly** for hex values and font families.
   * These are *internal-only* constants – not exposed as a user-facing “theme switcher” on the frontend.

2. **Admin “one-click” application (SiteSettings form)**

   * Add an **extra, non-persisted field** to the SiteSettings admin form:

     * Name: `theme_preset`
     * Type: `ChoiceField`
     * Choices: empty option (`"" / "---------")` plus the 5 presets.
     * Label: “Theme preset”
     * Help text to make it clear:
       “Apply a starting theme; colours and fonts can still be edited afterwards.”
   * When the form is saved and `theme_preset` has a value:

     * Look up the preset.
     * Overwrite the SiteSettings fields:

       * `primary_color`
       * `secondary_color`
       * `accent_color`
       * `heading_font`
       * `body_font`
     * **Do not** override `background_color`, `surface_color`, etc. – those remain as-is or are set manually / by other logic.
   * After applying the preset, the `theme_preset` field should not be stored in the DB (it’s just a trigger for the save).

3. **Model / admin wiring**

   * Use `WagtailAdminModelForm` (or a subclass) as the base form for SiteSettings.
   * Wire it into the existing `SiteSettings` model via `base_form_class` on the model (string path is fine) so Wagtail uses it in the Settings UI.
   * Ensure there is **no change** to the public API of `SiteSettings.for_site(site)` and no extra DB migration.

4. **Design guardrails**

   * This must **not** introduce any alternative theming mechanism that bypasses:

     * tokens defined in `main.css`
     * branding tags `{% branding_css %}` and `{% branding_fonts %}`
   * Presets simply pre-fill the **same fields** we already use for dynamic CSS.

---

### Design Specifications (Admin UX)

Admin UI behaviour (high level):

* Location: **Wagtail → Settings → Site settings → Site settings (our model)**.
* Panel order (conceptual):

  1. Logos / brand basics (existing)
  2. **New** “Theme preset” field (single select) – near the colours/typography group.
  3. Colours
  4. Typography
  5. Business info, socials, etc.
* Workflow:

  * Admin selects a preset from the dropdown and hits “Save”.
  * The colour + font fields in the form update accordingly.
  * Admin can then tweak any of those fields and save again.

Accessibility:

* The `theme_preset` field is a standard `<select>` with associated `<label>` and help text, so it inherits Wagtail’s accessibility and keyboard behaviour.

---

### Implementation Guidelines

#### Files to create/modify

1. **New**: `core/sum_core/branding/theme_presets.py`

   * Purpose: central definition of theme presets (pure Python, no Django).
   * Contents:

     * `@dataclass ThemePreset`
     * `THEME_PRESETS: dict[str, ThemePreset]`
     * A helper `get_theme_preset_choices() -> list[tuple[str, str]]` for form choices.

   **Header comment (required):**

   ```python
   """
   Name: Theme Presets
   Path: core/sum_core/branding/theme_presets.py
   Purpose: Define internal theme presets for SiteSettings one-click application.
   Family: Used by SiteSettings admin form to prepopulate branding fields.
   Dependencies: Standard library (dataclasses, typing) only.
   """
   ```

2. **New**: `core/sum_core/branding/forms.py`

   * Purpose: custom Wagtail admin form for `SiteSettings`.
   * Implement `SiteSettingsAdminForm(WagtailAdminModelForm)` with:

     * A `theme_preset` field defined on the form class.
     * `__init__` populating `theme_preset.choices` from `get_theme_preset_choices()`.
     * Overridden `save()` to apply the preset if provided.

   **Header comment:**

   ```python
   """
   Name: Branding Admin Forms
   Path: core/sum_core/branding/forms.py
   Purpose: Provide custom Wagtail admin forms for branding-related settings.
   Family: Used by branding.models.SiteSettings via base_form_class.
   Dependencies: Django forms, Wagtail admin forms, branding.theme_presets, branding.models.
   """
   ```

3. **Modify**: `core/sum_core/branding/models.py`

   * Import `SiteSettingsAdminForm` via string path to avoid circular imports, e.g.:

     ```python
     @register_setting
     class SiteSettings(BaseSetting):
         base_form_class = "sum_core.branding.forms.SiteSettingsAdminForm"
         ...
     ```
   * No changes to the DB fields, just this form wiring.

4. **(Optional tiny tweak)**: `core/sum_core/branding/__init__.py`

   * Re-export `THEME_PRESETS` if we want them easily importable elsewhere (not strictly needed for this task).

#### Python specifics

* All new functions, classes, and module-level variables should have type hints.
* Keep imports minimal and avoid importing Django models in `theme_presets.py` to keep it pure.

---

### Acceptance Criteria

To consider M1-005 **done**, the following must hold:

1. **Preset definitions**

   * `THEME_PRESETS` contains exactly 5 keys:

     * `"premium-trade"`, `"professional-blue"`, `"modern-green"`, `"warm-earth"`, `"clean-slate"` (slugs; exact format is up to you but must be stable and testable).
   * Each preset’s `primary_color`, `secondary_color`, `accent_color`, `heading_font`, and `body_font` exactly match the PRD’s C.5 table.

2. **Admin behaviour**

   * SiteSettings edit form shows a “Theme preset” dropdown with:

     * Blank default option.
     * 5 presets with readable labels.
   * When a preset is selected and the form is saved:

     * `primary_color`, `secondary_color`, `accent_color`, `heading_font`, `body_font` on the `SiteSettings` instance match that preset.
   * On subsequent edits, all those fields can still be freely changed and saved; they are not “locked”.

3. **Integration with existing branding system**

   * `{% branding_css %}` and `{% branding_fonts %}` will reflect the new colours and fonts as soon as the SiteSettings are saved (no extra cache invalidation logic required).
   * No regressions: existing branding tests still pass.

4. **Tests**

   * New unit tests for presets and form behaviour (see below) are implemented and pass.
   * Overall test suite still passes via `make test`.

---

### Dependencies & Prerequisites

* Milestone 0 complete (already done).
* M1-001 to M1-004 completed:

  * Token CSS in `main.css`.
  * `SiteSettings` fields + `get_site_settings` tag.
  * `{% branding_css %}` and `{% branding_fonts %}` tags.
  * Base layout templates and shared shell.

This task should **not** require any migrations.

---

### Testing Requirements

#### Unit Tests (new)

Create `tests/branding/test_theme_presets.py`:

**Header:**

```python
"""
Name: Theme Presets Tests
Path: tests/branding/test_theme_presets.py
Purpose: Verify theme preset definitions and SiteSettings admin form behaviour.
Family: Branding test suite.
Dependencies: SiteSettings, SiteSettingsAdminForm, THEME_PRESETS.
"""
```

Tests to include:

1. **`test_theme_presets_match_prd_definitions`**

   * Assert `THEME_PRESETS` has 5 entries with expected slugs.
   * For each known key, assert primary/secondary/accent/heading_font/body_font match the PRD table exactly.

2. **`test_site_settings_admin_form_has_theme_preset_field`**

   * Instantiate `SiteSettingsAdminForm` for an existing `SiteSettings` instance.
   * Assert `"theme_preset"` in `form.fields`.
   * Assert there are 6 choices: 1 blank + 5 presets.

3. **`test_applying_theme_preset_updates_site_settings_fields`**

   * Get default site & SiteSettings.
   * Build `SiteSettingsAdminForm` with `data` containing:

     * Existing required fields.
     * `theme_preset`: slug for `premium-trade`.
   * Call `form.is_valid()` and `form.save()`.
   * Assert instance fields match the preset values.

4. **`test_manual_edits_after_preset_are_respected`**

   * Apply a preset via the form.
   * Then submit the form again with custom colours/fonts and no preset selected.
   * Assert the manually edited values persist (i.e. not overwritten by the preset logic when `theme_preset` is blank).

#### Manual Testing (high level)

Once implemented:

1. Run `make test` to confirm tests pass.
2. `python core/sum_core/test_project/manage.py runserver`.
3. In Wagtail admin:

   * Go to Settings → Site settings → Site settings.
   * Notice the new “Theme preset” dropdown.
   * Choose “Premium Trade” and save.
   * Confirm the colour & font fields now show the expected values from the PRD.
   * Visit the frontend homepage:

     * Check that the overall brand now looks “Premium Trade” (nav, CTA, etc. picking up new colours and fonts).
   * Change primary colour or heading font manually and save again; confirm changes appear in the front end and are not reset.

---

### Estimated Complexity

* **Time:** M (medium)
* **Risk:** Low

  * No DB changes, self-contained code.
  * Main risk is accidentally diverging from PRD colour/font specs – tests should lock this down.

---
