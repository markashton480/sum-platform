# **[M5-004]: Define and implement v1 release workflow (git tag pinning for `sum_core` + CLI packaging discipline)**

**Objective**: Create a repeatable, documented, testable workflow for shipping client sites using **git tag pinning**, including:

- how we tag and release `sum_core`
- how client boilerplate pins to a tag
- how the CLI and canonical boilerplate stay in sync
- what “done” means for a release

This is the “factory’s shipping checklist.”

---

## Context (from current state)

- Boilerplate defaults to git tag pinning with `SUM_CORE_GIT_REF` placeholder (now hardened).
- CLI can scaffold and validate projects in both monorepo and standalone modes.
- Boilerplate drift is guardrailed via `make check-cli-boilerplate`.
- Distribution method for v1 is **git tag pinning**, not a package registry (deferred). (From your M5 handover.)

---

## Technical Requirements

### 1) Release artifacts and versioning rules

Implement a clear policy (docs + lightweight tooling) for:

- `sum_core` version tags: `v0.x.y`
- how to bump:

  - patch: bugfix/docs/tests
  - minor: additive features
  - (major ignored for now)

- what must be true before tagging:

  - tests pass
  - lint passes
  - boilerplate drift check passes
  - docs updated (if required)

**Deliverable**: `docs/dev/release-workflow.md` (new)

---

### 2) Boilerplate pinning workflow

Provide a deterministic way to set `SUM_CORE_GIT_REF` in boilerplate when creating a release.

Choose one:

- A small script: `scripts/set_boilerplate_core_ref.py --ref v0.1.2`
- Or a Makefile target: `make release-set-core-ref REF=v0.1.2`

**Requirements**

- Updates `boilerplate/requirements.txt` to pin to the provided tag
- Ensures the CLI-bundled boilerplate is synced afterwards:

  - `make sync-cli-boilerplate`
  - `make check-cli-boilerplate` must pass

---

### 3) CLI release discipline

Define and document the relationship between:

- CLI versioning (if any)
- Boilerplate snapshot bundling
- `sum_core` tag pinning

**Goal**: when a client scaffolds a project, it’s obvious what it pins to and why.

**Deliverable**: update `docs/dev/cli.md` with a short “Maintainer Release Notes” section describing:

- when to run boilerplate sync
- how to update `SUM_CORE_GIT_REF`
- what checks to run before shipping

(Keep it short; link to release-workflow doc.)

---

### 4) CI alignment (minimal)

Add/ensure a CI step (or repo-local equivalent if CI isn’t ready yet) that runs:

- `make check-cli-boilerplate`

If CI pipeline work is out-of-scope, at least:

- add it to a documented “Release Checklist” and `make release-check` target that aggregates:

  - lint
  - tests
  - drift check

---

## Implementation Guidelines

**Files to create/modify (expected)**

- `docs/dev/release-workflow.md` (new)
- `Makefile` (add `release-check` and optional `release-set-core-ref`)
- `scripts/` (optional new script)
- `docs/dev/cli.md` (small update; keep maintainers section tight)

**Standards**

- Type hints for any script
- No hardcoded repo URL without a clear placeholder strategy (ORG/REPO)
- Fail loudly and safely (no silent edits)

---

## Acceptance Criteria

- There is a single, explicit workflow that a maintainer can follow to:

  1. choose the next tag
  2. update boilerplate pinning
  3. sync CLI boilerplate
  4. run “release checks”
  5. create the git tag

- `make release-check` passes locally and includes drift detection.
- Docs are crisp and do not imply we have a package registry.

---

## Testing Requirements

- If adding scripts:

  - unit test minimal parsing/rewriting behavior OR keep scripts tiny enough to be “obviously correct” and covered by `release-check` as a functional gate.

- Ensure existing test suite remains green.

---

## Estimated Complexity

- Time: **S–M**
- Risk: **Medium** (process/tooling risk > code risk)
- Suggested Model: **Claude Sonnet / GPT-5.2** (needs good judgment + precision)
