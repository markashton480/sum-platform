## NAV-009 — Navigation Stabilisation Fixes (Caching, Types, DRY, A11y, Tests)

**Type:** Tech Debt / Hardening
**Priority:** P0
**Status:** Ready
**Depends on:** NAV-005, NAV-006, NAV-007 (current working nav stack)

### Problem

A review found several issues that increase risk/maintenance cost:

- `header_nav` does **not** use caching (spec expects header/footer/sticky cached)
- Mypy `no-any-return` errors in `navigation_tags.py` reduce confidence in a hot-path file
- Unused `# type: ignore` comments create lint noise
- Duplicate phone normalisation logic violates DRY
- Minor a11y attribute gaps (aria-expanded on toggle)
- Missing integration test that renders templates end-to-end

### Goal

Bring navigation into “boring, safe, compliant” shape:

- Cache `header_nav` correctly **without caching per-request active states**
- Remove mypy/lint noise
- Centralise phone normalisation
- Add minimal integration coverage
- Confirm ARIA state attributes exist and toggle correctly

---

### Scope

#### In scope

- Fix caching strategy for `header_nav` by splitting **base data** vs **active-state overlay**.
- Fix mypy errors (`no-any-return`) in `navigation_tags.py`.
- Remove unused `# type: ignore` in branding tests.
- Extract phone normalisation to a shared util used by both UniversalLink logic and nav tags.
- Ensure mobile toggle has `aria-expanded` and JS updates it.
- Add a basic template rendering integration test.

#### Out of scope

- Nested menus (that’s NAV-010)
- Styling work / CSS refactor

---

### Implementation Tasks

#### A) Cache `header_nav` base data (spec compliance)

**Modify:** `core/sum_core/navigation/templatetags/navigation_tags.py`

- Implement:

  - `_build_header_base_data(site) -> dict[...]` (cacheable)
  - `_apply_header_active_states(base, request/current_page) -> dict[...]` (per-request)

- Cache only the base under existing key format:

  - `nav:header:{site_id}`

- Important: **do not mutate the cached object** when applying active states (deepcopy or rebuild).
- Keep footer/sticky caching unchanged.

#### B) Fix mypy “Returning Any” in nav tags

**Modify:** `core/sum_core/navigation/templatetags/navigation_tags.py`

- Add explicit casts/`bool()` and concrete return types where mypy flags `no-any-return`.
- Prefer introducing small `TypedDict`s for the menu/link dict shape so mypy can follow the structure (minimal, not a rewrite).

#### C) Remove unused type ignores

**Modify:** the listed files under `tests/branding/…`

- Remove unused `# type: ignore` comments.

#### D) DRY: centralise phone normalisation

**Create:** `core/sum_core/utils/contact.py` (or similar)

- `normalize_phone_href(phone: str) -> str` (returns `tel:` form)
- Update:

  - `core/sum_core/blocks/links.py`
  - `core/sum_core/navigation/templatetags/navigation_tags.py`
    to import and use the shared function.

#### E) ARIA state attribute on mobile toggle

**Modify:** `core/sum_core/templates/sum_core/includes/header.html` + `navigation.js`

- Ensure the mobile menu toggle button includes:

  - `aria-expanded="false"`
  - `aria-controls="<menu-id>"`

- Ensure JS toggles `aria-expanded`.

#### F) Add integration template render test

**Create:** `tests/navigation/test_template_render.py`

- Render `sum_core/base.html` (or the smallest template that includes header+footer) with a request/site context
- Assert it renders without exception and includes expected landmarks (basic smoke assertions).

#### G) Tiny doc clarification (optional but recommended)

- Add a short comment on why FooterNavigation doesn’t include TikTok override (if still intentional).

---

### Acceptance Criteria

- `header_nav` uses caching for base menu data using `nav:header:{site_id}`.
- Active states are computed per-request and do not leak across requests.
- Mypy no longer reports the 5 `no-any-return` issues in `navigation_tags.py`.
- Unused `# type: ignore` removed.
- Phone normalisation exists once and is reused.
- Mobile menu toggle has correct ARIA and JS updates state.
- Integration render test passes.

---

### Manual QA

1. Load a page twice; confirm `header_nav` is cached (instrument temporarily or check cache backend).
2. Navigate between two pages; confirm active/current highlighting changes per page (not “stuck”).
3. Toggle mobile menu; confirm `aria-expanded` updates.
