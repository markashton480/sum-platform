## Ticket: NAV-001 — Implement `UniversalLinkBlock` (shared link primitive)

**Type:** Feature / Foundation
**Priority:** P0 (blocks downstream navigation work)
**Owner:** Build team (AI agents in Cursor)
**Component:** `sum_core/blocks` + `sum_core/navigation/tests`

---

### Background / Context

The Navigation & Menu System MVP depends on a single, reusable link block that editors can use everywhere (header menu items, footer links, sticky CTAs, etc.). The spec calls this **`UniversalLinkBlock`**: it must support **page, URL, email, phone, and anchor** link types, provide consistent computed properties (like `href` / `attrs`), and enforce “exactly one link type active” through validation.

This block lives in `sum_core/blocks/links.py` and is exported via `sum_core/blocks/__init__.py`, with unit tests in `sum_core/navigation/tests/test_blocks.py`.

---

### User Story

**US-NAV01:** As a content editor, I want to create links of any type (page, URL, email, phone, anchor) without manually typing prefixes so that links are always correctly formatted.

---

### Requirements

#### Functional requirements

Implement `UniversalLinkValue` (StructValue) with these computed properties:

- `href` (normalised: `mailto:`, `tel:`, `#`, page.url, or URL)
- `text` (custom `link_text` or sensible fallback; URL uses domain)
- `is_external` (True only for `url`)
- `opens_new_tab` (defaults True for external URLs; must allow override via `open_in_new_tab`)
- `attrs` (adds `target`/`rel` when opening in new tab; adds analytics hooks for phone/email)
- `attrs_str` (string form for templates)

Implement `UniversalLinkBlock` (StructBlock) with:

- `link_type` ChoiceBlock: `page`, `url`, `email`, `phone`, `anchor`
- Conditional destination fields (required=False), but **clean() enforces** the field matching `link_type` is provided and valid
- Optional overrides: `link_text`, `open_in_new_tab`

#### Validation rules

- Exactly one destination must be present based on `link_type` (field-specific ValidationError mapping)
- Phone must contain at least one digit; `tel:` href strips formatting chars but preserves leading `+`
- Anchor must be a valid HTML-ish ID: starts with a letter, then letters/numbers/hyphen/underscore; editor may include or omit leading `#`

---

### Acceptance Criteria (Definition of Done)

1. `UniversalLinkBlock` supports 5 types: `page`, `url`, `email`, `phone`, `anchor`.
2. Validation ensures the correct matching field is present for the selected type, and errors are returned against that field.
3. `href` is normalised correctly for all 5 types (`mailto:`, `tel:`, `#`, etc.).
4. Phone numbers produce `tel:` links with formatting stripped and `+` preserved where applicable.
5. Anchor values accept input with or without `#` and render `href` as `#anchor-id`.
6. `text` uses `link_text` when provided; otherwise falls back per spec (page title, domain for URL, etc.).
7. `is_external` returns True only for `url`.
8. External URLs default to opening in a new tab with `rel="noopener noreferrer"`; `open_in_new_tab` can override behaviour.
9. `attrs` includes `data-contact-type="phone"` / `"email"` for analytics when relevant.
10. All unit tests listed below are implemented and passing, and the block is exported via `sum_core/blocks/__init__.py`.

---

### Implementation Notes (for Cursor agents)

**Canonical reference implementation** is included in the spec (regexes, property logic, clean() behaviour). Follow it closely unless it conflicts with acceptance criteria.

**Important nuance: `open_in_new_tab` override vs default**
The spec requires “defaults True for external URLs” _and_ a toggle to override.
To achieve this reliably, implement `opens_new_tab` so it can distinguish between “unset” and “explicitly False”. (One common approach is to allow `open_in_new_tab` to be nullable / tri-state, or represent “auto” internally while keeping the UI simple.) Document the chosen approach in code comments and cover it with tests.

---

### Tasks / Subtasks

#### A) Implement shared link block

**File:** `sum_core/blocks/links.py`

- [ ] Define `LINK_TYPE_CHOICES` with the 5 types
- [ ] Implement `UniversalLinkValue(StructValue)` with:

  - [ ] `href` (incl. phone cleaning + anchor cleaning)
  - [ ] `text` fallback logic (URL uses domain)
  - [ ] `is_external`, `opens_new_tab`, `attrs`, `attrs_str`

- [ ] Implement `UniversalLinkBlock(StructBlock)` fields + `clean()` validation

#### B) Export for platform-wide reuse

**File:** `sum_core/blocks/__init__.py`

- [ ] Export `UniversalLinkBlock` (and any public types if needed)

#### C) Unit tests

**File:** `sum_core/navigation/tests/test_blocks.py`
Implement (minimum) the following tests from the spec:

- [ ] `test_page_link_returns_page_url`
- [ ] `test_url_link_returns_url`
- [ ] `test_email_link_returns_mailto`
- [ ] `test_phone_link_returns_tel`
- [ ] `test_phone_strips_spaces`
- [ ] `test_phone_strips_hyphens`
- [ ] `test_phone_preserves_plus`
- [ ] `test_anchor_returns_hash_id`
- [ ] `test_anchor_strips_leading_hash`
- [ ] `test_anchor_validation_invalid_chars`
- [ ] `test_validation_page_type_requires_page`
- [ ] `test_validation_url_type_requires_url`
- [ ] `test_is_external_only_for_url_type`
- [ ] `test_attrs_external_includes_rel`
- [ ] `test_attrs_new_tab_includes_target`
- [ ] `test_text_uses_custom_when_provided`
- [ ] `test_text_falls_back_to_page_title`
- [ ] `test_text_falls_back_to_domain_for_url`

**Add these two tests to lock in AC8 (recommended):**

- [ ] `test_external_url_defaults_opens_new_tab`
- [ ] `test_external_url_can_disable_new_tab_when_overridden`

---

### QA / Verification Steps

1. Run unit tests for blocks (`sum_core/navigation/tests/test_blocks.py`).
2. In Wagtail admin (once wiring exists), verify editor UX:

   - Select each `link_type` and confirm the correct validation message appears when missing the required field.

3. Smoke-check template usage with `attrs_str` (should safely omit empty attrs).

---

### Out of Scope (for this ticket)

- Menu blocks (`MenuItemBlock`, etc.), settings models, template tags, cache layer, templates, JS/CSS. Those are later tasks in Phase 1/2.

---

### Dependencies

None (this is the first Phase 1 deliverable and unblocks everything else).

---

### References (spec)

- UniversalLinkBlock design + sample code + validation rules
- Quick reference + template usage + test list
- Implementation Plan: Task 1.1
