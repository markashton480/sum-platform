## NAV-004 — Navigation + Branding “Effective Settings” Resolver (Override/Fallback)

**Type:** Feature
**Priority:** P0
**Status:** Ready
**Depends on:** NAV-003 (HeaderNavigation/FooterNavigation), existing Branding `SiteSettings`

### Problem

We have duplicated/overlapping fields across existing Branding Site Settings and the new Navigation settings (Footer tagline + social links, header phone dependency). Editors risk updating the wrong screen and causing drift.

### Goal

Introduce a single “source of truth” interface for templates and tags: **effective settings** that merge Navigation + Branding with a clear precedence rule:

**Navigation overrides Branding when non-empty; otherwise fall back to Branding.**

---

## Scope

### In scope

1. Add resolver service that returns effective header/footer configuration.
2. Add admin help text clarifying “override” behaviour.
3. Add tests proving precedence + field-name mapping.

### Out of scope

- Template tags/templates rendering header/footer (next ticket)
- Removing/deprecating existing Branding fields
- Adding TikTok field to FooterNavigation (resolver may still expose TikTok via fallback)

---

## Implementation Tasks

### A) Create resolver service

**Create file:** `core/sum_core/navigation/services.py`

Implement:

#### `get_effective_footer_settings(site_or_request)`

Returns a dict (or dataclass) with **canonical keys**:

- `tagline`

  - value: `FooterNavigation.tagline` if set else `SiteSettings.tagline`

- `social` (dict)

  - keys: `facebook`, `instagram`, `linkedin`, `youtube`, `x`, `tiktok`
  - values:

    - for each platform except `tiktok`: `FooterNavigation.social_<platform>` if set else Branding’s `<platform>_url`
    - for `tiktok`: always fallback to Branding `tiktok_url` (Footer doesn’t have it today)

_(If Branding uses `twitter_url`, map it to `x`.)_

Optionally include “footer commonly needed” branding info for future templates:

- `company_name`, `phone_number`, `email`, `address`, etc. (only if these already exist on `SiteSettings`; don’t invent new fields).

#### `get_effective_header_settings(site_or_request)`

Returns:

- `show_phone_in_header` (from `HeaderNavigation`)
- `phone_number` (from Branding `SiteSettings.phone_number`, used when toggle true)
- Pass-through CTA config from HeaderNavigation (enabled flags + link blocks)

> The service should accept either a `request` or `site` (whichever is the pattern already used elsewhere). Prefer `Site.find_for_request(request)` if request-based. If only `site` is passed, resolve settings directly.

---

### B) Clarify admin UX (override intent)

**Modify:** `core/sum_core/navigation/models.py`

Add `help_text`:

- `FooterNavigation.tagline`: “Optional override. Leave blank to use Site Settings tagline.”
- `FooterNavigation.social_*`: “Optional override. Leave blank to use Site Settings value.”

If any of these fields are currently not `blank=True`, update them so blank is allowed, and add a migration.

---

### C) Tests

**Create file:** `tests/navigation/test_services.py`

Minimum test cases:

1. **Footer fallback**: When FooterNavigation tagline/social fields are empty, service returns Branding values.
2. **Footer override**: When FooterNavigation fields are set, they override Branding.
3. **Field mapping**: Branding `twitter_url` maps to output `social["x"]` when FooterNavigation.social_x is blank.
4. **TikTok fallback**: Output includes `social["tiktok"]` from Branding even though FooterNavigation has no TikTok field.
5. **Header phone**: If `show_phone_in_header=True`, effective header settings includes Branding `phone_number`; if false, `phone_number` is `None` or excluded (pick one and assert it consistently).

---

## Acceptance Criteria

- A single service layer returns effective header/footer settings with override→fallback precedence.
- Canonical social keys are consistent (`facebook/instagram/linkedin/youtube/x/tiktok`) regardless of underlying field names.
- Admin help text makes the override behaviour obvious.
- Tests cover precedence + mapping and pass in CI.

---

## Manual QA

1. Wagtail Admin → Settings → Footer Navigation:

   - Leave tagline + socials blank → footer should later (NAV-005) show values from Site Settings.
   - Set footer tagline/social → should override Site Settings.

2. Wagtail Admin → Settings → Header Navigation:

   - Toggle “show phone in header” on/off and ensure later rendering respects it.

_(Rendering validation will be executed in NAV-005; NAV-004 ensures the data source behaves correctly.)_
